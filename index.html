<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Times Tables</title>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',system-ui,-apple-system,sans-serif;background:#0f172a;color:#f1f5f9;min-height:100vh;line-height:1.5}
.hidden{display:none!important}
.view{min-height:100vh;display:flex;flex-direction:column}

/* TOP BAR */
.top-bar{background:#1e293b;border-bottom:1px solid #334155;padding:14px 0;position:sticky;top:0;z-index:10}
.top-bar-inner{max-width:960px;margin:0 auto;padding:0 20px;display:flex;align-items:center;justify-content:space-between}
.logo{font-size:1.4rem;font-weight:800;background:linear-gradient(135deg,#818cf8,#c084fc);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.icon-btn{background:none;border:none;color:#94a3b8;cursor:pointer;padding:8px 12px;border-radius:8px;font-size:0.9rem;font-weight:600;transition:all 0.15s;display:inline-flex;align-items:center;gap:6px}
.icon-btn:hover{background:#334155;color:#f1f5f9}

/* LAYOUT */
.container{max-width:960px;margin:0 auto;padding:0 20px;width:100%}

/* BUTTONS */
.btn{padding:10px 20px;border-radius:9px;border:none;cursor:pointer;font-size:0.95rem;font-weight:700;transition:all 0.15s;display:inline-flex;align-items:center;gap:6px}
.btn:hover{transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn-primary{background:#6366f1;color:#fff}
.btn-primary:hover{background:#4f46e5}
.btn-secondary{background:#334155;color:#f1f5f9}
.btn-secondary:hover{background:#475569}
.btn-lg{padding:13px 26px;font-size:1.05rem}
.btn-sm{padding:7px 14px;font-size:0.85rem}

/* HOME */
.home-body{flex:1;padding:28px 0 48px}
.section-label{font-size:0.78rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:#64748b;margin-bottom:14px}
.levels-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(270px,1fr));gap:14px}

.level-card{background:#1e293b;border-radius:14px;border:2px solid #334155;padding:20px;transition:all 0.2s;position:relative;overflow:hidden}
.level-card::after{content:'';position:absolute;top:0;left:0;right:0;height:3px;background:var(--lc,#6366f1)}
.level-card:hover{border-color:var(--lc,#6366f1);box-shadow:0 8px 28px rgba(0,0,0,0.35);transform:translateY(-2px)}
.lc-name{font-size:1.05rem;font-weight:800;margin-bottom:2px}
.lc-desc{font-size:0.82rem;color:#64748b;margin-bottom:12px}
.lc-badges{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:10px}
.badge{padding:3px 10px;border-radius:20px;font-size:0.78rem;font-weight:700;background:#334155;color:#94a3b8}
.badge.good{background:#1a3528;color:#4ade80}
.badge.great{background:#1a2840;color:#60a5fa}
.mastery-star{position:absolute;top:14px;right:16px;font-size:1.1rem}
.prog-wrap{margin-top:8px}
.prog-labels{display:flex;justify-content:space-between;font-size:0.72rem;color:#475569;margin-bottom:3px}
.prog-track{height:4px;background:#334155;border-radius:2px;overflow:hidden}
.prog-fill{height:100%;border-radius:2px;background:var(--lc,#6366f1);transition:width 0.6s ease}
.lc-actions{display:flex;gap:8px;margin-top:14px}
.play-btn{flex:1;padding:9px;background:var(--lc,#6366f1);color:#fff;border:none;border-radius:9px;font-size:0.9rem;font-weight:700;cursor:pointer;transition:opacity 0.15s}
.play-btn:hover{opacity:0.85}
.hist-btn{padding:9px 13px;background:#334155;border:none;border-radius:9px;color:#94a3b8;cursor:pointer;font-size:0.9rem;transition:background 0.15s}
.hist-btn:hover{background:#475569}

/* GAME */
.game-wrap{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px 20px}
.game-meta{width:100%;max-width:540px;display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;font-size:0.85rem;color:#64748b;font-weight:600}
.game-meta .lvl-tag{color:#94a3b8}
.timer-track{width:100%;max-width:540px;height:7px;background:#334155;border-radius:4px;overflow:hidden;margin-bottom:44px}
.timer-fill{height:100%;border-radius:4px;transition:background-color 0.4s}
.q-box{text-align:center;margin-bottom:36px;width:100%;max-width:540px}
.q-text{font-size:clamp(2.4rem,8vw,3.8rem);font-weight:900;letter-spacing:-0.02em;line-height:1.1}
.q-sub{font-size:0.85rem;color:#475569;margin-top:6px}
.ans-area{display:flex;flex-direction:column;align-items:center;gap:14px;width:100%;max-width:280px}
.ans-input{width:100%;padding:15px 18px;font-size:2rem;text-align:center;background:#1e293b;border:2px solid #334155;border-radius:12px;color:#f1f5f9;outline:none;font-weight:800;transition:border-color 0.2s;-moz-appearance:textfield}
.ans-input::-webkit-outer-spin-button,.ans-input::-webkit-inner-spin-button{-webkit-appearance:none}
.ans-input:focus{border-color:#6366f1}
.ans-input.ok{border-color:#22c55e;background:#0c2b1b}
.ans-input.bad{border-color:#ef4444;background:#2a0c0c}
.fb-text{font-size:1.15rem;font-weight:700;min-height:1.6em;text-align:center}
.fb-text.ok{color:#22c55e}
.fb-text.bad{color:#ef4444}
.game-btns{display:flex;flex-direction:column;gap:8px;width:100%}

/* RESULTS */
.results-wrap{flex:1;display:flex;flex-direction:column;align-items:center;padding:36px 20px 60px}
.results-inner{width:100%;max-width:600px}
.res-head{text-align:center;margin-bottom:28px}
.res-emoji{font-size:2.8rem;margin-bottom:8px}
.res-pct{font-size:4.5rem;font-weight:900;line-height:1;margin:8px 0}
.res-pct.hi{color:#22c55e}
.res-pct.mid{color:#60a5fa}
.res-pct.lo{color:#f97316}
.res-msg{font-size:1.1rem;color:#94a3b8;margin-bottom:4px}
.res-sub{font-size:0.85rem;color:#475569}
.mastery-box{background:#1c1a0a;border:1px solid #78350f;border-radius:10px;padding:14px 20px;margin:16px 0;text-align:center;color:#fbbf24;font-weight:700;font-size:0.95rem}
.progress-note{text-align:center;font-size:0.82rem;color:#475569;margin:10px 0}
.res-actions{display:flex;gap:10px;margin:20px 0 28px;flex-wrap:wrap;justify-content:center}
.qlist-label{font-size:0.78rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:#475569;margin-bottom:10px}
.q-row{display:flex;align-items:center;gap:10px;padding:9px 12px;border-radius:8px;margin-bottom:5px;font-size:0.9rem}
.q-row.ok{background:#0c2b1b40}
.q-row.bad{background:#2a0c0c40}
.q-icon{min-width:18px;font-size:0.95rem}
.q-eq{flex:1;font-weight:700}
.q-ua{color:#94a3b8;font-size:0.85rem}
.q-ua .ua-val.ok{color:#4ade80}
.q-ua .ua-val.bad{color:#f87171}
.q-tl{font-size:0.78rem;color:#475569;margin-left:auto;white-space:nowrap}

/* HISTORY */
.hist-body{flex:1;padding:28px 0 48px}
.breadcrumb{display:flex;align-items:center;gap:8px;font-size:0.85rem;color:#64748b;margin-bottom:22px}
.breadcrumb a{color:#818cf8;cursor:pointer;text-decoration:none}
.breadcrumb a:hover{text-decoration:underline}
.stats-row{display:flex;background:#1e293b;border:1px solid #334155;border-radius:12px;overflow:hidden;margin-bottom:22px;flex-wrap:wrap}
.stat-block{flex:1;min-width:100px;padding:16px 18px;border-right:1px solid #334155;text-align:center}
.stat-block:last-child{border-right:none}
.stat-lbl{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.08em;color:#475569;margin-bottom:4px}
.stat-val{font-size:1.6rem;font-weight:900}
.hist-list{display:flex;flex-direction:column;gap:8px;max-width:700px}
.hi-card{background:#1e293b;border:1px solid #334155;border-radius:10px;overflow:hidden}
.hi-header{display:flex;align-items:center;gap:12px;padding:13px 16px;cursor:pointer;transition:background 0.15s}
.hi-header:hover{background:#334155}
.hi-pill{padding:4px 11px;border-radius:20px;font-weight:800;font-size:0.85rem;min-width:55px;text-align:center}
.hi-pill.hi{background:#14532d;color:#4ade80}
.hi-pill.mid{background:#1e3a5f;color:#60a5fa}
.hi-pill.lo{background:#431407;color:#fb923c}
.hi-date{flex:1;font-size:0.82rem;color:#94a3b8}
.hi-detail{font-size:0.82rem;color:#475569}
.hi-arrow{color:#475569;font-size:0.75rem;transition:transform 0.2s}
.hi-arrow.open{transform:rotate(180deg)}
.hi-qs{border-top:1px solid #334155;padding:10px 16px;display:none}
.hi-qs.open{display:block}
.hi-q{display:flex;gap:10px;align-items:center;padding:5px 0;font-size:0.82rem;border-bottom:1px solid #1a2436}
.hi-q:last-child{border-bottom:none}
.empty-state{text-align:center;padding:48px 20px;color:#475569}
.empty-state .es-icon{font-size:2.5rem;margin-bottom:10px}

/* CONFIG MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:200;padding:20px}
.modal{background:#1e293b;border-radius:16px;border:1px solid #334155;padding:26px;width:100%;max-width:460px;max-height:90vh;overflow-y:auto}
.modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px}
.modal-head h2{font-size:1.1rem;font-weight:800}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:22px}
.field label{display:block;font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#64748b;margin-bottom:6px}
.field input{width:100%;padding:9px 12px;background:#0f172a;border:1px solid #334155;border-radius:8px;color:#f1f5f9;font-size:0.95rem;outline:none;transition:border-color 0.15s}
.field input:focus{border-color:#6366f1}
.hint{font-size:0.75rem;color:#475569;margin-top:4px}
.modal-foot{display:flex;gap:10px;justify-content:flex-end;padding-top:18px;border-top:1px solid #334155}

/* WORLD GAME */
.wg-setup{max-width:700px;margin:0 auto;padding:28px 0 48px}
.wg-step-bar{display:flex;margin-bottom:28px}
.wg-step{flex:1;padding:6px 10px;font-size:0.75rem;font-weight:700;text-align:center;background:#1e293b;border:1px solid #334155;color:#475569}
.wg-step:first-child{border-radius:8px 0 0 8px}.wg-step:last-child{border-radius:0 8px 8px 0}
.wg-step.active{background:#6366f1;border-color:#6366f1;color:#fff}
.wg-step.done{background:#14532d;border-color:#22c55e;color:#4ade80}
.wg-world-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px;margin:14px 0}
.wg-world-btn{background:#1e293b;border:2px solid #334155;border-radius:12px;padding:18px 10px;cursor:pointer;text-align:center;transition:all 0.2s;font-weight:700}
.wg-world-btn:hover{transform:translateY(-2px)}
.wg-world-btn.selected{border-color:var(--wc,#6366f1)}
.wg-world-icon{font-size:2rem;margin-bottom:6px}
.wg-world-name{font-size:0.88rem}
.wg-subj-grid{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 18px}
.wg-subj-btn,.wg-spec-btn,.wg-pill-btn{padding:6px 13px;border-radius:20px;border:1px solid #334155;background:#1e293b;color:#94a3b8;font-size:0.82rem;font-weight:700;cursor:pointer;transition:all 0.15s}
.wg-subj-btn.sel{background:#6366f1;border-color:#6366f1;color:#fff}
.wg-spec-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px;margin:10px 0}
.wg-spec-btn.sel{background:#a855f7;border-color:#a855f7;color:#fff}
.wg-pill-btn.active{background:#6366f1;border-color:#6366f1;color:#fff}
.wg-av-wrap{display:flex;gap:24px;flex-wrap:wrap;align-items:flex-start}
.wg-av-preview{display:flex;flex-direction:column;align-items:center;gap:10px;min-width:120px}
#wg-av-canvas{border-radius:12px;border:2px solid #334155;background:#1e293b;display:block}
.wg-av-opts{flex:1;min-width:260px;display:flex;flex-direction:column;gap:12px}
.wg-opt-label{font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#64748b;margin-bottom:4px}
.wg-opt-row{display:flex;flex-wrap:wrap;gap:7px}
.wg-swatch{width:24px;height:24px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all 0.15s;padding:0}
.wg-swatch.active{border-color:#fff;transform:scale(1.25)}
.wg-name-input{background:#0f172a;border:1px solid #334155;border-radius:8px;color:#f1f5f9;font-size:1rem;padding:10px 14px;width:100%;outline:none;transition:border-color 0.15s}
.wg-name-input:focus{border-color:#6366f1}
.wg-game-wrap{flex:1;display:flex;flex-direction:column;align-items:center;padding:12px 16px 24px;gap:10px}
.wg-hud{width:100%;max-width:560px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:6px}
.wg-hud-pill{background:#1e293b;border:1px solid #334155;border-radius:20px;padding:4px 12px;font-size:0.82rem;font-weight:700}
#wg-canvas{border-radius:12px;border:2px solid #334155;display:block;max-width:100%}
.wg-hint{font-size:0.78rem;color:#475569;text-align:center}
.wg-photo-wrap{display:flex;flex-direction:column;gap:10px}
.wg-photo-meter{height:26px;border-radius:13px;background:linear-gradient(90deg,#ef4444 0%,#f59e0b 28%,#22c55e 42%,#22c55e 58%,#f59e0b 72%,#ef4444 100%);position:relative}
.wg-photo-cursor{position:absolute;top:0;bottom:0;width:5px;background:#fff;border-radius:3px;transform:translateX(-50%);box-shadow:0 0 6px rgba(255,255,255,0.8)}
.wg-photo-labels{display:flex;justify-content:space-between;font-size:0.65rem;color:#475569;margin-top:2px}
.wg-ph-fb{min-height:1.6em;font-size:1rem;font-weight:800;text-align:center}
.wg-bq-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:8px 0}
.wg-bq-item{background:#1e293b;border:2px solid #334155;border-radius:10px;font-size:1.9rem;height:60px;cursor:pointer;transition:all 0.15s;display:flex;align-items:center;justify-content:center;padding:0}
.wg-bq-item:hover{border-color:#6366f1;transform:scale(1.06)}
.wg-bq-item.eaten{visibility:hidden;pointer-events:none}
.wg-bq-item.wrong{border-color:#ef4444;animation:bq-shake 0.35s ease}
@keyframes bq-shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
.wg-bq-msg{min-height:1.4em;font-size:0.85rem;font-weight:700;text-align:center}
.wg-dpad{display:flex;flex-direction:column;align-items:center;gap:4px;margin-top:8px}
.wg-dpad-row{display:flex;gap:4px;justify-content:center}
.wg-dpad-btn{width:52px;height:52px;background:#1e293b;border:2px solid #475569;border-radius:10px;color:#f1f5f9;font-size:1.3rem;cursor:pointer;user-select:none;-webkit-user-select:none;touch-action:none;transition:background 0.1s;font-weight:700}
.wg-dpad-btn:active{background:#334155;border-color:#6366f1}
.wg-dpad-enter{width:64px;font-size:0.7rem;letter-spacing:0.05em;background:#312e81;border-color:#6366f1;color:#a5b4fc}
.wg-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.75);display:flex;align-items:center;justify-content:center;z-index:150;padding:20px}
.wg-panel{background:#1e293b;border-radius:14px;border:1px solid #334155;padding:22px;width:100%;max-width:400px;max-height:85vh;overflow-y:auto}
.wg-panel-head{display:flex;align-items:center;gap:10px;margin-bottom:16px}
.wg-shop-item{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#0f172a;border-radius:8px;margin-bottom:7px;font-size:0.88rem}
.wg-item-name{flex:1;font-weight:600}
.wg-item-price{color:#f59e0b;font-weight:700;white-space:nowrap}
.wg3-unlock{display:inline-flex;align-items:center;gap:6px;background:#0a1525;border:1px solid #3b82f6;border-radius:20px;padding:5px 12px;font-size:0.8rem;font-weight:700;color:#60a5fa;cursor:pointer;transition:all 0.15s}
.wg3-unlock:hover{background:#1e3a5f}

/* SYMBOL MAKER */
.sm-wrap{flex:1;padding:24px 0 48px}
.sm-create-top{display:flex;gap:24px;flex-wrap:wrap;align-items:flex-start;margin-bottom:22px}
.sm-left{display:flex;flex-direction:column;gap:10px;min-width:180px}
.sm-right{flex:1;min-width:260px;display:flex;flex-direction:column;gap:14px}
#sm-canvas{background:#0f172a;border:2px solid #334155;border-radius:10px;cursor:crosshair;display:block;touch-action:none;width:160px;height:160px}
.sm-tools{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin-top:2px}
.sm-colors{display:flex;gap:5px;flex-wrap:wrap}
.sm-color-btn{width:22px;height:22px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:all 0.15s;padding:0}
.sm-color-btn.active{border-color:#fff;transform:scale(1.25)}
.sm-size-btns{display:flex;gap:4px}
.sm-size-btn{background:#334155;border:1px solid #475569;border-radius:5px;color:#94a3b8;cursor:pointer;padding:3px 9px;font-size:0.85rem;transition:all 0.15s}
.sm-size-btn.active,.sm-tool-btn.active{background:#6366f1;color:#fff;border-color:#6366f1}
.sm-tool-btn{background:#334155;border:1px solid #475569;border-radius:5px;color:#94a3b8;cursor:pointer;padding:3px 9px;font-size:0.85rem;transition:all 0.15s}
.sm-field{display:flex;flex-direction:column;gap:5px}
.sm-field-label{font-size:0.78rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#64748b}
.sm-input{background:#0f172a;border:1px solid #334155;border-radius:8px;color:#f1f5f9;font-size:0.95rem;padding:9px 12px;outline:none;transition:border-color 0.15s;width:100%}
.sm-input:focus{border-color:#6366f1}
.sm-mono{font-family:monospace;font-size:1rem}
.sm-textarea{resize:vertical;min-height:62px;font-family:inherit}
.sm-examples{font-size:0.75rem;color:#475569;margin-top:2px}
.sm-examples code{background:#334155;padding:1px 5px;border-radius:4px;font-size:0.75rem}
.sm-preview-box{background:#1e293b;border:1px solid #334155;border-radius:10px;padding:14px 18px;font-size:1.3rem;font-weight:700;display:flex;align-items:center;gap:10px;flex-wrap:wrap;min-height:58px}
.sm-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:4px}
.sm-lib-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:14px;margin-top:8px}
.sm-lib-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:16px;display:flex;flex-direction:column;align-items:center;gap:8px;transition:all 0.2s}
.sm-lib-card:hover{border-color:#a855f7;transform:translateY(-2px)}
.sm-lib-img{width:80px;height:80px;border-radius:8px;border:1px solid #334155;image-rendering:pixelated;background:#0f172a}
.sm-lib-name{font-weight:800;font-size:1rem}
.sm-lib-formula code{background:#334155;padding:2px 7px;border-radius:4px;font-size:0.78rem;color:#94a3b8}
.sm-lib-desc{font-size:0.75rem;color:#475569;text-align:center;line-height:1.4}
.sm-lib-actions{display:flex;gap:6px;margin-top:4px}
.sm-practice-header{display:flex;justify-content:space-between;align-items:center;font-size:0.85rem;font-weight:700;color:#64748b;margin-bottom:32px}
.sm-practice-q{display:flex;align-items:center;justify-content:center;gap:14px;margin-bottom:14px;flex-wrap:wrap}
.sm-q-num{font-size:clamp(2.2rem,7vw,3.5rem);font-weight:900;line-height:1}
.sm-q-sym{height:55px;image-rendering:pixelated;border-radius:8px;background:#0f172a;padding:2px}
.sm-practice-rule{text-align:center;font-size:0.82rem;color:#475569;margin-bottom:8px}
.sm-practice-rule code{background:#334155;padding:2px 6px;border-radius:4px}
.sm2-unlock{display:inline-flex;align-items:center;gap:6px;background:#1a1040;border:1px solid #a855f7;border-radius:20px;padding:5px 12px;font-size:0.8rem;font-weight:700;color:#c084fc;cursor:pointer;transition:all 0.15s}
.sm2-unlock:hover{background:#2d1060}
.sm-rule-section{display:flex;flex-direction:column;gap:8px}
.sm-quick-label{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;color:#64748b;margin-bottom:2px}
.sm-quick-chips{display:flex;gap:6px;flex-wrap:wrap}
.sm-chip{background:#1e293b;border:1px solid #334155;border-radius:20px;color:#94a3b8;cursor:pointer;font-size:0.8rem;padding:4px 10px;transition:all 0.15s;font-family:monospace}
.sm-chip:hover{border-color:#a855f7;color:#c084fc;background:#1a1040}
.sm-chip.active{border-color:#a855f7;color:#c084fc;background:#1a1040;font-weight:700}
.sm-builder-row{display:flex;align-items:center;gap:6px;flex-wrap:wrap;background:#0f172a;border:1px solid #334155;border-radius:8px;padding:8px 10px}
.sm-builder-token{font-family:monospace;font-size:1rem;font-weight:700;color:#f1f5f9;padding:2px 4px}
.sm-builder-select{background:#1e293b;border:1px solid #475569;border-radius:6px;color:#f1f5f9;font-size:0.9rem;padding:4px 6px;cursor:pointer;outline:none;font-family:monospace}
.sm-builder-num{background:#1e293b;border:1px solid #475569;border-radius:6px;color:#f1f5f9;font-size:0.9rem;padding:4px 6px;width:52px;text-align:center;font-family:monospace;outline:none}
.sm-builder-num:focus,.sm-builder-select:focus{border-color:#a855f7}
.sm-build-btn{background:#7c3aed;border:none;border-radius:6px;color:#fff;cursor:pointer;font-size:0.82rem;font-weight:700;padding:5px 12px;transition:background 0.15s}
.sm-build-btn:hover{background:#6d28d9}
.sm-divider{text-align:center;font-size:0.72rem;color:#475569;letter-spacing:0.05em;margin:2px 0}

/* BASKETBALL MINI-GAME */
.bk-wrap{flex:1;display:flex;flex-direction:column;align-items:center;padding:16px 16px 32px;gap:12px}
.bk-info{width:100%;max-width:720px;display:flex;justify-content:space-between;align-items:center;font-size:0.9rem;font-weight:700;color:#94a3b8}
#bk-canvas{border-radius:12px;border:2px solid #334155;display:block;max-width:100%}
.bk-controls{width:100%;max-width:720px;display:flex;flex-direction:column;align-items:center;gap:10px}
.bk-power-wrap{width:100%;display:flex;align-items:center;gap:12px}
.bk-power-label{font-size:0.85rem;font-weight:700;color:#f97316;min-width:52px}
.bk-power-track{flex:1;height:22px;background:#334155;border-radius:11px;overflow:hidden;border:1px solid #475569;position:relative}
.bk-power-fill{height:100%;background:linear-gradient(90deg,#22c55e 0%,#f59e0b 60%,#ef4444 100%);border-radius:11px}
.bk-instructions{font-size:0.95rem;color:#94a3b8;text-align:center;min-height:2.8em;display:flex;align-items:center;justify-content:center;gap:8px}
.bk-key{display:inline-block;background:#334155;border:1px solid #475569;border-radius:5px;padding:2px 7px;font-size:0.8rem;font-family:monospace;color:#f1f5f9}
.bk-unlock{display:inline-flex;align-items:center;gap:6px;background:#0c2b1b;border:1px solid #22c55e;border-radius:20px;padding:5px 12px;font-size:0.8rem;font-weight:700;color:#4ade80;cursor:pointer;transition:all 0.15s}
.bk-unlock:hover{background:#14532d}

@media(max-width:560px){
  .q-text{font-size:2.2rem}
  .res-pct{font-size:3.2rem}
  .form-grid{grid-template-columns:1fr}
  .stats-row{flex-direction:column}
  .stat-block{border-right:none;border-bottom:1px solid #334155}
  .stat-block:last-child{border-bottom:none}
}
</style>
</head>
<body>

<!-- â•â•â• HOME â•â•â• -->
<div id="view-home" class="view">
  <div class="top-bar">
    <div class="top-bar-inner">
      <span class="logo">âœ– Times Tables</span>
      <div style="display:flex;gap:6px">
        <button class="icon-btn" onclick="showHistory(-1)">ğŸ“Š All History</button>
        <button class="icon-btn" onclick="openConfig()">âš™ Settings</button>
      </div>
    </div>
  </div>
  <div class="container home-body">
    <div class="section-label">Choose a Level to Play</div>
    <div id="levels-grid" class="levels-grid"></div>
  </div>
</div>

<!-- â•â•â• GAME â•â•â• -->
<div id="view-game" class="view hidden">
  <div class="game-wrap">
    <div class="game-meta">
      <span id="g-counter">Q 1 / 20</span>
      <span id="g-level" class="lvl-tag"></span>
      <span id="g-score">âœ“ 0 / 0</span>
    </div>
    <div class="timer-track">
      <div id="timer-fill" class="timer-fill" style="width:100%;background:#22c55e"></div>
    </div>
    <div class="q-box">
      <div id="q-text" class="q-text">2 Ã— 3 = ?</div>
      <div id="q-sub" class="q-sub">Type your answer and press Enter</div>
    </div>
    <div class="ans-area">
      <input id="ans-input" type="number" class="ans-input" placeholder="?"
             min="1" max="144" autocomplete="off" inputmode="numeric">
      <div id="fb-text" class="fb-text"></div>
      <div class="game-btns">
        <button class="btn btn-primary btn-lg" onclick="submitAnswer()" id="submit-btn">Submit</button>
        <button class="btn btn-secondary btn-sm" onclick="confirmQuit()">âœ• Quit</button>
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• RESULTS â•â•â• -->
<div id="view-results" class="view hidden">
  <div class="results-wrap">
    <div id="results-inner" class="results-inner"></div>
  </div>
</div>

<!-- â•â•â• HISTORY â•â•â• -->
<div id="view-history" class="view hidden">
  <div class="top-bar">
    <div class="top-bar-inner">
      <span class="logo">ğŸ“Š History</span>
      <button class="icon-btn" onclick="showView('home')">â† Back</button>
    </div>
  </div>
  <div class="container hist-body">
    <div id="hist-content"></div>
  </div>
</div>

<!-- â•â•â• WORLD GAME â•â•â• -->
<div id="view-world" class="view hidden">
  <div class="top-bar">
    <div class="top-bar-inner">
      <span class="logo" id="wg-logo">ğŸŒ My World</span>
      <div style="display:flex;gap:6px">
        <button class="icon-btn" id="wg-back-btn" onclick="exitWorldGame()">â† Back</button>
      </div>
    </div>
  </div>
  <div id="wg-root"></div>
  <!-- building overlay -->
  <div id="wg-overlay" class="wg-overlay hidden">
    <div id="wg-panel" class="wg-panel"></div>
  </div>
</div>

<!-- â•â•â• SYMBOL MAKER â•â•â• -->
<div id="view-symbol" class="view hidden">
  <div class="top-bar">
    <div class="top-bar-inner">
      <span class="logo">ğŸ”£ Symbol Maker</span>
      <div style="display:flex;gap:6px">
        <button class="icon-btn" onclick="SM.renderLibrary()">ğŸ“š My Symbols</button>
        <button class="icon-btn" onclick="exitSymbolMaker()">â† Back</button>
      </div>
    </div>
  </div>
  <div class="container sm-wrap">
    <div id="sm-content"></div>
  </div>
</div>

<!-- â•â•â• BASKETBALL â•â•â• -->
<div id="view-basketball" class="view hidden">
  <div class="top-bar">
    <div class="top-bar-inner">
      <span class="logo">ğŸ€ Basketball Bonus</span>
      <div style="display:flex;gap:6px">
        <button class="icon-btn" id="bk-gender-btn" onclick="BK.toggleGender()">ğŸ‘¦ Boy</button>
        <button class="icon-btn" onclick="exitBasketball()">â† Back</button>
      </div>
    </div>
  </div>
  <div class="bk-wrap">
    <div class="bk-info">
      <span id="bk-counter">Throw 1 / 5</span>
      <span style="font-size:0.78rem;color:#475569">â†‘â†“ aim Â· Enter power Â· Enter throw</span>
      <span id="bk-score">ğŸ€ 0 scored</span>
    </div>
    <canvas id="bk-canvas" width="700" height="400"></canvas>
    <div class="bk-controls">
      <div id="bk-power-wrap" class="bk-power-wrap hidden">
        <span class="bk-power-label">Power</span>
        <div class="bk-power-track">
          <div id="bk-power-fill" class="bk-power-fill" style="width:0%"></div>
        </div>
      </div>
      <div id="bk-msg" class="bk-instructions">
        <span class="bk-key">â†‘</span><span class="bk-key">â†“</span> to aim, then
        <span class="bk-key">Enter</span> to set power
      </div>
    </div>
  </div>
</div>

<!-- â•â•â• CONFIG MODAL â•â•â• -->
<div id="config-overlay" class="overlay hidden">
  <div class="modal">
    <div class="modal-head">
      <h2>âš™ Settings</h2>
      <button class="icon-btn" onclick="closeConfig()">âœ•</button>
    </div>
    <div class="form-grid">
      <div class="field">
        <label>Time per Question</label>
        <input type="number" id="cfg-time" min="2" max="60" value="6">
        <div class="hint">Seconds to answer each question</div>
      </div>
      <div class="field">
        <label>Questions per Turn</label>
        <input type="number" id="cfg-qs" min="5" max="60" value="20">
        <div class="hint">Number of questions per game</div>
      </div>
      <div class="field">
        <label>History Look-back</label>
        <input type="number" id="cfg-lb" min="1" max="20" value="5">
        <div class="hint">Turns used to calculate stats</div>
      </div>
      <div class="field">
        <label>Mastery Threshold %</label>
        <input type="number" id="cfg-thr" min="50" max="100" value="90">
        <div class="hint">Average % needed to master a level</div>
      </div>
      <div class="field">
        <label>ğŸ€ Basketball Throws</label>
        <input type="number" id="cfg-bkt" min="3" max="20" value="5">
        <div class="hint">Throws per basketball game</div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-secondary" onclick="closeConfig()">Cancel</button>
      <button class="btn btn-primary" onclick="saveConfig()">Save Settings</button>
    </div>
  </div>
</div>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONSTANTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LEVELS = [
  {id:1, name:'Level 1', tables:[2,5,10],                    color:'#22c55e', desc:'Ã— 2, 5, 10'},
  {id:2, name:'Level 2', tables:[4,7],                       color:'#3b82f6', desc:'Ã— 4, 7'},
  {id:3, name:'Level 3', tables:[8,11],                      color:'#a855f7', desc:'Ã— 8, 11'},
  {id:4, name:'Level 4', tables:[9,12],                      color:'#f97316', desc:'Ã— 9, 12'},
  {id:5, name:'Level 5', tables:[3,6],                       color:'#ec4899', desc:'Ã— 3, 6'},
  {id:6, name:'Level 6', tables:[2,3,4,5,6,7,8,9,10,11,12], color:'#f59e0b', desc:'All Ã— 2â€“12'},
];

const SK = {cfg:'tt_config', hist:'tt_history'};
const DEFAULTS = {timePerQ:6, numQs:20, lookback:5, threshold:90, bkThrows:5};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let cfg  = loadCfg();
let hist = loadHist();
let gs   = null; // active game state

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STORAGE
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadCfg() {
  try { return {...DEFAULTS, ...JSON.parse(localStorage.getItem(SK.cfg) || '{}')}; }
  catch { return {...DEFAULTS}; }
}
function saveCfg()  { localStorage.setItem(SK.cfg,  JSON.stringify(cfg));  }
function loadHist() {
  try { return JSON.parse(localStorage.getItem(SK.hist) || '[]'); }
  catch { return []; }
}
function saveHist() { localStorage.setItem(SK.hist, JSON.stringify(hist)); }

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// QUESTION GENERATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateQuestions(level, count) {
  // Build every combination for this level
  const combos = [];
  for (const t of level.tables) {
    for (let m = 1; m <= 12; m++) combos.push({a:t, b:m, ans:t*m});
  }
  // Fisher-Yates shuffle
  for (let i = combos.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [combos[i], combos[j]] = [combos[j], combos[i]];
  }
  // Pick `count` questions, wrapping if needed
  const qs = [];
  for (let i = 0; i < count; i++) qs.push({...combos[i % combos.length]});
  return qs;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// STATS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function levelHist(lid)  { return hist.filter(h => h.lid === lid); }

function levelStats(lid) {
  const lh = levelHist(lid);
  if (!lh.length) return null;
  const recent = lh.slice(-cfg.lookback);
  const avg    = recent.reduce((s, h) => s + h.score, 0) / recent.length;
  return {
    total:       lh.length,
    avg:         Math.round(avg),
    last:        Math.round(lh[lh.length - 1].score),
    best:        Math.round(Math.max(...lh.map(h => h.score))),
    recentCount: recent.length,
  };
}

function isMastered(lid) {
  const s = levelStats(lid);
  if (!s) return false;
  if (s.recentCount < Math.min(cfg.lookback, 2)) return false;
  return s.avg >= cfg.threshold;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// VIEW SWITCHING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showView(name) {
  document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
  document.getElementById('view-' + name).classList.remove('hidden');
  if (name === 'home') renderHome();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HOME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHome() {
  const grid = document.getElementById('levels-grid');
  grid.innerHTML = LEVELS.map(lv => {
    const s        = levelStats(lv.id);
    const mastered = isMastered(lv.id);

    let statsHtml = '';
    if (s) {
      const avgCls  = s.avg  >= cfg.threshold ? 'great' : s.avg  >= 70 ? 'good' : '';
      const lastCls = s.last >= cfg.threshold ? 'great' : s.last >= 70 ? 'good' : '';
      const pct     = Math.min(100, s.avg);
      statsHtml = `
        <div class="lc-badges">
          <span class="badge ${lastCls}">Last: ${s.last}%</span>
          <span class="badge ${avgCls}">Avg(${s.recentCount}): ${s.avg}%</span>
          <span class="badge">Played: ${s.total}</span>
        </div>
        <div class="prog-wrap">
          <div class="prog-labels"><span>Mastery</span><span>${s.avg}% / ${cfg.threshold}%</span></div>
          <div class="prog-track">
            <div class="prog-fill" style="width:${pct}%;--lc:${lv.color}"></div>
          </div>
        </div>`;
    } else {
      statsHtml = `<div style="font-size:0.82rem;color:#475569;margin:8px 0;">Not played yet</div>`;
    }

    return `
    <div class="level-card" style="--lc:${lv.color}">
      ${mastered ? `<span class="mastery-star" title="Mastered!">â­</span>` : ''}
      <div class="lc-name">${lv.name}</div>
      <div class="lc-desc">${lv.desc}</div>
      ${statsHtml}
      <div class="lc-actions">
        <button class="play-btn" style="--lc:${lv.color}" onclick="startGame(${lv.id})">â–¶ Play</button>
        <button class="hist-btn" onclick="showHistory(${lv.id})" title="View history">ğŸ“Š</button>
      </div>
      ${lv.id === 1 ? renderBkUnlock() : lv.id === 2 ? renderSMUnlock() : lv.id === 3 ? renderWGUnlock() : ''}
    </div>`;
  }).join('');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openConfig() {
  document.getElementById('cfg-time').value    = cfg.timePerQ;
  document.getElementById('cfg-qs').value      = cfg.numQs;
  document.getElementById('cfg-lb').value      = cfg.lookback;
  document.getElementById('cfg-thr').value     = cfg.threshold;
  document.getElementById('cfg-bkt').value           = cfg.bkThrows;
  document.getElementById('config-overlay').classList.remove('hidden');
}
function closeConfig() {
  document.getElementById('config-overlay').classList.add('hidden');
}
function saveConfig() {
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, parseInt(v) || lo));
  cfg.timePerQ  = clamp(document.getElementById('cfg-time').value, 2,  60);
  cfg.numQs     = clamp(document.getElementById('cfg-qs').value,   5,  60);
  cfg.lookback  = clamp(document.getElementById('cfg-lb').value,   1,  20);
  cfg.threshold = clamp(document.getElementById('cfg-thr').value,  50, 100);
  cfg.bkThrows  = clamp(document.getElementById('cfg-bkt').value,   3,  20);
  saveCfg();
  closeConfig();
  renderHome();
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// GAME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startGame(lid) {
  const level = LEVELS.find(l => l.id === lid);
  if (!level) return;
  if (gs && gs.timerRaf) cancelAnimationFrame(gs.timerRaf);
  gs = {
    level,
    qs:       generateQuestions(level, cfg.numQs),
    idx:      0,
    ans:      [],
    timerRaf: null,
    timerEnd: 0,
    busy:     false,
    started:  new Date().toISOString(),
  };
  showView('game');
  document.getElementById('g-level').textContent = level.name + ' Â· ' + level.desc;
  showQuestion();
}

function showQuestion() {
  if (!gs) return;
  const q = gs.qs[gs.idx];

  document.getElementById('g-counter').textContent =
    `Q ${gs.idx + 1} / ${gs.qs.length}`;
  const cor = gs.ans.filter(a => a.ok).length;
  document.getElementById('g-score').textContent =
    `âœ“ ${cor} / ${gs.ans.length}`;

  document.getElementById('q-text').textContent = `${q.a} Ã— ${q.b} = ?`;
  document.getElementById('q-sub').textContent  = 'Type your answer and press Enter';

  const inp = document.getElementById('ans-input');
  inp.value = ''; inp.className = 'ans-input'; inp.disabled = false;
  setTimeout(() => inp.focus(), 50);

  const fb = document.getElementById('fb-text');
  fb.textContent = ''; fb.className = 'fb-text';
  document.getElementById('submit-btn').disabled = false;

  gs.busy = false;
  startTimer();
}

function startTimer() {
  if (gs.timerRaf) cancelAnimationFrame(gs.timerRaf);
  const dur    = cfg.timePerQ * 1000;
  gs.timerEnd  = performance.now() + dur;

  function tick() {
    if (!gs || gs.busy) return;
    const rem = Math.max(0, gs.timerEnd - performance.now());
    const pct = rem / dur * 100;
    const bar = document.getElementById('timer-fill');
    bar.style.width      = pct + '%';
    bar.style.background = pct > 60 ? '#22c55e' : pct > 25 ? '#f59e0b' : '#ef4444';
    if (rem <= 0) { timeUp(); return; }
    gs.timerRaf = requestAnimationFrame(tick);
  }
  gs.timerRaf = requestAnimationFrame(tick);
}

function timeUp() {
  if (!gs || gs.busy) return;
  gs.busy = true;
  cancelAnimationFrame(gs.timerRaf);
  const q = gs.qs[gs.idx];

  const inp = document.getElementById('ans-input');
  inp.disabled = true; inp.className = 'ans-input bad';
  const fb = document.getElementById('fb-text');
  fb.textContent = `â± Time up! Answer: ${q.ans}`;
  fb.className   = 'fb-text bad';
  document.getElementById('submit-btn').disabled = true;

  gs.ans.push({q:`${q.a} Ã— ${q.b}`, correct:q.ans, user:null, ok:false, tl:0});
  setTimeout(() => advance(), 1300);
}

function submitAnswer() {
  if (!gs || gs.busy) return;
  const inp = document.getElementById('ans-input');
  const raw = inp.value.trim();
  if (raw === '') { inp.focus(); return; }
  const val = parseInt(raw);
  if (isNaN(val)) { inp.focus(); return; }

  gs.busy = true;
  cancelAnimationFrame(gs.timerRaf);

  const q  = gs.qs[gs.idx];
  const tl = Math.max(0, (gs.timerEnd - performance.now()) / 1000);
  const ok = val === q.ans;
  gs.ans.push({q:`${q.a} Ã— ${q.b}`, correct:q.ans, user:val,
               ok, tl:Math.round(tl * 10) / 10});

  inp.disabled  = true;
  inp.className = 'ans-input ' + (ok ? 'ok' : 'bad');
  const fb = document.getElementById('fb-text');
  fb.className   = 'fb-text ' + (ok ? 'ok' : 'bad');
  fb.textContent = ok ? 'âœ“ Correct!' : `âœ— Answer: ${q.ans}`;
  document.getElementById('submit-btn').disabled = true;

  setTimeout(() => advance(), ok ? 600 : 950);
}

function advance() {
  gs.idx++;
  if (gs.idx >= gs.qs.length) endGame();
  else showQuestion();
}

function confirmQuit() {
  if (confirm('Quit this game? Your progress will not be saved.')) quitGame();
}
function quitGame() {
  if (gs) { cancelAnimationFrame(gs.timerRaf); gs = null; }
  showView('home');
}

function endGame() {
  if (!gs) return;
  cancelAnimationFrame(gs.timerRaf);
  const total   = gs.ans.length;
  const correct = gs.ans.filter(a => a.ok).length;
  const score   = Math.round(correct / total * 100);
  const entry   = {
    id: Date.now(),
    lid:   gs.level.id,
    lname: gs.level.name,
    date:  gs.started,
    score, correct, total,
    ans: gs.ans,
  };
  hist.push(entry);
  saveHist();
  const level = gs.level;
  gs = null;
  renderResults(entry, level);
  showView('results');
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// RESULTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderResults(entry, level) {
  const {score, correct, total, ans} = entry;
  const mastered = isMastered(level.id);
  const s        = levelStats(level.id);

  const emoji = score >= 90 ? 'ğŸŒŸ' : score >= 70 ? 'ğŸ˜Š' : score >= 50 ? 'ğŸ™‚' : 'ğŸ’ª';
  const msg   = score >= 90 ? 'Outstanding!' : score >= 70 ? 'Well done!'
              : score >= 50 ? 'Good effort!' : 'Keep practising!';
  const cls   = score >= 90 ? 'hi' : score >= 70 ? 'mid' : 'lo';

  const masteryHtml = mastered && s
    ? `<div class="mastery-box">
         â­ ${level.name} Mastered! Avg over last ${s.recentCount} turn${s.recentCount !== 1 ? 's' : ''}: ${s.avg}%
       </div>`
    : s && s.recentCount >= 1
    ? `<div class="progress-note">
         Mastery progress: ${s.avg}% / ${cfg.threshold}%
         (average of last ${s.recentCount} turn${s.recentCount !== 1 ? 's' : ''})
       </div>`
    : '';

  const qlist = ans.map(a => {
    const cls2  = a.ok ? 'ok' : 'bad';
    const icon  = a.ok ? 'âœ“' : 'âœ—';
    const ua    = a.user !== null ? a.user : 'â€”';
    const uaCls = a.ok ? 'ok' : 'bad';
    const tlStr = a.tl > 0 ? `${a.tl}s left` : '';
    return `
    <div class="q-row ${cls2}">
      <span class="q-icon">${icon}</span>
      <span class="q-eq">${a.q} = ${a.correct}</span>
      <span class="q-ua">You: <span class="ua-val ${uaCls}">${ua}</span></span>
      ${tlStr ? `<span class="q-tl">${tlStr}</span>` : ''}
    </div>`;
  }).join('');

  document.getElementById('results-inner').innerHTML = `
    <div class="res-head">
      <div class="res-emoji">${emoji}</div>
      <div style="font-size:0.85rem;color:#475569;font-weight:600">
        ${level.name} Â· ${new Date(entry.date).toLocaleString()}
      </div>
      <div class="res-pct ${cls}">${score}%</div>
      <div class="res-msg">${msg}</div>
      <div class="res-sub">${correct} correct out of ${total} questions</div>
    </div>
    ${masteryHtml}
    <div class="res-actions">
      <button class="btn btn-primary btn-lg" onclick="startGame(${level.id})">â–¶ Play Again</button>
      <button class="btn btn-secondary btn-lg" onclick="showView('home')">ğŸ  Home</button>
      <button class="btn btn-secondary btn-sm" onclick="showHistory(${level.id})">ğŸ“Š History</button>
    </div>
    <div class="qlist-label">Question Breakdown</div>
    ${qlist}
  `;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// HISTORY
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showHistory(lid) {
  const isAll  = lid === -1;
  const level  = isAll ? null : LEVELS.find(l => l.id === lid);
  const entries = isAll ? [...hist].reverse() : levelHist(lid).reverse();
  const s      = isAll ? null : levelStats(lid);

  let statsHtml = '';
  if (s) {
    statsHtml = `
    <div class="stats-row">
      <div class="stat-block">
        <div class="stat-lbl">Played</div>
        <div class="stat-val">${s.total}</div>
      </div>
      <div class="stat-block">
        <div class="stat-lbl">Avg (last ${s.recentCount})</div>
        <div class="stat-val" style="color:${s.avg >= cfg.threshold ? '#4ade80' : '#94a3b8'}">${s.avg}%</div>
      </div>
      <div class="stat-block">
        <div class="stat-lbl">Best</div>
        <div class="stat-val" style="color:#60a5fa">${s.best}%</div>
      </div>
      <div class="stat-block">
        <div class="stat-lbl">Mastery</div>
        <div class="stat-val">${isMastered(lid) ? 'â­' : `${s.avg}/${cfg.threshold}%`}</div>
      </div>
    </div>`;
  }

  let listHtml = '';
  if (!entries.length) {
    listHtml = `<div class="empty-state"><div class="es-icon">ğŸ“­</div><div>No games played yet</div></div>`;
  } else {
    listHtml = entries.map((e, i) => {
      const sc    = e.score >= 90 ? 'hi' : e.score >= 60 ? 'mid' : 'lo';
      const d     = new Date(e.date);
      const dStr  = d.toLocaleDateString('en-GB', {day:'2-digit', month:'short', year:'numeric'});
      const tStr  = d.toLocaleTimeString('en-GB', {hour:'2-digit', minute:'2-digit'});
      const label = isAll ? `${e.lname} Â· ${dStr} at ${tStr}` : `${dStr} at ${tStr}`;

      const qs = e.ans.map(a => `
        <div class="hi-q">
          <span style="color:${a.ok ? '#4ade80' : '#f87171'};font-weight:700;min-width:16px">
            ${a.ok ? 'âœ“' : 'âœ—'}
          </span>
          <span style="flex:1">${a.q} = ${a.correct}</span>
          <span style="color:#475569">You: ${a.user !== null ? a.user : 'â€”'}</span>
        </div>`).join('');

      return `
      <div class="hi-card">
        <div class="hi-header" onclick="toggleHi(${i})">
          <span class="hi-pill ${sc}">${e.score}%</span>
          <span class="hi-date">${label}</span>
          <span class="hi-detail">${e.correct}/${e.total}</span>
          <span class="hi-arrow" id="hi-arr-${i}">â–¾</span>
        </div>
        <div class="hi-qs" id="hi-qs-${i}">${qs}</div>
      </div>`;
    }).join('');
  }

  const title = isAll ? 'All History' : `${level.name} History`;
  const sub   = isAll ? '' : `Â· ${level.desc}`;

  document.getElementById('hist-content').innerHTML = `
    <div class="breadcrumb">
      <a onclick="showView('home')">ğŸ  Home</a>
      <span>â€º</span>
      <span>${title}</span>
    </div>
    <h2 style="margin-bottom:20px;font-size:1.2rem">
      ${title}
      <span style="font-size:0.85rem;color:#475569;font-weight:400">${sub}</span>
    </h2>
    ${statsHtml}
    <div class="section-label">
      Game History (${entries.length} game${entries.length !== 1 ? 's' : ''})
    </div>
    <div class="hist-list">${listHtml}</div>
  `;
  showView('history');
}

function toggleHi(i) {
  const qs  = document.getElementById('hi-qs-' + i);
  const arr = document.getElementById('hi-arr-' + i);
  const open = qs.classList.toggle('open');
  arr.classList.toggle('open', open);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// KEYBOARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', e => {
  const active = document.querySelector('.view:not(.hidden)');
  if (active && active.id === 'view-basketball') {
    BK.handleKey(e.key);
    if (['ArrowUp','ArrowDown','Enter',' '].includes(e.key)) e.preventDefault();
    return;
  }
  if (active && active.id === 'view-symbol') {
    if (e.key === 'Enter') SM.handleEnter();
    return;
  }
  if (active && active.id === 'view-world') {
    WG.handleKey(e.key, true);
    if (['ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '].includes(e.key)) e.preventDefault();
    return;
  }
  if (e.key === 'Enter') {
    if (active && active.id === 'view-game') submitAnswer();
  }
  if (e.key === 'Escape') closeConfig();
});

document.addEventListener('keyup', e => {
  if (document.querySelector('.view:not(.hidden)')?.id === 'view-world') WG.handleKey(e.key, false);
});

document.getElementById('config-overlay').addEventListener('click', e => {
  if (e.target.id === 'config-overlay') closeConfig();
});

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// WORLD GAME MINI-GAME (Level 3 unlock)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isWorldUnlocked() {
  const lh = levelHist(3);
  if (lh.length < 3) return false;
  return lh.slice(-3).every(h => h.score === 100);
}
function renderWGUnlock() {
  if (isWorldUnlocked()) {
    return `<div style="margin-top:10px">
      <button class="wg3-unlock" onclick="startWorldGame()">ğŸŒ My World â€” Play!</button>
    </div>`;
  }
  const lh = levelHist(3);
  let s = 0;
  for (let i = lh.length-1; i>=0; i--) { if (lh[i].score===100) s++; else break; }
  return `<div style="margin-top:8px;font-size:0.78rem;color:#475569">
    ğŸŒ Get 100% three times in a row to unlock My World ${s>0?`(${s}/3 âœ“)`:''}
  </div>`;
}
function startWorldGame() { showView('world'); WG.init(); }
function exitWorldGame()  { WG.stop(); showView('home'); }

// â”€â”€ World definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WD = {
  animal:  { label:'ğŸ¾ Animal',   col:'#22c55e', bg:'#d1fae5', road:'#a3e635', cur:'Paws ğŸ¾',
    specs:['Animal Trainer','Wildlife Vet','Zoo Keeper','Photographer','Marine Biologist'],
    locs:[{id:'home',    n:'Your Den',       e:'ğŸ ',c:'#86efac'},
          {id:'park',    n:'Nature Park',    e:'ğŸŒ³',c:'#4ade80',care:true},
          {id:'photo',   n:'Wildlife Studio',e:'ğŸ“·',c:'#0f2d47',photo:true,sub:'ğŸ¦‹'},
          {id:'s1',      n:'Pet Shop',       e:'ğŸ•',c:'#fde68a',items:[['Dog Collar ğŸ¦®',10],['Fish Tank ğŸŸ',20],['Bird Cage ğŸ¦',15],['Hamster Wheel ğŸ¹',12]]},
          {id:'s2',      n:'Vet Clinic',     e:'ğŸ¥',c:'#bfdbfe',items:[['Medicine ğŸ’Š',8],['Bandage ğŸ©¹',5],['Health Kit âœ…',15]]},
          {id:'banquet', n:'Animal Feast',   e:'ğŸ½',c:'#fef9c3',banquet:true},
          {id:'view',    n:'Safari Zone',    e:'ğŸ¦',c:'#fcd34d',safari:true},
          {id:'s3',      n:'Farm Stand',     e:'ğŸŒ¾',c:'#d9f99d',items:[['Carrot ğŸ¥•',3],['Apple ğŸ',4],['Hay Bale ğŸŒ¾',6]]}]},
  food:    { label:'ğŸ• Food',      col:'#f97316', bg:'#fef3c7', road:'#d97706', cur:'Coins ğŸª™',
    specs:['Head Chef','Pastry Baker','Food Critic','Nutritionist','Street Vendor'],
    locs:[{id:'home',    n:'Your Kitchen',   e:'ğŸ ',c:'#fef9c3'},
          {id:'park',    n:'Food Festival',  e:'ğŸª',c:'#fde68a',interview:true},
          {id:'photo',   n:'Food Photo Studio',e:'ğŸ“·',c:'#0f2d47',photo:true,sub:'ğŸ•'},
          {id:'s1',      n:'Bakery',         e:'ğŸ¥',c:'#fcd34d',items:[['Croissant ğŸ¥',5],['Cake Tin ğŸ‚',15],['Rolling Pin ğŸ¥£',10]]},
          {id:'s2',      n:'Market',         e:'ğŸ›’',c:'#bbf7d0',items:[['Spice Set ğŸŒ¶',12],['Olive Oil ğŸ«™',9],['Herb Pot ğŸŒ¿',7]]},
          {id:'banquet', n:'Grand Banquet',  e:'ğŸ½',c:'#fef9c3',banquet:true},
          {id:'view',    n:'Restaurant',     e:'ğŸ½',c:'#e0f2fe',cook:true},
          {id:'s3',      n:'Ice Cream Shop', e:'ğŸ¦',c:'#fce7f3',items:[['Ice Cream Maker ğŸ¦',20],['Sprinkles âœ¨',4],['Waffle Cones ğŸ§‡',6]]}]},
  fashion: { label:'ğŸ‘— Fashion',   col:'#ec4899', bg:'#fce7f3', road:'#db2777', cur:'Stars â­',
    specs:['Fashion Designer','Personal Stylist','Trend Forecaster','Buyer'],
    locs:[{id:'home',    n:'Your Studio',    e:'ğŸ ',c:'#fce7f3'},
          {id:'park',    n:'Fashion Week',   e:'ğŸ‘ ',c:'#fbcfe8',runway:true},
          {id:'photo',   n:'Photo Studio',   e:'ğŸ“·',c:'#0f2d47',photo:true,sub:'ğŸ‘—'},
          {id:'s2',      n:'Fabric Shop',    e:'ğŸ§µ',c:'#ddd6fe',items:[['Silk Roll ğŸ§µ',18],['Ribbon ğŸ€',7],['Thread Set ğŸª¡',9]]},
          {id:'banquet', n:'Chic CafÃ©',      e:'ğŸ½',c:'#fef9c3',banquet:true},
          {id:'s3',      n:'Shoe Store',     e:'ğŸ‘ ',c:'#fef9c3',items:[['Trainers ğŸ‘Ÿ',15],['Boots ğŸ¥¾',18],['Heels ğŸ‘ ',20]]}]},
  art:     { label:'ğŸ¨ Art',       col:'#a855f7', bg:'#f3e8ff', road:'#9333ea', cur:'Gems ğŸ’',
    specs:['Painter','Sculptor','Illustrator','Digital Artist','Art Curator'],
    locs:[{id:'home',    n:'Your Studio',    e:'ğŸ ',c:'#ede9fe'},
          {id:'park',    n:'Sculpture Park', e:'ğŸŒ³',c:'#a5f3fc',sculpt:true},
          {id:'photo',   n:'Art Studio Shoot',e:'ğŸ“·',c:'#0f2d47',photo:true,sub:'ğŸ¨'},
          {id:'s1',      n:'Art Shop',       e:'ğŸ¨',c:'#fde68a',items:[['Paint Set ğŸ¨',15],['Canvas ğŸ–¼',10],['Sketchbook ğŸ““',8]]},
          {id:'s2',      n:'Gallery',        e:'ğŸ–¼',c:'#e0e7ff',items:[['Framed Print ğŸ–¼',20],['Sculpture ğŸ—¿',35],['Art Poster ğŸ“„',8]]},
          {id:'banquet', n:'Art CafÃ©',       e:'ğŸ½',c:'#fef9c3',banquet:true},
          {id:'view',    n:'Museum',         e:'ğŸ›',c:'#f3e8ff',museum:true},
          {id:'s3',      n:'Craft Market',   e:'ğŸ›',c:'#dcfce7',items:[['Clay Kit ğŸ«™',12],['Mosaic Set ğŸ”²',15],['Washi Tape ğŸ“Œ',5]]}]},
  sport:   { label:'âš½ Sport',     col:'#3b82f6', bg:'#dbeafe', road:'#2563eb', cur:'Points ğŸ…',
    specs:['Pro Athlete','Coach','Sports Journalist','Referee','Fitness Trainer'],
    locs:[{id:'home',    n:'Locker Room',    e:'ğŸ ',c:'#dbeafe'},
          {id:'park',    n:'Training Ground',e:'âš½',c:'#bbf7d0',training:true},
          {id:'photo',   n:'Sports Photography',e:'ğŸ“·',c:'#0f2d47',photo:true,sub:'âš½'},
          {id:'s1',      n:'Sports Shop',    e:'ğŸ…',c:'#fef3c7',items:[['Football âš½',10],['Racket ğŸ¾',18],['Water Bottle ğŸ’§',6]]},
          {id:'s2',      n:'Gym',            e:'ğŸ’ª',c:'#bfdbfe',gym:true},
          {id:'banquet', n:'Sports Canteen', e:'ğŸ½',c:'#fef9c3',banquet:true},
          {id:'view',    n:'Stadium',        e:'ğŸŸ',c:'#fed7aa',goals:true},
          {id:'s3',      n:'Pool',           e:'ğŸŠ',c:'#a5f3fc',whistle:true}]},
  subject: { label:'ğŸ“š Subject',   col:'#f59e0b', bg:'#fefce8', road:'#ca8a04', cur:'Marks ğŸ“',
    specs:['Teacher','Researcher','Student','Tutor','Explorer'],
    locs:[{id:'home',    n:'Your Study',     e:'ğŸ ',c:'#fef9c3'},
          {id:'park',    n:'Study Garden',   e:'ğŸŒ³',c:'#dcfce7',marking:true},
          {id:'photo',   n:'Science Lab Photos',e:'ğŸ“·',c:'#0f2d47',photo:true,sub:'ğŸ”¬'},
          {id:'s1',      n:'Bookshop',       e:'ğŸ“š',c:'#e0e7ff',items:[['Notebook ğŸ““',6],['Textbook ğŸ“–',15],['Dictionary ğŸ“š',20]]},
          {id:'s2',      n:'Science Lab',    e:'ğŸ”¬',c:'#bfdbfe',lab:true},
          {id:'banquet', n:'School Canteen', e:'ğŸ½',c:'#fef9c3',banquet:true},
          {id:'view',    n:'Library',        e:'ğŸ“–',c:'#f3e8ff',library:true},
          {id:'s3',      n:'School',         e:'ğŸ«',c:'#fce7f3',quiz:true}]},
};

// â”€â”€ Building layout (canvas 560Ã—340) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const WG_BLDGS = [
  {id:'home',    x:15,  y:20,  w:90, h:65},
  {id:'park',    x:155, y:20,  w:90, h:65},
  {id:'photo',   x:295, y:20,  w:90, h:65},
  {id:'s1',      x:435, y:20,  w:90, h:65},
  {id:'s2',      x:15,  y:210, w:90, h:65},
  {id:'banquet', x:155, y:210, w:90, h:65},
  {id:'view',    x:295, y:210, w:90, h:65},
  {id:'s3',      x:435, y:210, w:90, h:65},
];

const WG = {
  // Setup
  step: 1,
  worldType: null,
  subjectType: 'All Subjects',
  worldDesc: '',
  avatarName: 'Me',
  specialty: null,

  // Avatar
  av: { skin:'#f5c5a3', hair:0, hairC:'#2d1b00', eye:0, eyeC:'#4a3728', outC:'#3b82f6', out:0, acc:0 },

  // Game state
  px: 280, py: 300,
  currency: 50,
  inventory: [],
  denLayout: Array(9).fill(null),
  _denSelectedItem: null,
  keys: {},
  raf: null,
  lastTs: 0,
  nearB: null,

  // â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  init() {
    if (this.load()) { this.startWorld(); return; }
    this.step = 1;
    this.renderSetup();
  },
  stop() { if (this.raf) { cancelAnimationFrame(this.raf); this.raf = null; } },

  toggleDpad() {
    const d = document.getElementById('wg-dpad');
    if (d) d.classList.toggle('hidden');
  },

  dkey(key, down) {
    this.keys[key] = !!down;
    if (down && (key === ' ' || key === 'Enter')) {
      if (!document.getElementById('wg-overlay').classList.contains('hidden')) return;
      if (this.nearB) this.enterBuilding(this.nearB);
    }
  },

  handleKey(key, down) {
    this.keys[key] = down;
    if (down && (key === ' ' || key === 'Enter')) {
      if (!document.getElementById('wg-overlay').classList.contains('hidden')) return;
      if (this.nearB) this.enterBuilding(this.nearB);
    }
    if (down && key === 'Escape') this.leaveBuilding();
  },

  // â”€â”€ SETUP WIZARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  renderSetup() {
    document.getElementById('wg-root').innerHTML =
      `<div class="container wg-setup"><div id="wg-step-content"></div></div>`;
    this._renderStep();
  },

  _stepBar() {
    const labels = ['World','Avatar','Name & Go!'];
    return `<div class="wg-step-bar">${labels.map((l,i)=>
      `<div class="wg-step ${i+1===this.step?'active':i+1<this.step?'done':''}">${l}</div>`
    ).join('')}</div>`;
  },

  _renderStep() {
    const el = document.getElementById('wg-step-content');
    if (!el) return;
    if (this.step===1) el.innerHTML = this._stepWorldHTML();
    else if (this.step===2) { el.innerHTML = this._stepAvatarHTML(); this._initAvCanvas(); }
    else el.innerHTML = this._stepNameHTML();
  },

  _stepWorldHTML() {
    const worlds = Object.entries(WD).map(([k,v]) =>
      `<button class="wg-world-btn${this.worldType===k?' selected':''}" style="--wc:${v.col}"
         onclick="WG.pickWorld('${k}')" >
         <div class="wg-world-icon">${v.label.split(' ')[0]}</div>
         <div class="wg-world-name">${v.label.split(' ').slice(1).join(' ')}</div>
       </button>`).join('');

    const subjRow = this.worldType === 'subject' ? `
      <div class="sm-field-label" style="margin-top:16px">Choose your subject:</div>
      <div class="wg-subj-grid">${
        ['Maths','Science','English','History','Geography','PE','Music','Art','Computing','All Subjects']
        .map(s=>`<button class="wg-subj-btn${this.subjectType===s?' sel':''}" onclick="WG.pickSubj('${s}')">${s}</button>`)
        .join('')
      }</div>` : '';

    const descRow = this.worldType ? `
      <div class="sm-field-label" style="margin-top:16px">Describe your world:</div>
      <textarea class="sm-input sm-textarea" style="margin-top:6px" rows="2"
        placeholder="What does your world look, feel and smell like?"
        oninput="WG.worldDesc=this.value">${this.worldDesc}</textarea>
      <div class="sm-field-label" style="margin-top:18px">Your specialty:</div>
      <div class="wg-spec-grid">${WD[this.worldType].specs.map(s=>
        `<button class="wg-spec-btn${this.specialty===s?' sel':''}" onclick="WG.pickSpec('${s}')">${s}</button>`
      ).join('')}</div>` : '';

    return `${this._stepBar()}
      <h2 style="font-size:1.1rem;font-weight:800;margin-bottom:14px">Step 1 â€” Choose Your World</h2>
      <div class="wg-world-grid">${worlds}</div>
      ${subjRow}${descRow}
      <div style="margin-top:22px">
        <button class="btn btn-primary btn-lg" onclick="WG.nextStep()"
          ${!this.worldType||!this.specialty?'disabled style="opacity:0.5"':''}>
          Next â€” Design Avatar â†’
        </button>
      </div>`;
  },

  _stepAvatarHTML() {
    const SKINS  = ['#f5c5a3','#e8a87c','#c68642','#8d5524','#4a2c2a'];
    const HAIRC  = ['#2d1b00','#8B4513','#f5c518','#e34234','#6a0dad','#708090'];
    const EYEC   = ['#4a3728','#5b8dd9','#4a7c59','#808080','#3d1f00'];
    const OUTC   = ['#3b82f6','#ef4444','#22c55e','#a855f7','#f97316','#ec4899'];
    const HAIRS  = ['Short','Long','Curly','Wavy','Bun','Braids'];
    const ACCS   = ['None','Hat','Glasses','Bag','Crown','Bow'];

    const sw = (arr, key, sub) => arr.map((c,i)=>
      `<button class="wg-swatch${(sub?this.av[sub]:this.av[key])===c||(!sub&&this.av[key]===i)?' active':''}"
         style="background:${c}" onclick="WG.setAv('${key}',${sub?`'${c}'`:i},${sub?`'${sub}'`:'null'})"></button>`
    ).join('');
    const pills = (arr, key) => arr.map((l,i)=>
      `<button class="wg-pill-btn${this.av[key]===i?' active':''}" onclick="WG.setAv('${key}',${i},null)">${l}</button>`
    ).join('');

    return `${this._stepBar()}
      <h2 style="font-size:1.1rem;font-weight:800;margin-bottom:18px">Step 2 â€” Design Your Avatar</h2>
      <div class="wg-av-wrap">
        <div class="wg-av-preview">
          <canvas id="wg-av-canvas" width="100" height="150"></canvas>
          <div style="font-size:0.78rem;color:#475569">Live preview</div>
        </div>
        <div class="wg-av-opts">
          <div><div class="wg-opt-label">Skin Tone</div><div class="wg-opt-row">${sw(SKINS,'skin','skin')}</div></div>
          <div><div class="wg-opt-label">Hair Style</div><div class="wg-opt-row">${pills(HAIRS,'hair')}</div></div>
          <div><div class="wg-opt-label">Hair Colour</div><div class="wg-opt-row">${sw(HAIRC,'hair','hairC')}</div></div>
          <div><div class="wg-opt-label">Eye Colour</div><div class="wg-opt-row">${sw(EYEC,'eye','eyeC')}</div></div>
          <div><div class="wg-opt-label">Outfit Colour</div><div class="wg-opt-row">${sw(OUTC,'out','outC')}</div></div>
          <div><div class="wg-opt-label">Accessory</div><div class="wg-opt-row">${pills(ACCS,'acc')}</div></div>
        </div>
      </div>
      <div style="display:flex;gap:10px;margin-top:22px;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="WG.step=1;WG._renderStep()">â† Back</button>
        <button class="btn btn-primary btn-lg" onclick="WG.nextStep()">Next â€” Name & Play â†’</button>
      </div>`;
  },

  _stepNameHTML() {
    return `${this._stepBar()}
      <h2 style="font-size:1.1rem;font-weight:800;margin-bottom:18px">Step 3 â€” Name Your Avatar & Start!</h2>
      <div style="margin-bottom:16px">
        <div class="sm-field-label" style="margin-bottom:6px">Your Avatar's Name</div>
        <input class="wg-name-input" type="text" maxlength="20" value="${this.avatarName}"
          placeholder="What's your character called?" oninput="WG.avatarName=this.value">
      </div>
      <div style="background:#1e293b;border-radius:12px;padding:16px;margin-bottom:22px;font-size:0.9rem">
        <div style="color:#64748b;font-size:0.78rem;font-weight:700;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px">Your World Summary</div>
        <div>ğŸŒ <strong>${this.worldType ? WD[this.worldType].label : ''}</strong>
          ${this.worldType==='subject'?` â€” ${this.subjectType}`:''}</div>
        <div style="color:#64748b;font-size:0.85rem;margin-top:4px">${this.worldDesc||'No description yet'}</div>
        <div style="margin-top:6px">â­ Specialty: <strong>${this.specialty||''}</strong></div>
      </div>
      <div style="display:flex;gap:10px;flex-wrap:wrap">
        <button class="btn btn-secondary" onclick="WG.step=2;WG._renderStep()">â† Back</button>
        <button class="btn btn-primary btn-lg" onclick="WG.beginWorld()">ğŸŒ Enter My World!</button>
      </div>`;
  },

  pickWorld(k)  { this.worldType=k; this.specialty=null; this._renderStep(); },
  pickSubj(s)   { this.subjectType=s; this._renderStep(); },
  pickSpec(s)   { this.specialty=s; this._renderStep(); },
  nextStep()    { this.step++; this._renderStep(); },

  setAv(key, val, sub) {
    if (sub) this.av[sub]=val; else this.av[key]=val;
    this._drawAvPreview();
    // Refresh swatches/pills
    document.querySelectorAll('.wg-swatch,.wg-pill-btn').forEach(b => {
      const [,k,,s] = (b.getAttribute('onclick')||'').match(/setAv\('(\w+)',([^,]+),([^)]+)\)/)||[];
    });
    this._renderStep();
  },

  _initAvCanvas() {
    const c = document.getElementById('wg-av-canvas');
    if (c) this._drawAvPreview();
  },

  _drawAvPreview() {
    const c = document.getElementById('wg-av-canvas');
    if (!c) return;
    const ctx = c.getContext('2d');
    ctx.clearRect(0,0,100,150);
    ctx.fillStyle='#1e293b'; ctx.fillRect(0,0,100,150);
    this._drawAvatar(ctx, 50, 135, 1.6);
  },

  // â”€â”€ Avatar drawing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _drawAvatar(ctx, cx, cy, sc=1) {
    const av = this.av;
    const W = 20*sc, H = 34*sc;
    // Shadow
    ctx.fillStyle='rgba(0,0,0,0.2)';
    ctx.beginPath(); ctx.ellipse(cx,cy,10*sc,3*sc,0,0,Math.PI*2); ctx.fill();
    // Shoes
    ctx.fillStyle='#1e293b';
    ctx.fillRect(cx-W/2, cy-H*0.12, W/2-1, H*0.12);
    ctx.fillRect(cx+2, cy-H*0.12, W/2-1, H*0.12);
    // Legs
    ctx.fillStyle='#334155';
    ctx.fillRect(cx-W/2+1, cy-H*0.4, W/2-2, H*0.28);
    ctx.fillRect(cx+2, cy-H*0.4, W/2-2, H*0.28);
    // Body
    ctx.fillStyle=av.outC;
    ctx.fillRect(cx-W/2, cy-H*0.7, W, H*0.3);
    // Arms
    ctx.fillRect(cx-W/2-3*sc, cy-H*0.68, 4*sc, H*0.22);
    ctx.fillRect(cx+W/2-1*sc, cy-H*0.68, 4*sc, H*0.22);
    // Neck
    ctx.fillStyle=av.skin;
    ctx.fillRect(cx-3*sc, cy-H*0.74, 6*sc, 5*sc);
    // Head
    ctx.beginPath(); ctx.arc(cx, cy-H*0.86, 11*sc, 0, Math.PI*2); ctx.fillStyle=av.skin; ctx.fill();
    // Hair
    ctx.fillStyle=av.hairC;
    const hy = cy-H*0.86, hr=11*sc;
    switch(av.hair) {
      case 0: ctx.beginPath(); ctx.arc(cx,hy,hr,Math.PI,0); ctx.fill(); break; // Short
      case 1: // Long
        ctx.beginPath(); ctx.arc(cx,hy,hr,Math.PI*1.1,0); ctx.fill();
        ctx.fillRect(cx-hr, hy, hr*0.6, H*0.3);
        ctx.fillRect(cx+hr*0.4, hy, hr*0.6, H*0.3); break;
      case 2: // Curly
        for(let i=0;i<6;i++){
          const a=(Math.PI/3)*i;
          ctx.beginPath(); ctx.arc(cx+Math.cos(a)*hr*0.7,hy-Math.sin(Math.abs(a))*hr*0.5,4*sc,0,Math.PI*2); ctx.fill();
        } break;
      case 3: // Wavy
        ctx.beginPath(); ctx.arc(cx,hy,hr,Math.PI*1.1,0); ctx.fill();
        for(let s2=0;s2<2;s2++){
          const sx=s2===0?cx-hr:cx+hr*0.4;
          ctx.beginPath(); ctx.moveTo(sx,hy);
          ctx.quadraticCurveTo(sx-(s2===0?4:-4)*sc,hy+H*0.1,sx,hy+H*0.2);
          ctx.quadraticCurveTo(sx-(s2===0?4:-4)*sc,hy+H*0.3,sx,hy+H*0.35);
          ctx.lineWidth=4*sc; ctx.strokeStyle=av.hairC; ctx.stroke();
        } break;
      case 4: // Bun
        ctx.beginPath(); ctx.arc(cx,hy,hr,Math.PI,0); ctx.fill();
        ctx.beginPath(); ctx.arc(cx,hy-hr*1.2,5*sc,0,Math.PI*2); ctx.fill(); break;
      case 5: // Braids
        ctx.beginPath(); ctx.arc(cx,hy,hr,Math.PI,0); ctx.fill();
        for(let t=0;t<H*0.35;t+=5*sc){
          ctx.fillRect(cx-hr,hy+t,3*sc,3*sc);
          ctx.fillRect(cx+hr-3*sc,hy+t,3*sc,3*sc);
        } break;
    }
    // Eyes
    ctx.fillStyle=av.eyeC;
    ctx.beginPath(); ctx.arc(cx-4*sc,hy-1*sc,2*sc,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx+4*sc,hy-1*sc,2*sc,0,Math.PI*2); ctx.fill();
    // Mouth
    ctx.strokeStyle='rgba(0,0,0,0.3)'; ctx.lineWidth=1.2*sc;
    ctx.beginPath(); ctx.arc(cx,hy+3*sc,4*sc,0.1,Math.PI-0.1); ctx.stroke();
    // Accessory
    switch(av.acc) {
      case 1: // Hat
        ctx.fillStyle=av.outC;
        ctx.fillRect(cx-13*sc,hy-hr-4*sc,26*sc,4*sc);
        ctx.fillRect(cx-8*sc,hy-hr-14*sc,16*sc,11*sc); break;
      case 2: // Glasses
        ctx.strokeStyle='#1e293b'; ctx.lineWidth=1.5*sc;
        ctx.strokeRect(cx-10*sc,hy-3*sc,8*sc,5*sc);
        ctx.strokeRect(cx+2*sc,hy-3*sc,8*sc,5*sc);
        ctx.beginPath(); ctx.moveTo(cx-2*sc,hy); ctx.lineTo(cx+2*sc,hy); ctx.stroke(); break;
      case 3: // Bag
        ctx.fillStyle='#78350f';
        ctx.fillRect(cx+W/2+2*sc,cy-H*0.55,9*sc,12*sc); break;
      case 4: // Crown
        ctx.fillStyle='#fbbf24';
        ctx.fillRect(cx-11*sc,hy-hr-5*sc,22*sc,5*sc);
        [[cx-8*sc,10],[cx,13],[cx+8*sc,10]].forEach(([x,h])=>
          ctx.fillRect(x-2*sc,hy-hr-5*sc-h*sc,4*sc,h*sc));
        break;
      case 5: // Bow
        ctx.fillStyle=av.hairC;
        [[1,-1],[-1,1]].forEach(([dx])=>{
          ctx.beginPath();
          ctx.moveTo(cx,hy-hr-3*sc);
          ctx.quadraticCurveTo(cx+dx*12*sc,hy-hr-11*sc,cx+dx*10*sc,hy-hr+2*sc);
          ctx.quadraticCurveTo(cx+dx*4*sc,hy-hr-2*sc,cx,hy-hr-3*sc);
          ctx.fill();
        });
        ctx.beginPath(); ctx.arc(cx,hy-hr-3*sc,3*sc,0,Math.PI*2); ctx.fill(); break;
    }
    ctx.lineWidth=1; // reset
  },

  // â”€â”€ Start world â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  beginWorld() {
    if (!this.avatarName.trim()) this.avatarName = 'Me';
    this.px = 280; this.py = 325;
    this.save();
    this.startWorld();
  },

  startWorld() {
    // Safety: if player is stuck inside a building collision zone, teleport to safe start
    if (this._hits(this.px, this.py)) { this.px = 280; this.py = 325; }
    const wd = WD[this.worldType];
    document.getElementById('wg-logo').textContent = wd.label + ' World';
    document.getElementById('wg-root').innerHTML = `
      <div class="wg-game-wrap">
        <div class="wg-hud">
          <span class="wg-hud-pill">ğŸ‘¤ ${this.avatarName}</span>
          <span class="wg-hud-pill">â­ ${this.specialty}</span>
          <span class="wg-hud-pill" id="wg-cur">${this.currency} ${wd.cur}</span>
        </div>
        <canvas id="wg-canvas" width="560" height="340"
          ondblclick="WG.toggleDpad()" style="cursor:pointer"></canvas>
        <div class="wg-hint">Arrow keys to move Â· Space to enter building Â· Double-click canvas for D-pad</div>
        <div id="wg-dpad" class="wg-dpad hidden">
          <div class="wg-dpad-row">
            <button class="wg-dpad-btn" onmousedown="WG.dkey('ArrowUp',1)" onmouseup="WG.dkey('ArrowUp',0)"
              ontouchstart="WG.dkey('ArrowUp',1)" ontouchend="WG.dkey('ArrowUp',0)">â–²</button>
          </div>
          <div class="wg-dpad-row">
            <button class="wg-dpad-btn" onmousedown="WG.dkey('ArrowLeft',1)" onmouseup="WG.dkey('ArrowLeft',0)"
              ontouchstart="WG.dkey('ArrowLeft',1)" ontouchend="WG.dkey('ArrowLeft',0)">â—€</button>
            <button class="wg-dpad-btn wg-dpad-enter" onmousedown="WG.dkey(' ',1)" onmouseup="WG.dkey(' ',0)"
              ontouchstart="WG.dkey(' ',1)" ontouchend="WG.dkey(' ',0)">ENTER</button>
            <button class="wg-dpad-btn" onmousedown="WG.dkey('ArrowRight',1)" onmouseup="WG.dkey('ArrowRight',0)"
              ontouchstart="WG.dkey('ArrowRight',1)" ontouchend="WG.dkey('ArrowRight',0)">â–¶</button>
          </div>
          <div class="wg-dpad-row">
            <button class="wg-dpad-btn" onmousedown="WG.dkey('ArrowDown',1)" onmouseup="WG.dkey('ArrowDown',0)"
              ontouchstart="WG.dkey('ArrowDown',1)" ontouchend="WG.dkey('ArrowDown',0)">â–¼</button>
          </div>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="WG.resetWorld()" style="margin-top:4px">ğŸ—‘ New World</button>
      </div>`;
    this.canvas = document.getElementById('wg-canvas');
    this.ctx    = this.canvas.getContext('2d');
    this.keys   = {};
    if (this.raf) cancelAnimationFrame(this.raf);
    this.lastTs = 0;
    this.raf = requestAnimationFrame(t => this.loop(t));
  },

  resetWorld() {
    if (!confirm('Start a new world? This will erase your current world!')) return;
    localStorage.removeItem('tt_world');
    this.worldType=null; this.specialty=null; this.worldDesc=''; this.avatarName='Me';
    this.currency=50; this.inventory=[];
    this.av={skin:'#f5c5a3',hair:0,hairC:'#2d1b00',eye:0,eyeC:'#4a3728',outC:'#3b82f6',out:0,acc:0};
    this.stop();
    this.step=1;
    this.renderSetup();
  },

  // â”€â”€ Game loop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  loop(ts) {
    if (!this.raf) return;
    this.raf = requestAnimationFrame(t => this.loop(t));
    if (!document.getElementById('wg-overlay')?.classList.contains('hidden')) {
      this.lastTs = ts; return; // paused in building
    }
    const dt = Math.min((ts - (this.lastTs||ts)) / 1000, 0.05);
    this.lastTs = ts;
    const spd = 90;
    let dx=0, dy=0;
    if (this.keys['ArrowLeft'])  dx=-spd*dt;
    if (this.keys['ArrowRight']) dx= spd*dt;
    if (this.keys['ArrowUp'])    dy=-spd*dt;
    if (this.keys['ArrowDown'])  dy= spd*dt;
    if (dx&&dy) { dx*=0.707; dy*=0.707; }

    const nxp = this.px+dx, nyp = this.py+dy;
    if (!this._hits(nxp, this.py)) this.px = Math.max(12, Math.min(548, nxp));
    if (!this._hits(this.px, nyp)) this.py = Math.max(12, Math.min(328, nyp));

    this.nearB = WG_BLDGS.find(b =>
      Math.hypot(this.px-(b.x+b.w/2), this.py-(b.y+b.h+10)) < 30
    ) || null;

    this._draw();
  },

  _hits(px, py) {
    const pl=px-12, pr=px+12, pt=py-30, pb=py;
    return WG_BLDGS.some(b => pl<b.x+b.w && pr>b.x && pt<b.y+b.h && pb>b.y);
  },

  // â”€â”€ Drawing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _draw() {
    const ctx=this.ctx, W=560, H=340, wd=WD[this.worldType];
    // Background
    ctx.fillStyle = wd.bg||'#d1fae5';
    ctx.fillRect(0,0,W,H);
    // Roads/paths
    ctx.fillStyle = wd.road||'#a3e635';
    ctx.globalAlpha=0.45;
    // Horizontal roads
    ctx.fillRect(0,142,W,28); ctx.fillRect(0,287,W,28);
    // Vertical roads at each building column (centres: 60, 200, 340, 480)
    [60,200,340,480].forEach(x=>ctx.fillRect(x-14,0,28,H));
    ctx.globalAlpha=1;
    // Path centres (lighter)
    ctx.fillStyle='rgba(255,255,255,0.18)';
    ctx.fillRect(0,150,W,12); ctx.fillRect(0,295,W,12);
    [60,200,340,480].forEach(x=>ctx.fillRect(x-6,0,12,H));

    // Buildings
    WG_BLDGS.forEach(bp=>{
      const loc = wd.locs.find(l=>l.id===bp.id);
      if (!loc) return;
      // Shadow
      ctx.fillStyle='rgba(0,0,0,0.12)';
      ctx.fillRect(bp.x+4,bp.y+4,bp.w,bp.h);
      // Body
      ctx.fillStyle=loc.c||'#e2e8f0';
      ctx.fillRect(bp.x,bp.y,bp.w,bp.h);
      // Outline
      ctx.strokeStyle= this.nearB===bp ? '#f59e0b' : 'rgba(0,0,0,0.18)';
      ctx.lineWidth  = this.nearB===bp ? 3 : 1.5;
      ctx.strokeRect(bp.x,bp.y,bp.w,bp.h);
      // Door
      const dx=bp.x+bp.w/2-8, dy=bp.y+bp.h-22;
      ctx.fillStyle='#78350f'; ctx.fillRect(dx,dy,16,22);
      ctx.fillStyle='#451a03'; ctx.fillRect(dx+5,dy+8,4,4);
      // Icon + name
      ctx.textAlign='center'; ctx.font=`${bp.h>70?22:18}px serif`;
      ctx.fillText(loc.e, bp.x+bp.w/2, bp.y+28);
      ctx.font='bold 9px sans-serif'; ctx.fillStyle='#1e293b';
      ctx.fillText(loc.n, bp.x+bp.w/2, bp.y+44);
    });

    // Near-building prompt
    if (this.nearB) {
      const loc = wd.locs.find(l=>l.id===this.nearB.id);
      ctx.fillStyle='rgba(0,0,0,0.78)';
      const tw=200, th=24, tx=W/2-tw/2, ty=H-32;
      ctx.fillRect(tx,ty,tw,th);
      ctx.fillStyle='#fef9c3'; ctx.font='bold 11px sans-serif'; ctx.textAlign='center';
      ctx.fillText(`Space â€” Enter ${loc?.n}`, W/2, ty+16);
    }

    // Player avatar
    this._drawAvatar(ctx, this.px, this.py, 1);
  },

  // â”€â”€ Building interaction â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  enterBuilding(bp) {
    const wd  = WD[this.worldType];
    const loc = wd.locs.find(l=>l.id===bp.id);
    if (!loc) return;
    let html = `<div class="wg-panel-head">
      <span class="wg-panel-icon">${loc.e}</span>
      <h3>${loc.n}</h3></div>`;

    if (loc.id==='home') {
      const unplaced = this._denUnplaced();
      const spotsHtml = this.denLayout.map((item, i) => {
        const row = Math.floor(i / 3);
        const rowLabel = ['ğŸªŸ','ğŸ“¦','ğŸŒ¿'][row];
        return `<div id="den-spot-${i}" onclick="WG.denTapSpot(${i})"
          style="background:${item?'#1e3a2f':'#0f172a'};border:2px ${item?'solid #22c55e':'dashed #1e293b'};
          border-radius:8px;padding:10px 4px;text-align:center;cursor:pointer;min-height:52px;
          display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;
          font-size:${item?'1.3rem':'1rem'};transition:all 0.15s">
          ${item || `<span style="color:#334155;font-size:0.7rem">${rowLabel} empty</span>`}
        </div>`;
      }).join('');
      const invHtml = unplaced.length
        ? unplaced.map(item => `<button id="den-inv-${CSS.escape(item)}" class="btn btn-secondary"
            style="font-size:0.78rem;padding:6px 8px;text-align:left"
            onclick="WG.denSelectItem('${item.replace(/'/g,"\\'")}')">${item}</button>`).join('')
        : `<div style="color:#475569;font-size:0.82rem">All items are placed! ğŸ‰</div>`;
      html += `
        <div style="font-size:0.75rem;color:#64748b;font-weight:700;text-transform:uppercase;margin-bottom:6px">Your Den</div>
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-bottom:10px">${spotsHtml}</div>
        <div style="font-size:0.75rem;color:#64748b;font-weight:700;text-transform:uppercase;margin-bottom:6px" id="den-inv-label">
          ${unplaced.length ? 'Tap an item, then tap a spot to place it:' : 'Inventory:'}
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:6px" id="den-inv-row">${invHtml}</div>
        <div style="margin-top:12px;padding:10px;background:#0f172a;border-radius:8px;text-align:center">
          <div style="font-size:0.7rem;color:#64748b;font-weight:700;text-transform:uppercase;margin-bottom:2px">${wd.cur}</div>
          <div style="font-size:1.8rem;font-weight:900">${this.currency}</div>
        </div>`;
    } else if (loc.earn) {
      const earn = 5+Math.floor(Math.random()*8);
      html += `<div style="color:#94a3b8;margin-bottom:16px">Use your specialty here to earn ${wd.cur}!</div>
        <div style="text-align:center;padding:14px;background:#0f172a;border-radius:10px;margin-bottom:16px">
          <div style="font-size:0.75rem;color:#64748b;font-weight:700;text-transform:uppercase">You have</div>
          <div style="font-size:2.2rem;font-weight:900">${this.currency} <span style="font-size:1rem">${wd.cur}</span></div>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="WG.doActivity(${earn})">
          â–¶ Do your specialty (+${earn} ${wd.cur})
        </button>`;
    } else if (loc.runway) {
      html += `<div id="wg-rw-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:8px">
          Watch for the glowing arrow â€” tap it before time runs out!
        </div>
        <canvas id="wg-rw-canvas" width="320" height="90"
          style="border-radius:10px;display:block;max-width:100%;margin:0 auto"></canvas>
        <div style="display:flex;gap:10px;justify-content:center;margin:12px 0">
          <button id="rw-btn-left"  class="btn btn-secondary" style="font-size:1.6rem;min-width:56px;transition:all 0.1s" onclick="WG.rwPress('ArrowLeft')">â¬…</button>
          <button id="rw-btn-down"  class="btn btn-secondary" style="font-size:1.6rem;min-width:56px;transition:all 0.1s" onclick="WG.rwPress('ArrowDown')">â¬‡</button>
          <button id="rw-btn-up"    class="btn btn-secondary" style="font-size:1.6rem;min-width:56px;transition:all 0.1s" onclick="WG.rwPress('ArrowUp')">â¬†</button>
          <button id="rw-btn-right" class="btn btn-secondary" style="font-size:1.6rem;min-width:56px;transition:all 0.1s" onclick="WG.rwPress('ArrowRight')">â¡</button>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;font-size:1.2rem;min-height:1.5rem" id="wg-rw-stars"></div>
        <div style="font-size:0.8rem;color:#64748b;text-align:center;margin-top:4px">
          Earned: <strong id="wg-rw-earned">0</strong> ${wd.cur}
        </div>
      </div>`;
    } else if (loc.photo) {
      html += `<div class="wg-photo-wrap">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center">
          ${loc.sub||'ğŸ“·'} is moving â€” hit SNAP when the bar is in the <strong style="color:#22c55e">green zone</strong>!
        </div>
        <div>
          <div class="wg-photo-meter" id="wg-ph-meter">
            <div class="wg-photo-cursor" id="wg-ph-cursor" style="left:50%"></div>
          </div>
          <div class="wg-photo-labels">
            <span>âŒ Miss</span><span>ğŸ‘ OK</span><span style="color:#22c55e">â­ Perfect</span><span>ğŸ‘ OK</span><span>âŒ Miss</span>
          </div>
        </div>
        <button class="btn btn-primary" id="wg-ph-btn" onclick="WG.snapPhoto()" style="width:100%;font-size:1.1rem">
          ğŸ“¸ SNAP! &nbsp;<span id="wg-ph-snaps">3</span> left
        </button>
        <div class="wg-ph-fb" id="wg-ph-fb"></div>
        <div style="font-size:0.8rem;color:#64748b;text-align:center">
          Earned: <strong id="wg-ph-earned">0</strong> ${wd.cur}
        </div>
      </div>`;
    } else if (loc.banquet) {
      html += `<div id="wg-bq-area"></div>`;
    } else if (loc.safari) {
      html += `<div id="wg-sf-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:8px">
          Tap the animals before they wander off! ğŸŒ¿
        </div>
        <canvas id="wg-sf-canvas" width="320" height="180"
          style="border-radius:12px;display:block;max-width:100%;margin:0 auto;cursor:pointer"
          onclick="WG.safariTap(event)"></canvas>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:0.85rem;color:#64748b">
          <span>Spotted: <strong id="wg-sf-count">0</strong></span>
          <span>Earned: <strong id="wg-sf-earned">0</strong> ${wd.cur}</span>
        </div>
        <button class="btn btn-primary" style="width:100%;margin-top:10px" onclick="WG._startSafari()">ğŸ”„ New animals</button>
      </div>`;
    } else if (loc.care) {
      html += `<div id="wg-care-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:10px">
          Give the animals what they need to earn ${wd.cur}!
        </div>
        <div style="text-align:center;padding:18px;background:#0f172a;border-radius:12px;margin-bottom:12px;min-height:90px">
          <div id="wg-care-animal" style="font-size:3rem">ğŸ¾</div>
          <div id="wg-care-need" style="font-size:1rem;margin-top:6px;color:#e2e8f0">Loadingâ€¦</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px" id="wg-care-btns">
          <button class="btn btn-secondary" style="font-size:1rem" onclick="WG.careAction('feed')">ğŸ– Feed</button>
          <button class="btn btn-secondary" style="font-size:1rem" onclick="WG.careAction('water')">ğŸ’§ Water</button>
          <button class="btn btn-secondary" style="font-size:1rem" onclick="WG.careAction('wash')">ğŸ› Wash</button>
          <button class="btn btn-secondary" style="font-size:1rem" onclick="WG.careAction('pet')">ğŸ’• Pet</button>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:0.85rem;color:#64748b">
          <span>Round: <strong id="wg-care-round">1</strong> / 6</span>
          <span>Earned: <strong id="wg-care-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-care-stars"></div>
      </div>`;
    } else if (loc.marking) {
      html += `<div id="wg-mk-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:10px">
          Mark each answer âœ… or âŒ, then give the student a grade! ğŸ“
        </div>
        <div style="background:#0f172a;border-radius:12px;padding:12px;margin-bottom:10px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
            <div id="wg-mk-student" style="font-size:2rem">ğŸ§‘</div>
            <div>
              <div id="wg-mk-name" style="font-weight:800;font-size:0.9rem">Loadingâ€¦</div>
              <div style="font-size:0.75rem;color:#64748b">Test paper</div>
            </div>
            <div style="margin-left:auto;font-size:0.75rem;color:#64748b;text-align:right">Round <strong id="wg-mk-round">1</strong>/5</div>
          </div>
          <div id="wg-mk-answers" style="display:flex;flex-direction:column;gap:6px"></div>
        </div>
        <div style="display:flex;gap:10px" id="wg-mk-grade-btns" style="display:none">
          <button class="btn" style="flex:1;font-size:1.3rem;font-weight:900;background:#22c55e;color:#fff" onclick="WG.mkGrade('A')">ğŸ…° Grade A</button>
          <button class="btn" style="flex:1;font-size:1.3rem;font-weight:900;background:#ef4444;color:#fff" onclick="WG.mkGrade('F')">ğŸ…µ Grade F</button>
        </div>
        <div id="wg-mk-hint" style="font-size:0.8rem;color:#64748b;text-align:center;margin-top:6px">Tap each answer to mark it first!</div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:0.85rem;color:#64748b">
          <span>Papers marked: <strong id="wg-mk-done">0</strong> / 5</span>
          <span>Earned: <strong id="wg-mk-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-mk-stars"></div>
      </div>`;
    } else if (loc.lab) {
      html += `<div id="wg-lab-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:8px">
          Pour the right chemical into each beaker! ğŸ§ª
        </div>
        <canvas id="wg-lab-canvas" width="320" height="160"
          style="border-radius:12px;display:block;max-width:100%;margin:0 auto;cursor:pointer"
          onclick="WG.labCanvasTap(event)"></canvas>
        <div style="font-size:0.8rem;color:#94a3b8;text-align:center;margin:8px 0" id="wg-lab-instruction">Select a chemical to pourâ€¦</div>
        <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-bottom:4px" id="wg-lab-chemicals"></div>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:0.85rem;color:#64748b">
          <span>Round: <strong id="wg-lab-round">1</strong> / 5</span>
          <span>Earned: <strong id="wg-lab-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-lab-stars"></div>
      </div>`;
    } else if (loc.library) {
      html += `<div id="wg-lb-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:10px">
          Tap the right shelf to shelve this book! ğŸ“š
        </div>
        <div style="background:#0f172a;border-radius:12px;padding:16px;margin-bottom:12px;text-align:center">
          <div id="wg-lb-book" style="font-size:2.8rem">ğŸ“–</div>
          <div id="wg-lb-title" style="font-weight:800;font-size:1rem;margin-top:6px">Loadingâ€¦</div>
          <div id="wg-lb-clue" style="font-size:0.82rem;color:#94a3b8;margin-top:4px;font-style:italic"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px" id="wg-lb-shelves">
          <button class="btn btn-secondary" style="font-size:0.88rem;padding:12px 6px;display:flex;flex-direction:column;align-items:center;gap:4px" onclick="WG.lbShelve('science')"><span style="font-size:1.4rem">ğŸ”¬</span>Science</button>
          <button class="btn btn-secondary" style="font-size:0.88rem;padding:12px 6px;display:flex;flex-direction:column;align-items:center;gap:4px" onclick="WG.lbShelve('history')"><span style="font-size:1.4rem">ğŸ“œ</span>History</button>
          <button class="btn btn-secondary" style="font-size:0.88rem;padding:12px 6px;display:flex;flex-direction:column;align-items:center;gap:4px" onclick="WG.lbShelve('nature')"><span style="font-size:1.4rem">ğŸŒ¿</span>Nature</button>
          <button class="btn btn-secondary" style="font-size:0.88rem;padding:12px 6px;display:flex;flex-direction:column;align-items:center;gap:4px" onclick="WG.lbShelve('stories')"><span style="font-size:1.4rem">âœ¨</span>Stories</button>
          <button class="btn btn-secondary" style="font-size:0.88rem;padding:12px 6px;display:flex;flex-direction:column;align-items:center;gap:4px" onclick="WG.lbShelve('maths')"><span style="font-size:1.4rem">ğŸ”¢</span>Maths</button>
          <button class="btn btn-secondary" style="font-size:0.88rem;padding:12px 6px;display:flex;flex-direction:column;align-items:center;gap:4px" onclick="WG.lbShelve('art')"><span style="font-size:1.4rem">ğŸ¨</span>Art & Music</button>
        </div>
        <div id="wg-lb-reply" style="min-height:24px;text-align:center;font-size:0.85rem;font-weight:700;margin-top:8px"></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:0.85rem;color:#64748b">
          <span>Book: <strong id="wg-lb-round">1</strong> / 7</span>
          <span>Earned: <strong id="wg-lb-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-lb-stars"></div>
      </div>`;
    } else if (loc.quiz) {
      html += `<div id="wg-qz-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:10px">
          Answer the question correctly to earn Marks! ğŸ“
        </div>
        <div style="background:#0f172a;border-radius:12px;padding:16px;margin-bottom:12px">
          <div id="wg-qz-subject" style="font-size:0.7rem;color:#f59e0b;font-weight:700;text-transform:uppercase;margin-bottom:6px">Subject</div>
          <div id="wg-qz-question" style="font-size:0.95rem;font-weight:700;line-height:1.4;color:#e2e8f0">Loadingâ€¦</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:7px" id="wg-qz-btns"></div>
        <div id="wg-qz-reply" style="min-height:24px;text-align:center;font-size:0.85rem;font-weight:700;margin-top:8px"></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:0.85rem;color:#64748b">
          <span>Question: <strong id="wg-qz-round">1</strong> / 6</span>
          <span>Earned: <strong id="wg-qz-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-qz-stars"></div>
      </div>`;
    } else if (loc.training) {
      html += `<div id="wg-tr-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:8px">
          Pick the right activities to match your trainee's goals! ğŸƒ
        </div>
        <div style="background:#0f172a;border-radius:12px;padding:14px;margin-bottom:10px">
          <div style="display:flex;align-items:center;gap:12px">
            <div id="wg-tr-person" style="font-size:2.2rem">ğŸƒ</div>
            <div>
              <div id="wg-tr-name" style="font-weight:800;font-size:0.95rem">Loadingâ€¦</div>
              <div id="wg-tr-desc" style="font-size:0.8rem;color:#94a3b8;margin-top:2px"></div>
            </div>
          </div>
          <div style="margin-top:10px;font-size:0.78rem;color:#64748b;font-weight:700;text-transform:uppercase">Training goals:</div>
          <div id="wg-tr-goals" style="display:flex;gap:8px;margin-top:6px;flex-wrap:wrap"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:7px" id="wg-tr-btns"></div>
        <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:0.85rem;color:#64748b">
          <span>Trainee: <strong id="wg-tr-round">1</strong> / 5</span>
          <span>Earned: <strong id="wg-tr-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-tr-stars"></div>
      </div>`;
    } else if (loc.gym) {
      html += `<div id="wg-gym-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:8px">
          Set the machine to the right speed for this person! ğŸ’ª
        </div>
        <canvas id="wg-gym-canvas" width="320" height="180"
          style="border-radius:12px;display:block;max-width:100%;margin:0 auto"></canvas>
        <button id="wg-gym-btn" class="btn btn-primary" style="width:100%;margin-top:10px;font-size:1.1rem"
          onclick="WG.gymSet()">âš¡ Set Power!</button>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:0.85rem;color:#64748b">
          <span>Round: <strong id="wg-gym-round">1</strong> / 5</span>
          <span>Earned: <strong id="wg-gym-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-gym-stars"></div>
      </div>`;
    } else if (loc.goals) {
      html += `<div id="wg-gl-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:8px">
          Tap where you want to shoot! âš½ Beat the keeper!
        </div>
        <canvas id="wg-gl-canvas" width="320" height="200"
          style="border-radius:12px;display:block;max-width:100%;margin:0 auto;cursor:crosshair"
          onclick="WG.glShoot(event)"></canvas>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:0.85rem;color:#64748b">
          <span>Shots: <strong id="wg-gl-shots">0</strong> / 5</span>
          <span>Goals: <strong id="wg-gl-goals">0</strong> &nbsp;Â·&nbsp; Earned: <strong id="wg-gl-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-gl-stars"></div>
      </div>`;
    } else if (loc.whistle) {
      html += `<div id="wg-wh-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:8px">
          Tap rule-breakers to blow your whistle! ğŸ“£ Don't tap good swimmers!
        </div>
        <canvas id="wg-wh-canvas" width="320" height="200"
          style="border-radius:12px;display:block;max-width:100%;margin:0 auto;cursor:pointer"
          onclick="WG.whTap(event)"></canvas>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:0.85rem;color:#64748b">
          <span>Spotted: <strong id="wg-wh-caught">0</strong></span>
          <span>Earned: <strong id="wg-wh-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-wh-stars"></div>
      </div>`;
    } else if (loc.sculpt) {
      html += `<div id="wg-sc-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:8px">
          Tap the glowing zone on the stone with your chisel! ğŸ—¿
        </div>
        <canvas id="wg-sc-canvas" width="320" height="180"
          style="border-radius:12px;display:block;max-width:100%;margin:0 auto;cursor:crosshair"
          onclick="WG.scChisel(event)"></canvas>
        <div style="display:flex;justify-content:space-between;margin-top:8px;font-size:0.85rem;color:#64748b">
          <span>Cuts: <strong id="wg-sc-cuts">0</strong> / 6</span>
          <span>Earned: <strong id="wg-sc-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-sc-stars"></div>
      </div>`;
    } else if (loc.museum) {
      html += `<div id="wg-ms-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:10px">
          Hang the artwork in the right exhibit slot! ğŸ›
        </div>
        <div style="background:#1e1033;border-radius:12px;padding:14px 10px;margin-bottom:12px;text-align:center">
          <div style="font-size:0.7rem;color:#a78bfa;text-transform:uppercase;font-weight:700;margin-bottom:6px">Artwork to hang</div>
          <div id="wg-ms-art" style="font-size:2.5rem">ğŸ–¼</div>
          <div id="wg-ms-clue" style="font-size:0.9rem;color:#e2e8f0;margin-top:6px;font-style:italic">Loadingâ€¦</div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px" id="wg-ms-slots">
          <button class="btn btn-secondary" style="font-size:0.9rem;padding:12px 6px;flex-direction:column;display:flex;align-items:center;gap:4px" onclick="WG.msPlace('abstract')"><span style="font-size:1.4rem">ğŸŒ€</span>Abstract</button>
          <button class="btn btn-secondary" style="font-size:0.9rem;padding:12px 6px;flex-direction:column;display:flex;align-items:center;gap:4px" onclick="WG.msPlace('nature')"><span style="font-size:1.4rem">ğŸŒ¿</span>Nature</button>
          <button class="btn btn-secondary" style="font-size:0.9rem;padding:12px 6px;flex-direction:column;display:flex;align-items:center;gap:4px" onclick="WG.msPlace('portrait')"><span style="font-size:1.4rem">ğŸ‘¤</span>Portrait</button>
          <button class="btn btn-secondary" style="font-size:0.9rem;padding:12px 6px;flex-direction:column;display:flex;align-items:center;gap:4px" onclick="WG.msPlace('modern')"><span style="font-size:1.4rem">ğŸ”·</span>Modern</button>
        </div>
        <div id="wg-ms-reply" style="min-height:24px;text-align:center;font-size:0.85rem;font-weight:700;margin-top:8px"></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:0.85rem;color:#64748b">
          <span>Artwork: <strong id="wg-ms-round">1</strong> / 6</span>
          <span>Earned: <strong id="wg-ms-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-ms-stars"></div>
      </div>`;
    } else if (loc.interview) {
      html += `<div id="wg-iv-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:10px">
          Pick the best question to interview the festival guest! ğŸ¤
        </div>
        <div style="background:#0f172a;border-radius:12px;padding:16px;margin-bottom:12px;text-align:center">
          <div id="wg-iv-guest" style="font-size:2.5rem">ğŸ§‘</div>
          <div id="wg-iv-clue" style="margin-top:8px;font-size:0.95rem;color:#e2e8f0;font-style:italic">"Loadingâ€¦"</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px" id="wg-iv-btns"></div>
        <div id="wg-iv-reply" style="margin-top:10px;min-height:32px;font-size:0.85rem;color:#22c55e;text-align:center;font-weight:700"></div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:0.85rem;color:#64748b">
          <span>Guest: <strong id="wg-iv-round">1</strong> / 5</span>
          <span>Earned: <strong id="wg-iv-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-iv-stars"></div>
      </div>`;
    } else if (loc.cook) {
      html += `<div id="wg-cook-area">
        <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:8px">
          A customer wants this dish â€” tap all the right ingredients! ğŸ‘¨â€ğŸ³
        </div>
        <div style="background:#0f172a;border-radius:12px;padding:14px;margin-bottom:10px;text-align:center">
          <div id="wg-cook-dish" style="font-size:2rem">ğŸ½</div>
          <div id="wg-cook-name" style="font-weight:800;margin:4px 0">Loadingâ€¦</div>
          <div id="wg-cook-needed" style="font-size:0.85rem;color:#94a3b8;display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin-top:6px"></div>
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:7px;justify-content:center" id="wg-cook-btns"></div>
        <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:0.85rem;color:#64748b">
          <span>Order: <strong id="wg-cook-round">1</strong> / 5</span>
          <span>Earned: <strong id="wg-cook-earned">0</strong> ${wd.cur}</span>
        </div>
        <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-cook-stars"></div>
      </div>`;
    } else if (loc.view) {
      html += `<div style="text-align:center;padding:28px 0">
        <div style="font-size:4rem">${loc.e}</div>
        <div style="color:#94a3b8;margin-top:8px">You explore ${loc.n}. It's amazing!</div>
      </div>`;
    } else if (loc.items) {
      const itemsHtml = loc.items.map(([name,price])=>{
        const owned=this.inventory.filter(i=>i===name).length;
        const canBuy=this.currency>=price;
        return `<div class="wg-shop-item">
          <span class="wg-item-name">${name}</span>
          <span class="wg-item-price">${price} ${wd.cur.split(' ')[1]||'ğŸª™'}</span>
          ${owned?`<span class="badge good">Ã—${owned}</span>`:''}
          <button class="btn btn-primary btn-sm" onclick="WG.buy('${name.replace(/'/g,'\\\'')}',${ price})"
            ${canBuy?'':'disabled style="opacity:0.45"'}>Buy</button>
        </div>`;
      }).join('');
      html += `<div style="font-size:0.82rem;color:#94a3b8;margin-bottom:12px">
        You have: <strong>${this.currency} ${wd.cur}</strong></div>${itemsHtml}`;
    }

    html += `<button class="btn btn-secondary" onclick="WG.leaveBuilding()" style="margin-top:16px;width:100%">â† Leave</button>`;
    document.getElementById('wg-panel').innerHTML = html;
    document.getElementById('wg-overlay').classList.remove('hidden');
    if (loc.runway)   this._startRunway();
    if (loc.safari)   this._startSafari();
    if (loc.care)     this._startCare();
    if (loc.marking)   this._startMarking();
    if (loc.lab)       this._startLab();
    if (loc.library)   this._startLibrary();
    if (loc.quiz)      this._startQuiz();
    if (loc.training)  this._startTraining();
    if (loc.gym)       this._startGym();
    if (loc.goals)     this._startGoals();
    if (loc.whistle)   this._startWhistle();
    if (loc.sculpt)    this._startSculpt();
    if (loc.museum)    this._startMuseum();
    if (loc.interview) this._startInterview();
    if (loc.cook)     this._startCook();
    if (loc.photo)    this._startPhotoMeter();
    if (loc.banquet)  this._startBanquet();
  },

  leaveBuilding() {
    if (this._photoRaf) { cancelAnimationFrame(this._photoRaf); this._photoRaf = null; }
    if (this._rwRaf)    { cancelAnimationFrame(this._rwRaf);    this._rwRaf = null; }
    if (this._sfRaf)    { cancelAnimationFrame(this._sfRaf);    this._sfRaf = null; }
    if (this._scRaf)    { cancelAnimationFrame(this._scRaf);    this._scRaf = null; }
    if (this._whRaf)    { cancelAnimationFrame(this._whRaf);    this._whRaf = null; }
    if (this._glRaf)    { cancelAnimationFrame(this._glRaf);    this._glRaf = null; }
    if (this._gymRaf)   { cancelAnimationFrame(this._gymRaf);   this._gymRaf = null; }
    this._rwActive = false;
    document.getElementById('wg-overlay')?.classList.add('hidden');
  },

  buy(name, price) {
    if (this.currency < price) return;
    this.currency -= price;
    this.inventory.push(name);
    this.save();
    document.getElementById('wg-cur').textContent = `${this.currency} ${WD[this.worldType].cur}`;
    // Refresh shop panel
    if (this.nearB) this.enterBuilding(this.nearB);
  },

  doActivity(earn) {
    this.currency += earn;
    this.save();
    document.getElementById('wg-cur').textContent = `${this.currency} ${WD[this.worldType].cur}`;
    this.leaveBuilding();
    // Flash message
    const m=document.createElement('div');
    m.style.cssText='position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);background:#22c55e;color:#fff;padding:14px 28px;border-radius:12px;font-weight:800;font-size:1.2rem;z-index:1000;pointer-events:none';
    m.textContent=`+${earn} ${WD[this.worldType].cur}!`;
    document.body.appendChild(m);
    setTimeout(()=>m.remove(), 1600);
  },

  // â”€â”€ Fashion Runway â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _RW_MOVES: [
    {key:'ArrowLeft',  id:'left',  e:'â¬…'},
    {key:'ArrowRight', id:'right', e:'â¡'},
    {key:'ArrowUp',    id:'up',    e:'â¬†'},
    {key:'ArrowDown',  id:'down',  e:'â¬‡'},
  ],
  _rwActive: false, _rwRaf: null,
  _rwStep: 0, _rwTarget: null, _rwPTime: 0, _rwPMax: 2.5,
  _rwEarned: 0, _rwStars: [],

  _startRunway() {
    this._rwStep    = 0;
    this._rwEarned  = 0;
    this._rwStars   = [];
    this._rwActive  = true;
    this._rwTarget  = null;
    this._rwLastT   = performance.now();
    this._rwWait    = 0.6; // pause before first prompt
    this._rwPickNext();
    const tick = (ts) => {
      if (!document.getElementById('wg-rw-canvas')) { this._rwRaf = null; return; }
      const dt = Math.min((ts - this._rwLastT) / 1000, 0.05);
      this._rwLastT = ts;
      this._rwTickDraw(dt);
      if (this._rwActive) this._rwRaf = requestAnimationFrame(tick);
    };
    this._rwRaf = requestAnimationFrame(tick);
  },

  _rwPickNext() {
    this._rwTarget = this._RW_MOVES[Math.floor(Math.random() * this._RW_MOVES.length)];
    this._rwPTime  = this._rwPMax;
    this._rwUpdateButtons();
  },

  _rwUpdateButtons() {
    for (const m of this._RW_MOVES) {
      const btn = document.getElementById(`rw-btn-${m.id}`);
      if (!btn) continue;
      const isTarget = this._rwTarget && this._rwTarget.id === m.id;
      btn.style.transform   = isTarget ? 'scale(1.3)'        : 'scale(1)';
      btn.style.background  = isTarget ? '#ec4899'           : '';
      btn.style.color       = isTarget ? '#fff'              : '';
      btn.style.borderColor = isTarget ? '#ec4899'           : '';
      btn.style.boxShadow   = isTarget ? '0 0 16px #ec489988': '';
      btn.style.opacity     = (!this._rwTarget || isTarget)  ? '1' : '0.25';
      btn.style.pointerEvents = (!this._rwTarget || isTarget) ? 'auto' : 'none';
    }
  },

  _rwTickDraw(dt) {
    if (this._rwTarget) {
      this._rwPTime -= dt;
      if (this._rwPTime <= 0) {
        // Timed out â€” count as miss
        this._rwStars.push('âŒ');
        this._rwTarget = null;
        this._rwStep++;
        this._rwUpdateButtons();
        if (this._rwStep >= 8) { this._rwFinish(); return; }
        this._rwWait = 0.5;
      }
    } else if (!this._rwActive) {
      return;
    } else {
      this._rwWait -= dt;
      if (this._rwWait <= 0) this._rwPickNext();
    }

    // Draw countdown bar on canvas
    const canvas = document.getElementById('wg-rw-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = 320, H = 90;

    // Background
    ctx.fillStyle = '#2d0b3e';
    ctx.fillRect(0, 0, W, H);

    // Audience lights
    const cols = ['#ec4899','#a855f7','#f97316','#3b82f6','#22c55e','#fbbf24'];
    for (let i = 0; i < 11; i++) {
      ctx.fillStyle = cols[i % cols.length];
      ctx.beginPath(); ctx.arc(15 + i * 28, 12, 7, 0, Math.PI * 2); ctx.fill();
    }

    // Runway strip
    ctx.fillStyle = '#f8e4f5';
    ctx.fillRect(0, 28, W, 36);
    ctx.strokeStyle = '#ec4899'; ctx.lineWidth = 2;
    ctx.strokeRect(0, 28, W, 36);

    // Step pips
    for (let s = 0; s < 8; s++) {
      const done = s < this._rwStep;
      ctx.fillStyle = done ? '#4ade80' : 'rgba(255,255,255,0.25)';
      ctx.beginPath(); ctx.arc(24 + s * 38, 46, 5, 0, Math.PI * 2); ctx.fill();
    }

    // Countdown arc above current step pip
    if (this._rwTarget) {
      const ratio = this._rwPTime / this._rwPMax;
      const cx = 24 + this._rwStep * 38, cy = 46;
      const ringCol = ratio > 0.55 ? '#22c55e' : ratio > 0.28 ? '#f59e0b' : '#ef4444';
      ctx.strokeStyle = ringCol; ctx.lineWidth = 4;
      ctx.beginPath();
      ctx.arc(cx, cy, 14, -Math.PI / 2, -Math.PI / 2 + Math.PI * 2 * ratio);
      ctx.stroke();
      ctx.font = '14px serif'; ctx.textAlign = 'center'; ctx.fillStyle = '#fff';
      ctx.fillText(this._rwTarget.e, cx, cy + 5);
    }

    // Stars row
    const starsEl = document.getElementById('wg-rw-stars');
    if (starsEl) starsEl.textContent = this._rwStars.join(' ');
    const earnedEl = document.getElementById('wg-rw-earned');
    if (earnedEl) earnedEl.textContent = this._rwEarned;
  },

  rwPress(key) {
    if (!this._rwActive || !this._rwTarget) return;
    if (key === this._rwTarget.key) {
      const ratio = this._rwPTime / this._rwPMax;
      const coins = ratio > 0.55 ? 5 : ratio > 0.28 ? 3 : 2;
      const star  = ratio > 0.55 ? 'â­' : ratio > 0.28 ? 'ğŸŒŸ' : 'âœ…';
      this._rwEarned += coins;
      this._rwStars.push(star);
    } else {
      this._rwStars.push('âŒ');
    }
    this._rwTarget = null;
    this._rwStep++;
    this._rwUpdateButtons();
    if (this._rwStep >= 8) { this._rwFinish(); return; }
    this._rwWait = 0.5;
  },

  _rwFinish() {
    this._rwActive = false;
    if (this._rwRaf) { cancelAnimationFrame(this._rwRaf); this._rwRaf = null; }
    const wd = WD[this.worldType];
    this.currency += this._rwEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area = document.getElementById('wg-rw-area');
    const hits = this._rwStars.filter(s => s !== 'âŒ').length;
    const trophy = hits >= 7 ? 'ğŸ†' : hits >= 5 ? 'ğŸ¥‡' : hits >= 3 ? 'ğŸ‘—' : 'ğŸ’ª';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Runway complete!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._rwStars.join(' ')}</div>
        <div>${hits}/8 hits &nbsp;Â·&nbsp; Earned <strong>${this._rwEarned} ${wd.cur}</strong></div>
      </div>`;
  },

  // â”€â”€ Nature Park: Animal Care â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _CARE_ANIMALS: [
    {e:'ğŸ•',n:'Puppy'}, {e:'ğŸˆ',n:'Kitten'}, {e:'ğŸ‡',n:'Bunny'},
    {e:'ğŸ¹',n:'Hamster'},{e:'ğŸ¦',n:'Birdie'}, {e:'ğŸ¢',n:'Turtle'},
    {e:'ğŸ¦œ',n:'Parrot'}, {e:'ğŸ¦”',n:'Hedgehog'},{e:'ğŸ ',n:'Goldfish'},
    {e:'ğŸ“',n:'Chicken'},{e:'ğŸ¦™',n:'Llama'},   {e:'ğŸ‘',n:'Lamb'},
  ],
  _CARE_NEEDS: [
    {id:'feed',  label:'is hungry!',       action:'feed',  icon:'ğŸ–'},
    {id:'water', label:'is thirsty!',      action:'water', icon:'ğŸ’§'},
    {id:'wash',  label:'needs a wash!',    action:'wash',  icon:'ğŸ›'},
    {id:'pet',   label:'wants attention!', action:'pet',   icon:'ğŸ’•'},
  ],
  _careRound: 0, _careEarned: 0, _careStars: [], _careCurrent: null,

  _startCare() {
    this._careRound  = 0;
    this._careEarned = 0;
    this._careStars  = [];
    this._careNext();
  },

  _careNext() {
    const animal = this._CARE_ANIMALS[Math.floor(Math.random() * this._CARE_ANIMALS.length)];
    const need   = this._CARE_NEEDS[Math.floor(Math.random() * this._CARE_NEEDS.length)];
    this._careCurrent = {animal, need};
    const aEl = document.getElementById('wg-care-animal');
    const nEl = document.getElementById('wg-care-need');
    const rEl = document.getElementById('wg-care-round');
    if (aEl) aEl.textContent = animal.e;
    if (nEl) nEl.innerHTML = `<strong>${animal.n}</strong> ${need.label} ${need.icon}`;
    if (rEl) rEl.textContent = this._careRound + 1;
    // Reset button styles
    document.querySelectorAll('#wg-care-btns button').forEach(b => {
      b.style.background = ''; b.style.color = ''; b.style.transform = '';
    });
  },

  careAction(action) {
    if (!this._careCurrent) return;
    const correct = action === this._careCurrent.need.action;
    const aEl = document.getElementById('wg-care-animal');
    const btns = document.querySelectorAll('#wg-care-btns button');
    if (correct) {
      const earn = 4;
      this._careEarned += earn;
      this._careStars.push('â­');
      if (aEl) { aEl.textContent = 'ğŸ˜Š'; }
      btns.forEach(b => { if (b.textContent.includes(action === 'feed' ? 'ğŸ–' : action === 'water' ? 'ğŸ’§' : action === 'wash' ? 'ğŸ›' : 'ğŸ’•')) { b.style.background='#22c55e'; b.style.color='#fff'; } });
    } else {
      this._careStars.push('âŒ');
      if (aEl) { aEl.textContent = 'ğŸ˜¢'; }
    }
    const starsEl  = document.getElementById('wg-care-stars');
    const earnedEl = document.getElementById('wg-care-earned');
    if (starsEl)  starsEl.textContent  = this._careStars.join(' ');
    if (earnedEl) earnedEl.textContent = this._careEarned;
    this._careRound++;
    this._careCurrent = null;

    if (this._careRound >= 6) {
      setTimeout(() => this._careFinish(), 700);
    } else {
      setTimeout(() => this._careNext(), 700);
    }
  },

  _careFinish() {
    const wd = WD[this.worldType];
    this.currency += this._careEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area = document.getElementById('wg-care-area');
    const hits  = this._careStars.filter(s => s === 'â­').length;
    const trophy = hits === 6 ? 'ğŸ†' : hits >= 4 ? 'ğŸ¥‡' : hits >= 2 ? 'ğŸ¥ˆ' : 'ğŸ’ª';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Animals cared for!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._careStars.join(' ')}</div>
        <div>${hits}/6 correct &nbsp;Â·&nbsp; Earned <strong>${this._careEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._restartCare()">ğŸ”„ Go again</button>
      </div>`;
  },

  // â”€â”€ Study Garden: Test Marking Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _MK_STUDENTS: [
    {e:'ğŸ§’', name:'Sam'},  {e:'ğŸ‘§', name:'Lily'}, {e:'ğŸ§‘', name:'Max'},
    {e:'ğŸ‘¦', name:'Noah'}, {e:'ğŸ‘©', name:'Zara'}, {e:'ğŸ§‘', name:'Priya'},
  ],
  _MK_TESTS: [
    {q:'What is 6 Ã— 8?',              right:'48',   wrong:'42'},
    {q:'Capital of Germany?',         right:'Berlin',wrong:'Paris'},
    {q:'How many sides on a triangle?',right:'3',   wrong:'4'},
    {q:'What gas do plants breathe?', right:'COâ‚‚',  wrong:'Oâ‚‚'},
    {q:'Who wrote Romeo & Juliet?',   right:'Shakespeare',wrong:'Dickens'},
    {q:'What is 100 Ã· 4?',           right:'25',   wrong:'20'},
    {q:'Largest planet in solar system?',right:'Jupiter',wrong:'Saturn'},
    {q:'What is 3Â²?',                 right:'9',    wrong:'6'},
    {q:'Water boils at?',             right:'100Â°C',wrong:'90Â°C'},
    {q:'How many continents?',        right:'7',    wrong:'6'},
    {q:'What is a baby frog called?', right:'Tadpole',wrong:'Froglet'},
    {q:'Â½ of 360?',                   right:'180',  wrong:'170'},
    {q:'What colour do red + blue make?',right:'Purple',wrong:'Green'},
    {q:'Nearest star to Earth?',      right:'The Sun',wrong:'Proxima Centauri'},
    {q:'How many days in a leap year?',right:'366', wrong:'365'},
  ],
  _mkRound: 0, _mkEarned: 0, _mkStars: [],
  _mkPaper: null, _mkMarked: [],

  _startMarking() {
    this._mkRound  = 0;
    this._mkEarned = 0;
    this._mkStars  = [];
    this._mkNextPaper();
  },

  _mkNextPaper() {
    // Pick 4 random questions; each answer is randomly correct or wrong
    const pool = [...this._MK_TESTS].sort(() => Math.random() - 0.5).slice(0, 4);
    const student = this._MK_STUDENTS[Math.floor(Math.random() * this._MK_STUDENTS.length)];
    this._mkPaper = pool.map(t => {
      const isCorrect = Math.random() > 0.45;
      return {q: t.q, answer: isCorrect ? t.right : t.wrong, correct: isCorrect};
    });
    this._mkMarked = Array(4).fill(null); // null = unmarked, true = marked correct, false = marked wrong

    const sEl = document.getElementById('wg-mk-student');
    const nEl = document.getElementById('wg-mk-name');
    const rEl = document.getElementById('wg-mk-round');
    const hEl = document.getElementById('wg-mk-hint');
    const gEl = document.getElementById('wg-mk-grade-btns');
    if (sEl) sEl.textContent = student.e;
    if (nEl) nEl.textContent = `${student.name}'s Test`;
    if (rEl) rEl.textContent = this._mkRound + 1;
    if (hEl) { hEl.textContent = 'Tap each answer to mark it first!'; hEl.style.color = '#64748b'; }
    if (gEl) gEl.style.opacity = '0.35';

    const aEl = document.getElementById('wg-mk-answers');
    if (aEl) aEl.innerHTML = this._mkPaper.map((item, i) =>
      `<div style="background:#1e293b;border-radius:8px;padding:8px 10px;display:flex;align-items:center;justify-content:space-between;gap:8px">
        <div>
          <div style="font-size:0.75rem;color:#64748b">${item.q}</div>
          <div style="font-size:0.88rem;font-weight:700;color:#e2e8f0">${item.answer}</div>
        </div>
        <button id="wg-mk-ans-${i}" onclick="WG.mkTapAnswer(${i})"
          style="font-size:1.2rem;background:none;border:2px dashed #334155;border-radius:8px;width:38px;height:38px;cursor:pointer;flex-shrink:0">
          â“
        </button>
      </div>`
    ).join('');
  },

  mkTapAnswer(i) {
    if (!this._mkPaper) return;
    // Cycle: null â†’ true (âœ…) â†’ false (âŒ) â†’ null
    const cur = this._mkMarked[i];
    this._mkMarked[i] = cur === null ? true : cur === true ? false : null;
    const btn = document.getElementById(`wg-mk-ans-${i}`);
    if (btn) btn.textContent = this._mkMarked[i] === true ? 'âœ…' : this._mkMarked[i] === false ? 'âŒ' : 'â“';

    // Show grade buttons once all 4 are marked
    const allMarked = this._mkMarked.every(m => m !== null);
    const gEl = document.getElementById('wg-mk-grade-btns');
    const hEl = document.getElementById('wg-mk-hint');
    if (gEl) gEl.style.opacity = allMarked ? '1' : '0.35';
    if (gEl) gEl.style.pointerEvents = allMarked ? 'auto' : 'none';
    if (hEl) hEl.textContent = allMarked ? 'Now give them a grade â€” A or F!' : 'Tap each answer to mark it first!';
  },

  mkGrade(grade) {
    if (!this._mkPaper) return;
    if (this._mkMarked.some(m => m === null)) return;

    // Count correctly marked answers
    let markScore = 0;
    for (let i = 0; i < 4; i++) {
      if (this._mkMarked[i] === this._mkPaper[i].correct) markScore++;
    }
    const correctCount = this._mkPaper.filter(a => a.correct).length;
    const correctGrade = correctCount >= 3 ? 'A' : 'F';
    const gradeOk = grade === correctGrade;
    const markOk  = markScore >= 3; // at least 3/4 marked correctly

    const bothOk = gradeOk && markOk;
    if (bothOk)        { this._mkEarned += 5; this._mkStars.push('â­'); }
    else if (gradeOk)  { this._mkEarned += 2; this._mkStars.push('âœ…'); }
    else               { this._mkStars.push('âŒ'); }

    // Reveal correct marks on the paper
    for (let i = 0; i < 4; i++) {
      const btn = document.getElementById(`wg-mk-ans-${i}`);
      if (btn) {
        const wasRight = this._mkMarked[i] === this._mkPaper[i].correct;
        btn.style.background = wasRight ? '#22c55e22' : '#ef444422';
        btn.textContent = this._mkPaper[i].correct ? 'âœ…' : 'âŒ';
      }
    }

    const hEl = document.getElementById('wg-mk-hint');
    const gEl = document.getElementById('wg-mk-grade-btns');
    if (gEl) gEl.style.pointerEvents = 'none';
    if (hEl) {
      hEl.textContent = bothOk
        ? `â­ Perfect! ${correctCount}/4 correct â†’ Grade ${correctGrade}`
        : gradeOk
        ? `âœ… Right grade! But check your marking (${markScore}/4 correct)`
        : `âŒ Should be Grade ${correctGrade} â€” ${correctCount}/4 answers right`;
      hEl.style.color = bothOk ? '#4ade80' : gradeOk ? '#fbbf24' : '#f87171';
    }

    const dEl = document.getElementById('wg-mk-done');
    const eEl = document.getElementById('wg-mk-earned');
    const sEl = document.getElementById('wg-mk-stars');
    if (dEl) dEl.textContent  = this._mkRound + 1;
    if (eEl) eEl.textContent  = this._mkEarned;
    if (sEl) sEl.textContent  = this._mkStars.join(' ');

    this._mkPaper = null;
    this._mkRound++;
    if (this._mkRound >= 5) setTimeout(() => this._mkFinish(), 1400);
    else setTimeout(() => this._mkNextPaper(), 1600);
  },

  _mkFinish() {
    const wd   = WD[this.worldType];
    this.currency += this._mkEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area  = document.getElementById('wg-mk-area');
    const hits  = this._mkStars.filter(s => s === 'â­').length;
    const trophy = hits === 5 ? 'ğŸ†' : hits >= 3 ? 'ğŸ¥‡' : hits >= 1 ? 'ğŸ¥ˆ' : 'ğŸ“';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Marking done!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._mkStars.join(' ')}</div>
        <div>${hits}/5 perfect papers &nbsp;Â·&nbsp; Earned <strong>${this._mkEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._startMarking()">ğŸ“ Mark more tests</button>
      </div>`;
  },

  // â”€â”€ Science Lab: Pouring Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _LAB_CHEMICALS: [
    {id:'acid_h',  label:'Hydrochloric Acid', abbr:'HCl',  col:'#fbbf24', textCol:'#000'},
    {id:'acid_s',  label:'Sulphuric Acid',    abbr:'Hâ‚‚SOâ‚„',col:'#f97316', textCol:'#fff'},
    {id:'base_n',  label:'Sodium Hydroxide',  abbr:'NaOH', col:'#3b82f6', textCol:'#fff'},
    {id:'acid_c',  label:'Citric Acid',       abbr:'Câ‚†Hâ‚ˆOâ‚‡',col:'#a3e635',textCol:'#000'},
    {id:'base_a',  label:'Ammonia',           abbr:'NHâ‚ƒ',  col:'#a78bfa', textCol:'#fff'},
    {id:'neut_w',  label:'Distilled Water',   abbr:'Hâ‚‚O',  col:'#7dd3fc', textCol:'#000'},
  ],
  _LAB_ROUNDS: [
    {beakers:[
      {label:'Turns yellow + bubbles',  chemical:'acid_h'},
      {label:'Gets very hot',           chemical:'acid_s'},
      {label:'Feels slippery',          chemical:'base_n'},
    ]},
    {beakers:[
      {label:'Smells sharp & tangy',    chemical:'acid_c'},
      {label:'Strong smell of cleaning',chemical:'base_a'},
      {label:'No reaction â€” stays clear',chemical:'neut_w'},
    ]},
    {beakers:[
      {label:'Fizzes with metal',       chemical:'acid_h'},
      {label:'Purple litmus turns red', chemical:'acid_s'},
      {label:'Purple litmus turns blue',chemical:'base_n'},
    ]},
    {beakers:[
      {label:'Found in lemons ğŸ‹',      chemical:'acid_c'},
      {label:'Used in cleaning sprays', chemical:'base_a'},
      {label:'Safe to drink ğŸ’§',        chemical:'neut_w'},
    ]},
    {beakers:[
      {label:'pH below 7 â€” very strong',chemical:'acid_s'},
      {label:'pH above 7 â€” strong base',chemical:'base_n'},
      {label:'pH = 7 â€” perfectly neutral',chemical:'neut_w'},
    ]},
  ],
  _labRound: 0, _labEarned: 0, _labStars: [],
  _labBeakers: [], _labSelected: null, _labPoured: {},
  _labRaf: null, _labLastT: 0, _labEffects: [],

  _startLab() {
    if (this._labRaf) { cancelAnimationFrame(this._labRaf); this._labRaf = null; }
    this._labRound   = 0;
    this._labEarned  = 0;
    this._labStars   = [];
    this._labEffects = [];
    this._labNextRound();
    this._labLastT = performance.now();
    const tick = (ts) => {
      if (!document.getElementById('wg-lab-canvas')) { this._labRaf = null; return; }
      const dt = Math.min((ts - this._labLastT) / 1000, 0.05);
      this._labLastT = ts;
      this._labDraw(dt);
      if (this._labRaf !== null) this._labRaf = requestAnimationFrame(tick);
    };
    this._labRaf = requestAnimationFrame(tick);
  },

  _labNextRound() {
    this._labSelected = null;
    this._labPoured   = {};
    const round = this._LAB_ROUNDS[this._labRound % this._LAB_ROUNDS.length];
    this._labBeakers  = round.beakers.map((b, i) => ({...b, x: 60 + i * 105, y: 50, filled: false}));

    // Render chemical buttons (shuffled)
    const shuffled = [...this._LAB_CHEMICALS].sort(() => Math.random() - 0.5);
    const btnsEl   = document.getElementById('wg-lab-chemicals');
    if (btnsEl) btnsEl.innerHTML = shuffled.map(c =>
      `<button id="lab-chem-${c.id}" class="btn btn-secondary"
        style="font-size:0.78rem;padding:6px 10px;border-left:4px solid ${c.col}"
        onclick="WG.labSelect('${c.id}')">
        <strong style="color:${c.col}">${c.abbr}</strong> ${c.label}
      </button>`
    ).join('');

    const rndEl = document.getElementById('wg-lab-round');
    if (rndEl) rndEl.textContent = this._labRound + 1;
    const instrEl = document.getElementById('wg-lab-instruction');
    if (instrEl) instrEl.textContent = 'Tap a chemical, then tap a beaker to pour it in!';
  },

  labSelect(chemId) {
    this._labSelected = chemId;
    // Highlight selected
    document.querySelectorAll('[id^="lab-chem-"]').forEach(b => b.style.outline = '');
    const btn = document.getElementById(`lab-chem-${chemId}`);
    if (btn) btn.style.outline = '3px solid #22c55e';
    const chem = this._LAB_CHEMICALS.find(c => c.id === chemId);
    const instrEl = document.getElementById('wg-lab-instruction');
    if (instrEl && chem) instrEl.textContent = `"${chem.label}" selected â€” tap a beaker!`;
  },

  _labDraw(dt) {
    // Fade effects
    this._labEffects = this._labEffects.filter(e => e.t > 0);
    for (const e of this._labEffects) e.t -= dt;

    const canvas = document.getElementById('wg-lab-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = 320, H = 160;

    // Lab bench background
    ctx.fillStyle = '#1e293b';
    ctx.fillRect(0, 0, W, H);
    ctx.fillStyle = '#334155';
    ctx.fillRect(0, H - 28, W, 28);
    ctx.fillStyle = '#475569';
    ctx.fillRect(0, H - 32, W, 4);

    // Draw beakers
    const chems = this._LAB_CHEMICALS;
    for (const b of this._labBeakers) {
      const bx = b.x, by = b.y;
      const filledChem = b.filled ? chems.find(c => c.id === this._labPoured[this._labBeakers.indexOf(b)]) : null;

      // Beaker body (trapezoid)
      ctx.fillStyle = 'rgba(150,200,255,0.15)';
      ctx.beginPath();
      ctx.moveTo(bx - 22, by);
      ctx.lineTo(bx + 22, by);
      ctx.lineTo(bx + 18, by + 70);
      ctx.lineTo(bx - 18, by + 70);
      ctx.closePath();
      ctx.fill();

      // Liquid inside (if poured)
      if (b.filled && filledChem) {
        ctx.fillStyle = filledChem.col + 'bb';
        ctx.beginPath();
        ctx.moveTo(bx - 16, by + 30);
        ctx.lineTo(bx + 16, by + 30);
        ctx.lineTo(bx + 14, by + 65);
        ctx.lineTo(bx - 14, by + 65);
        ctx.closePath();
        ctx.fill();
        // Bubbles
        ctx.fillStyle = 'rgba(255,255,255,0.4)';
        for (let i = 0; i < 3; i++) {
          const bxp = bx - 10 + i * 10 + Math.sin(Date.now()/400 + i) * 3;
          const byp = by + 50 + Math.sin(Date.now()/300 + i * 1.5) * 8;
          ctx.beginPath(); ctx.arc(bxp, byp, 2.5, 0, Math.PI*2); ctx.fill();
        }
        // Label inside
        ctx.font = 'bold 9px sans-serif'; ctx.fillStyle = filledChem.textCol;
        ctx.textAlign = 'center'; ctx.fillText(filledChem.abbr, bx, by + 52);
      }

      // Beaker outline
      ctx.strokeStyle = b.filled ? '#4ade80' : 'rgba(150,200,255,0.6)';
      ctx.lineWidth = b.filled ? 2 : 1.5;
      ctx.beginPath();
      ctx.moveTo(bx - 22, by);
      ctx.lineTo(bx + 22, by);
      ctx.lineTo(bx + 18, by + 70);
      ctx.lineTo(bx - 18, by + 70);
      ctx.closePath();
      ctx.stroke();
      // Spout
      ctx.beginPath(); ctx.moveTo(bx + 18, by + 5); ctx.lineTo(bx + 26, by - 4); ctx.stroke();

      // Beaker label below
      ctx.font = '8px sans-serif'; ctx.fillStyle = '#94a3b8'; ctx.textAlign = 'center';
      const words = b.label.split(' ');
      let line = '', lineY = by + 80;
      for (const w of words) {
        const test = line + w + ' ';
        if (ctx.measureText(test).width > 52 && line) { ctx.fillText(line.trim(), bx, lineY); line = w + ' '; lineY += 10; }
        else line = test;
      }
      ctx.fillText(line.trim(), bx, lineY);

      // Click zone highlight
      if (this._labSelected && !b.filled) {
        ctx.strokeStyle = 'rgba(251,191,36,0.6)'; ctx.lineWidth = 2;
        ctx.setLineDash([4,4]);
        ctx.beginPath();
        ctx.moveTo(bx - 22, by); ctx.lineTo(bx + 22, by);
        ctx.lineTo(bx + 18, by + 70); ctx.lineTo(bx - 18, by + 70);
        ctx.closePath(); ctx.stroke();
        ctx.setLineDash([]);
      }
    }

    // Pour effects
    for (const ef of this._labEffects) {
      const alpha = Math.min(1, ef.t * 2);
      ctx.globalAlpha = alpha;
      ctx.font = 'bold 13px sans-serif'; ctx.fillStyle = ef.ok ? '#4ade80' : '#f87171';
      ctx.textAlign = 'center';
      ctx.fillText(ef.text, ef.x, ef.y - (1 - ef.t) * 20);
    }
    ctx.globalAlpha = 1;
  },

  labCanvasTap(e) {
    const canvas = document.getElementById('wg-lab-canvas');
    if (!canvas) return;
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (320 / rect.width);
    const my = (e.clientY - rect.top)  * (160 / rect.height);
    for (let i = 0; i < this._labBeakers.length; i++) {
      const b = this._labBeakers[i];
      if (mx >= b.x - 24 && mx <= b.x + 24 && my >= b.y && my <= b.y + 72) {
        this.labPour(i); return;
      }
    }
  },

  labPour(beakerIdx) {
    if (!this._labSelected) return;
    const b    = this._labBeakers[beakerIdx];
    if (!b || b.filled) return;
    const ok   = this._labSelected === b.chemical;
    b.filled   = true;
    this._labPoured[beakerIdx] = this._labSelected;
    this._labEffects.push({x: b.x, y: b.y - 10, t: 0.9, ok, text: ok ? 'âœ… Correct!' : 'âŒ Wrong!'});

    if (ok) {
      this._labEarned += 3;
      this._labStars.push('â­');
    } else {
      this._labStars.push('âŒ');
    }

    // Deselect
    this._labSelected = null;
    document.querySelectorAll('[id^="lab-chem-"]').forEach(b => b.style.outline = '');

    const eEl = document.getElementById('wg-lab-earned');
    const sEl = document.getElementById('wg-lab-stars');
    if (eEl) eEl.textContent = this._labEarned;
    if (sEl) sEl.textContent = this._labStars.join(' ');

    const instrEl = document.getElementById('wg-lab-instruction');

    // Check if all beakers filled
    if (this._labBeakers.every(b => b.filled)) {
      this._labRound++;
      if (instrEl) instrEl.textContent = 'âœ… Round done!';
      if (this._labRound >= 5) setTimeout(() => this._labFinish(), 900);
      else setTimeout(() => this._labNextRound(), 1100);
    } else {
      if (instrEl) instrEl.textContent = 'Tap a chemical, then tap a beaker!';
    }
  },

  _labFinish() {
    if (this._labRaf) { cancelAnimationFrame(this._labRaf); this._labRaf = null; }
    const wd   = WD[this.worldType];
    this.currency += this._labEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area  = document.getElementById('wg-lab-area');
    const hits  = this._labStars.filter(s => s === 'â­').length;
    const total = this._labStars.length;
    const trophy = hits === total ? 'ğŸ†' : hits >= total * 0.7 ? 'ğŸ¥‡' : hits >= total * 0.4 ? 'ğŸ¥ˆ' : 'ğŸ§ª';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Experiment complete!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._labStars.join(' ')}</div>
        <div>${hits}/${total} correct pours &nbsp;Â·&nbsp; Earned <strong>${this._labEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._startLab()">ğŸ§ª New experiment</button>
      </div>`;
  },

  // â”€â”€ Library: Book Shelving Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _LB_BOOKS: [
    {e:'ğŸ”­', title:'Stars & Galaxies',        clue:'All about outer space and planets',     shelf:'science'},
    {e:'âš—ï¸', title:'Chemistry for Beginners',  clue:'Elements, reactions and experiments',   shelf:'science'},
    {e:'ğŸ§¬', title:'The DNA Handbook',         clue:'How living things are built',           shelf:'science'},
    {e:'âš¡', title:'Electricity Explained',    clue:'Circuits, volts and how power works',   shelf:'science'},
    {e:'ğŸ°', title:'Knights & Castles',        clue:'Life in medieval times',                shelf:'history'},
    {e:'ğŸ—ºï¸', title:'Ancient Egypt',            clue:'Pharaohs, pyramids and mummies',        shelf:'history'},
    {e:'ğŸš€', title:'The Space Race',           clue:'The cold war battle to reach the Moon', shelf:'history'},
    {e:'âš”ï¸', title:'World War Stories',        clue:'Events of the great world wars',        shelf:'history'},
    {e:'ğŸ¦', title:'Big Cats of Africa',       clue:'Lions, leopards and their habitats',    shelf:'nature'},
    {e:'ğŸŒŠ', title:'Ocean Life',               clue:'Creatures of the deep sea',             shelf:'nature'},
    {e:'ğŸŒ³', title:'Rainforests',              clue:'Tropical jungles and biodiversity',     shelf:'nature'},
    {e:'ğŸ¦‹', title:'Insects & Bugs',           clue:'The world of tiny creatures',           shelf:'nature'},
    {e:'ğŸ‰', title:'The Dragon Chronicles',    clue:'A fantasy adventure with dragons',      shelf:'stories'},
    {e:'ğŸ§™', title:'The Wizard\'s Apprentice', clue:'A young mage learning magic spells',    shelf:'stories'},
    {e:'ğŸ´â€â˜ ï¸',title:'Pirate\'s Treasure',       clue:'A swashbuckling sea adventure',        shelf:'stories'},
    {e:'ğŸ¤–', title:'Robot Friends',            clue:'A sci-fi tale about helpful robots',    shelf:'stories'},
    {e:'ğŸ“', title:'Geometry Fun',             clue:'Shapes, angles and spatial thinking',   shelf:'maths'},
    {e:'â—', title:'Fractions Made Easy',      clue:'Understanding parts of a whole',        shelf:'maths'},
    {e:'ğŸ“Š', title:'Statistics for Kids',      clue:'Charts, data and probability',          shelf:'maths'},
    {e:'â™¾ï¸', title:'The World of Numbers',     clue:'Patterns, primes and infinity',         shelf:'maths'},
    {e:'ğŸ¨', title:'Famous Painters',          clue:'Monet, Picasso and their masterworks',  shelf:'art'},
    {e:'ğŸµ', title:'How Music Works',          clue:'Notes, scales, rhythm and melody',      shelf:'art'},
    {e:'ğŸ–Œï¸', title:'Draw Anything',            clue:'Techniques for sketching and colouring',shelf:'art'},
    {e:'ğŸ­', title:'Theatre & Drama',          clue:'Acting, stagecraft and performance',    shelf:'art'},
  ],
  _lbRound: 0, _lbEarned: 0, _lbStars: [], _lbPool: [], _lbAnswered: false,

  _startLibrary() {
    this._lbRound    = 0;
    this._lbEarned   = 0;
    this._lbStars    = [];
    this._lbAnswered = false;
    this._lbPool     = [...this._LB_BOOKS].sort(() => Math.random() - 0.5);
    this._lbShow();
  },

  _lbShow() {
    this._lbAnswered = false;
    const book   = this._lbPool[this._lbRound % this._lbPool.length];
    const bookEl = document.getElementById('wg-lb-book');
    const titEl  = document.getElementById('wg-lb-title');
    const cluEl  = document.getElementById('wg-lb-clue');
    const rndEl  = document.getElementById('wg-lb-round');
    const repEl  = document.getElementById('wg-lb-reply');
    if (bookEl) bookEl.textContent = book.e;
    if (titEl)  titEl.textContent  = book.title;
    if (cluEl)  cluEl.textContent  = book.clue;
    if (rndEl)  rndEl.textContent  = this._lbRound + 1;
    if (repEl)  repEl.textContent  = '';
    // Reset shelf buttons
    document.querySelectorAll('#wg-lb-shelves button').forEach(b => {
      b.style.background = ''; b.style.color = ''; b.style.pointerEvents = 'auto';
    });
  },

  lbShelve(shelf) {
    if (this._lbAnswered) return;
    this._lbAnswered = true;
    const book  = this._lbPool[this._lbRound % this._lbPool.length];
    const ok    = shelf === book.shelf;
    const repEl = document.getElementById('wg-lb-reply');
    const labels = {science:'ğŸ”¬ Science', history:'ğŸ“œ History', nature:'ğŸŒ¿ Nature', stories:'âœ¨ Stories', maths:'ğŸ”¢ Maths', art:'ğŸ¨ Art & Music'};

    document.querySelectorAll('#wg-lb-shelves button').forEach(b => {
      b.style.pointerEvents = 'none';
      const bShelf = b.getAttribute('onclick').match(/'(\w+)'/)[1];
      if (bShelf === shelf)       { b.style.background = ok ? '#22c55e' : '#ef4444'; b.style.color = '#fff'; }
      if (!ok && bShelf === book.shelf) { b.style.background = '#22c55e'; b.style.color = '#fff'; }
    });

    if (ok) {
      this._lbEarned += 4;
      this._lbStars.push('ğŸ“š');
      if (repEl) { repEl.textContent = `âœ… Shelved in ${labels[shelf]}!`; repEl.style.color = '#4ade80'; }
    } else {
      this._lbStars.push('âŒ');
      if (repEl) { repEl.textContent = `âŒ That belongs in ${labels[book.shelf]}`; repEl.style.color = '#f87171'; }
    }

    const eEl = document.getElementById('wg-lb-earned');
    const sEl = document.getElementById('wg-lb-stars');
    if (eEl) eEl.textContent = this._lbEarned;
    if (sEl) sEl.textContent = this._lbStars.join(' ');

    this._lbRound++;
    if (this._lbRound >= 7) setTimeout(() => this._lbFinish(), 1100);
    else setTimeout(() => this._lbShow(), 1300);
  },

  _lbFinish() {
    const wd   = WD[this.worldType];
    this.currency += this._lbEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area  = document.getElementById('wg-lb-area');
    const hits  = this._lbStars.filter(s => s === 'ğŸ“š').length;
    const trophy = hits === 7 ? 'ğŸ†' : hits >= 5 ? 'ğŸ¥‡' : hits >= 3 ? 'ğŸ¥ˆ' : 'ğŸ“–';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Library sorted!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._lbStars.join(' ')}</div>
        <div>${hits}/7 correctly shelved &nbsp;Â·&nbsp; Earned <strong>${this._lbEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._startLibrary()">ğŸ“š Shelve more books</button>
      </div>`;
  },

  // â”€â”€ School: Quiz Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _QZ_QUESTIONS: [
    {s:'ğŸ”¢ Maths',      q:'What is 8 Ã— 7?',                          a:'56',  w:['48','54','63']},
    {s:'ğŸ”¢ Maths',      q:'What is 144 Ã· 12?',                       a:'12',  w:['11','13','14']},
    {s:'ğŸ”¢ Maths',      q:'What is 25% of 80?',                      a:'20',  w:['15','25','40']},
    {s:'ğŸ”¢ Maths',      q:'What is 9Â²?',                             a:'81',  w:['72','90','63']},
    {s:'ğŸ”¢ Maths',      q:'How many sides does a hexagon have?',      a:'6',   w:['5','7','8']},
    {s:'ğŸ”¢ Maths',      q:'What is the next prime after 7?',         a:'11',  w:['8','9','10']},
    {s:'ğŸŒ Geography',  q:'What is the capital of France?',          a:'Paris',w:['Lyon','Rome','Madrid']},
    {s:'ğŸŒ Geography',  q:'Which is the longest river in the world?', a:'Nile', w:['Amazon','Yangtze','Mississippi']},
    {s:'ğŸŒ Geography',  q:'What is the smallest country in the world?',a:'Vatican City',w:['Monaco','San Marino','Liechtenstein']},
    {s:'ğŸŒ Geography',  q:'On which continent is Egypt?',            a:'Africa',w:['Asia','Europe','South America']},
    {s:'ğŸŒ Geography',  q:'What is the capital of Japan?',           a:'Tokyo', w:['Osaka','Kyoto','Hiroshima']},
    {s:'ğŸ”¬ Science',    q:'What gas do plants absorb?',              a:'Carbon dioxide', w:['Oxygen','Nitrogen','Hydrogen']},
    {s:'ğŸ”¬ Science',    q:'How many bones are in the adult human body?',a:'206',w:['156','246','186']},
    {s:'ğŸ”¬ Science',    q:'What planet is closest to the Sun?',      a:'Mercury',w:['Venus','Earth','Mars']},
    {s:'ğŸ”¬ Science',    q:'What is the chemical symbol for water?',  a:'Hâ‚‚O', w:['COâ‚‚','Oâ‚‚','Hâ‚‚']},
    {s:'ğŸ”¬ Science',    q:'What force keeps us on the ground?',      a:'Gravity',w:['Magnetism','Friction','Inertia']},
    {s:'ğŸ“œ History',    q:'In what year did World War II end?',      a:'1945', w:['1939','1942','1918']},
    {s:'ğŸ“œ History',    q:'Who was the first person on the Moon?',   a:'Neil Armstrong',w:['Buzz Aldrin','Yuri Gagarin','John Glenn']},
    {s:'ğŸ“œ History',    q:'Which ancient wonder was in Egypt?',      a:'Great Pyramid',w:['Colossus','Lighthouse','Hanging Gardens']},
    {s:'ğŸ“œ History',    q:'Who painted the Mona Lisa?',             a:'Leonardo da Vinci',w:['Michelangelo','Raphael','Picasso']},
    {s:'ğŸŒ English',    q:'What is a synonym for "happy"?',          a:'Joyful',w:['Sad','Angry','Tired']},
    {s:'ğŸŒ English',    q:'What type of word is "quickly"?',         a:'Adverb',w:['Noun','Verb','Adjective']},
    {s:'ğŸŒ English',    q:'How many letters in the English alphabet?',a:'26',  w:['24','25','28']},
  ],
  _qzRound: 0, _qzEarned: 0, _qzStars: [], _qzPool: [], _qzAnswered: false,

  _startQuiz() {
    this._qzRound    = 0;
    this._qzEarned   = 0;
    this._qzStars    = [];
    this._qzAnswered = false;
    this._qzPool     = [...this._QZ_QUESTIONS].sort(() => Math.random() - 0.5);
    this._qzShow();
  },

  _qzShow() {
    this._qzAnswered = false;
    const q      = this._qzPool[this._qzRound % this._qzPool.length];
    const opts   = [q.a, ...q.w].sort(() => Math.random() - 0.5);
    const subEl  = document.getElementById('wg-qz-subject');
    const qEl    = document.getElementById('wg-qz-question');
    const btnsEl = document.getElementById('wg-qz-btns');
    const rndEl  = document.getElementById('wg-qz-round');
    const repEl  = document.getElementById('wg-qz-reply');
    if (subEl)  subEl.textContent  = q.s;
    if (qEl)    qEl.textContent    = q.q;
    if (rndEl)  rndEl.textContent  = this._qzRound + 1;
    if (repEl)  repEl.textContent  = '';
    if (btnsEl) btnsEl.innerHTML   = opts.map(o =>
      `<button class="btn btn-secondary" style="text-align:left;font-size:0.9rem;padding:10px 14px"
        onclick="WG.qzAnswer('${o.replace(/'/g,"\\'").replace(/"/g,'&quot;')}','${q.a.replace(/'/g,"\\'").replace(/"/g,'&quot;')}')">
        ${o}
      </button>`
    ).join('');
  },

  qzAnswer(chosen, correct) {
    if (this._qzAnswered) return;
    this._qzAnswered = true;
    const ok    = chosen === correct;
    const repEl = document.getElementById('wg-qz-reply');
    document.querySelectorAll('#wg-qz-btns button').forEach(b => {
      b.style.pointerEvents = 'none';
      const bText = b.textContent.trim();
      if (bText === correct) { b.style.background = '#22c55e'; b.style.color = '#fff'; }
      else if (bText === chosen && !ok) { b.style.background = '#ef4444'; b.style.color = '#fff'; }
    });
    if (ok) {
      this._qzEarned += 4;
      this._qzStars.push('â­');
      if (repEl) { repEl.textContent = 'âœ… Correct!'; repEl.style.color = '#4ade80'; }
    } else {
      this._qzStars.push('âŒ');
      if (repEl) { repEl.textContent = `âŒ The answer was: ${correct}`; repEl.style.color = '#f87171'; }
    }
    const eEl = document.getElementById('wg-qz-earned');
    const sEl = document.getElementById('wg-qz-stars');
    if (eEl) eEl.textContent = this._qzEarned;
    if (sEl) sEl.textContent = this._qzStars.join(' ');
    this._qzRound++;
    if (this._qzRound >= 6) setTimeout(() => this._qzFinish(), 1300);
    else setTimeout(() => this._qzShow(), 1500);
  },

  _qzFinish() {
    const wd   = WD[this.worldType];
    this.currency += this._qzEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area  = document.getElementById('wg-qz-area');
    const hits  = this._qzStars.filter(s => s === 'â­').length;
    const trophy = hits === 6 ? 'ğŸ†' : hits >= 4 ? 'ğŸ¥‡' : hits >= 2 ? 'ğŸ¥ˆ' : 'ğŸ“';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Class dismissed!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._qzStars.join(' ')}</div>
        <div>${hits}/6 correct &nbsp;Â·&nbsp; Earned <strong>${this._qzEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._startQuiz()">ğŸ“ New questions</button>
      </div>`;
  },

  // â”€â”€ Training Ground: Coach Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _TR_ACTIVITIES: [
    {id:'sprint', e:'ğŸƒ', label:'Sprint',   trains:'Speed'},
    {id:'lift',   e:'ğŸ‹ï¸', label:'Lift',     trains:'Strength'},
    {id:'stretch',e:'ğŸ¤¸', label:'Stretch',  trains:'Flexibility'},
    {id:'cycle',  e:'ğŸš´', label:'Cycle',    trains:'Endurance'},
    {id:'drill',  e:'âš½', label:'Drill',    trains:'Skill'},
    {id:'swim',   e:'ğŸŠ', label:'Swim',     trains:'Recovery'},
  ],
  _TR_TRAINEES: [
    {e:'ğŸ§‘', name:'Sprinter Kenji',   desc:'Wants to run faster',         goals:['Speed','Endurance','Skill']},
    {e:'ğŸ‘©', name:'Rookie Dana',      desc:'Just starting out',           goals:['Strength','Flexibility','Recovery']},
    {e:'ğŸ’ª', name:'Champion Mia',     desc:'Training for competition',    goals:['Speed','Strength','Endurance']},
    {e:'ğŸ§“', name:'Comeback Luis',    desc:'Getting back into shape',     goals:['Flexibility','Recovery','Strength']},
    {e:'ğŸ§’', name:'Young Sam',        desc:'Wants to play better sport',  goals:['Speed','Skill','Flexibility']},
    {e:'ğŸƒ', name:'Runner Priya',     desc:'Marathon prep',               goals:['Endurance','Recovery','Skill']},
  ],
  _trRound: 0, _trEarned: 0, _trStars: [],
  _trTrainee: null, _trDone: [],

  _startTraining() {
    this._trRound   = 0;
    this._trEarned  = 0;
    this._trStars   = [];
    this._trTrainee = null;
    this._trDone    = [];
    const pool = [...this._TR_TRAINEES].sort(() => Math.random() - 0.5);
    this._trPool = pool;
    this._trNext();
  },

  _trNext() {
    this._trDone    = [];
    const trainee   = this._trPool[this._trRound % this._trPool.length];
    this._trTrainee = trainee;

    const pEl = document.getElementById('wg-tr-person');
    const nEl = document.getElementById('wg-tr-name');
    const dEl = document.getElementById('wg-tr-desc');
    const gEl = document.getElementById('wg-tr-goals');
    const rEl = document.getElementById('wg-tr-round');
    if (pEl) pEl.textContent = trainee.e;
    if (nEl) nEl.textContent = trainee.name;
    if (dEl) dEl.textContent = trainee.desc;
    if (rEl) rEl.textContent = this._trRound + 1;
    if (gEl) gEl.innerHTML = trainee.goals.map(g =>
      `<span id="wg-tr-goal-${g}" style="background:#1e293b;border-radius:6px;padding:4px 10px;font-size:0.82rem;font-weight:700">${g}</span>`
    ).join('');

    // Show 6 shuffled activity buttons
    const btnsEl = document.getElementById('wg-tr-btns');
    const shuffled = [...this._TR_ACTIVITIES].sort(() => Math.random() - 0.5);
    if (btnsEl) btnsEl.innerHTML = shuffled.map(a =>
      `<button id="wg-tr-btn-${a.id}" class="btn btn-secondary"
        style="font-size:0.82rem;padding:10px 4px;display:flex;flex-direction:column;align-items:center;gap:3px"
        onclick="WG.trDrill('${a.id}','${a.trains}')">
        <span style="font-size:1.4rem">${a.e}</span>${a.label}
      </button>`
    ).join('');
  },

  trDrill(actId, trains) {
    if (!this._trTrainee) return;
    const btn = document.getElementById(`wg-tr-btn-${actId}`);
    if (btn && btn.disabled) return;

    const correct = this._trTrainee.goals.includes(trains);
    if (btn) { btn.disabled = true; btn.style.pointerEvents = 'none'; }

    if (correct && !this._trDone.includes(trains)) {
      this._trDone.push(trains);
      this._trEarned += 3;
      if (btn) { btn.style.background = '#22c55e'; btn.style.color = '#fff'; }
      const goalEl = document.getElementById(`wg-tr-goal-${trains}`);
      if (goalEl) { goalEl.style.background = '#22c55e'; goalEl.style.color = '#fff'; goalEl.textContent = 'âœ“ ' + trains; }

      if (this._trDone.length === this._trTrainee.goals.length) {
        // All goals matched
        this._trStars.push('â­');
        const eEl = document.getElementById('wg-tr-earned');
        const sEl = document.getElementById('wg-tr-stars');
        if (eEl) eEl.textContent = this._trEarned;
        if (sEl) sEl.textContent = this._trStars.join(' ');
        this._trRound++;
        if (this._trRound >= 5) setTimeout(() => this._trFinish(), 700);
        else setTimeout(() => this._trNext(), 900);
      }
    } else if (!correct) {
      // Wrong activity
      if (btn) {
        btn.style.background = '#ef4444'; btn.style.color = '#fff';
        setTimeout(() => { if (btn) { btn.style.background = ''; btn.style.color = ''; btn.disabled = false; btn.style.pointerEvents = 'auto'; } }, 600);
      }
      this._trStars.push('âŒ');
      const sEl = document.getElementById('wg-tr-stars');
      if (sEl) sEl.textContent = this._trStars.join(' ');
      // Move on after wrong tap
      this._trRound++;
      if (this._trRound >= 5) setTimeout(() => this._trFinish(), 700);
      else setTimeout(() => this._trNext(), 900);
    }

    const eEl = document.getElementById('wg-tr-earned');
    if (eEl) eEl.textContent = this._trEarned;
  },

  _trFinish() {
    const wd   = WD[this.worldType];
    this.currency += this._trEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area  = document.getElementById('wg-tr-area');
    const hits  = this._trStars.filter(s => s === 'â­').length;
    const trophy = hits === 5 ? 'ğŸ†' : hits >= 3 ? 'ğŸ¥‡' : hits >= 1 ? 'ğŸ¥ˆ' : 'ğŸ’ª';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Training session done!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._trStars.join(' ')}</div>
        <div>${hits}/5 trainees fully trained &nbsp;Â·&nbsp; Earned <strong>${this._trEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._startTraining()">ğŸƒ New trainees</button>
      </div>`;
  },

  // â”€â”€ Gym: Power Setting Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _GYM_PEOPLE: [
    {e:'ğŸ§“', name:'Elderly Margaret', desc:'Gentle recovery walk',     min:8,  max:28, speed:32},
    {e:'ğŸ§’', name:'Young Sam',        desc:'Light activity session',   min:20, max:42, speed:38},
    {e:'ğŸ‘©', name:'Casual Priya',     desc:'Moderate cardio workout',  min:38, max:58, speed:45},
    {e:'ğŸƒ', name:'Runner Jake',      desc:'Steady long-distance run', min:55, max:72, speed:52},
    {e:'ğŸ’ª', name:'Athlete Zara',     desc:'Intense interval training',min:68, max:85, speed:60},
    {e:'ğŸ‹ï¸', name:'Lifter Bruno',    desc:'Max power strength set',   min:80, max:96, speed:68},
  ],
  _gymRound: 0, _gymEarned: 0, _gymStars: [],
  _gymSpeed: 0,  // 0â€“100 current cursor position
  _gymDir: 1, _gymPerson: null, _gymLocked: false,
  _gymLockedAt: null, _gymEffect: null,
  _gymRaf: null, _gymLastT: 0,

  _startGym() {
    if (this._gymRaf) { cancelAnimationFrame(this._gymRaf); this._gymRaf = null; }
    this._gymRound   = 0;
    this._gymEarned  = 0;
    this._gymStars   = [];
    this._gymSpeed   = 0;
    this._gymDir     = 1;
    this._gymLocked  = false;
    this._gymLockedAt= null;
    this._gymEffect  = null;
    this._gymLastT   = performance.now();
    this._gymNextPerson();
    const tick = (ts) => {
      if (!document.getElementById('wg-gym-canvas')) { this._gymRaf = null; return; }
      const dt = Math.min((ts - this._gymLastT) / 1000, 0.05);
      this._gymLastT = ts;
      this._gymDraw(dt);
      if (this._gymRaf !== null) this._gymRaf = requestAnimationFrame(tick);
    };
    this._gymRaf = requestAnimationFrame(tick);
  },

  _gymNextPerson() {
    this._gymLocked   = false;
    this._gymLockedAt = null;
    this._gymEffect   = null;
    const pool = [...this._GYM_PEOPLE].sort(() => Math.random() - 0.5);
    this._gymPerson = pool[this._gymRound % pool.length];
    this._gymSpeed  = Math.random() * 30; // start cursor low
    const btn = document.getElementById('wg-gym-btn');
    if (btn) { btn.disabled = false; btn.textContent = 'âš¡ Set Power!'; btn.style.opacity = '1'; }
    const rEl = document.getElementById('wg-gym-round');
    if (rEl) rEl.textContent = this._gymRound + 1;
  },

  _gymDraw(dt) {
    const p = this._gymPerson;
    if (!p) return;

    // Move speed cursor (sweeps back and forth, faster for harder people)
    if (!this._gymLocked) {
      this._gymSpeed += this._gymDir * p.speed * dt;
      if (this._gymSpeed >= 100) { this._gymSpeed = 100; this._gymDir = -1; }
      if (this._gymSpeed <= 0)   { this._gymSpeed = 0;   this._gymDir =  1; }
    }

    if (this._gymEffect) this._gymEffect.t -= dt;

    const canvas = document.getElementById('wg-gym-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = 320, H = 180;

    // Gym background
    ctx.fillStyle = '#1e293b';
    ctx.fillRect(0, 0, W, H);
    // Floor
    ctx.fillStyle = '#334155';
    ctx.fillRect(0, H - 30, W, 30);

    // Treadmill machine
    const mx = 160, my = 100;
    ctx.fillStyle = '#475569';
    ctx.beginPath(); ctx.roundRect(mx - 55, my - 20, 110, 50, 8); ctx.fill();
    ctx.fillStyle = '#1e40af';
    ctx.fillRect(mx - 48, my - 12, 96, 10); // belt
    // Belt motion lines
    const beltOffset = (Date.now() / 80) % 16;
    ctx.strokeStyle = '#3b82f6'; ctx.lineWidth = 2;
    for (let bx = mx - 48 + beltOffset; bx < mx + 48; bx += 16) {
      ctx.beginPath(); ctx.moveTo(bx, my - 12); ctx.lineTo(bx, my - 2); ctx.stroke();
    }
    ctx.fillStyle = '#64748b';
    ctx.fillRect(mx - 48, my + 4, 96, 18); // base
    // Handles
    ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 4;
    ctx.beginPath(); ctx.moveTo(mx - 30, my - 20); ctx.lineTo(mx - 30, my - 45); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(mx + 30, my - 20); ctx.lineTo(mx + 30, my - 45); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(mx - 30, my - 45); ctx.lineTo(mx + 30, my - 45); ctx.stroke();

    // Screen on machine showing speed
    ctx.fillStyle = '#0f172a';
    ctx.fillRect(mx - 22, my - 43, 44, 20);
    ctx.font = 'bold 12px monospace'; ctx.fillStyle = '#22c55e'; ctx.textAlign = 'center';
    ctx.fillText(Math.round(this._gymSpeed), mx, my - 27);

    // Person on treadmill
    ctx.font = '28px serif'; ctx.textAlign = 'center';
    ctx.fillText(p.e, mx, my - 52);

    // Power meter bar (bottom section)
    const barX = 20, barY = H - 58, barW = W - 40, barH = 18;
    // Background zones
    // Too slow (blue), perfect (green), too fast (red)
    const minP = p.min / 100, maxP = p.max / 100;
    ctx.fillStyle = '#1d4ed8'; ctx.fillRect(barX, barY, barW * minP, barH);                     // too slow
    ctx.fillStyle = '#16a34a'; ctx.fillRect(barX + barW * minP, barY, barW * (maxP - minP), barH); // perfect
    ctx.fillStyle = '#dc2626'; ctx.fillRect(barX + barW * maxP, barY, barW * (1 - maxP), barH);  // too fast
    // Bar border
    ctx.strokeStyle = '#94a3b8'; ctx.lineWidth = 1.5;
    ctx.strokeRect(barX, barY, barW, barH);
    // Zone labels
    ctx.font = '9px sans-serif'; ctx.fillStyle = '#e2e8f0';
    ctx.textAlign = 'left';  ctx.fillText('TOO SLOW', barX + 3, barY + 12);
    ctx.textAlign = 'center'; ctx.fillText('PERFECT', barX + barW * ((minP + maxP) / 2), barY + 12);
    ctx.textAlign = 'right';  ctx.fillText('TOO FAST', barX + barW - 3, barY + 12);

    // Cursor needle
    const needleX = barX + (this._gymSpeed / 100) * barW;
    ctx.fillStyle = '#fbbf24';
    ctx.beginPath(); ctx.moveTo(needleX, barY - 8); ctx.lineTo(needleX - 6, barY - 18); ctx.lineTo(needleX + 6, barY - 18); ctx.closePath(); ctx.fill();
    ctx.fillRect(needleX - 2, barY, 4, barH);

    // Person label
    ctx.textAlign = 'left'; ctx.font = 'bold 11px sans-serif'; ctx.fillStyle = '#e2e8f0';
    ctx.fillText(`${p.name} â€” ${p.desc}`, 20, H - 68);

    // Effect
    if (this._gymEffect && this._gymEffect.t > 0) {
      ctx.globalAlpha = Math.min(1, this._gymEffect.t * 2);
      ctx.font = 'bold 15px sans-serif'; ctx.textAlign = 'center';
      ctx.fillStyle = this._gymEffect.ok ? '#4ade80' : '#f87171';
      ctx.fillText(this._gymEffect.text, W / 2, 30);
      ctx.globalAlpha = 1;
    }

    // Locked indicator
    if (this._gymLocked && this._gymLockedAt !== null) {
      const lx = barX + (this._gymLockedAt / 100) * barW;
      ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 2;
      ctx.setLineDash([3, 3]);
      ctx.beginPath(); ctx.moveTo(lx, barY); ctx.lineTo(lx, barY + barH); ctx.stroke();
      ctx.setLineDash([]);
    }

    // Update HUD
    const eEl = document.getElementById('wg-gym-earned');
    const sEl = document.getElementById('wg-gym-stars');
    if (eEl) eEl.textContent = this._gymEarned;
    if (sEl) sEl.textContent = this._gymStars.join(' ');
  },

  gymSet() {
    if (this._gymLocked || !this._gymPerson) return;
    this._gymLocked   = true;
    this._gymLockedAt = this._gymSpeed;
    const p  = this._gymPerson;
    const ok = this._gymSpeed >= p.min && this._gymSpeed <= p.max;
    const perfect = ok && Math.abs(this._gymSpeed - (p.min + p.max) / 2) < (p.max - p.min) * 0.25;
    const earn = perfect ? 5 : ok ? 3 : 0;
    this._gymEarned += earn;
    if (perfect) this._gymStars.push('â­');
    else if (ok) this._gymStars.push('âœ…');
    else         this._gymStars.push('âŒ');
    this._gymEffect = {
      text: perfect ? 'â­ Perfect speed!' : ok ? 'âœ… Good match!' : this._gymSpeed < p.min ? 'âŒ Too slow!' : 'âŒ Too fast!',
      t: 1.4, ok: ok
    };
    const btn = document.getElementById('wg-gym-btn');
    if (btn) { btn.disabled = true; btn.style.opacity = '0.5'; }
    this._gymRound++;
    if (this._gymRound >= 5) setTimeout(() => this._gymFinish(), 1400);
    else setTimeout(() => this._gymNextPerson(), 1500);
  },

  _gymFinish() {
    if (this._gymRaf) { cancelAnimationFrame(this._gymRaf); this._gymRaf = null; }
    const wd   = WD[this.worldType];
    this.currency += this._gymEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area   = document.getElementById('wg-gym-area');
    const hits   = this._gymStars.filter(s => s !== 'âŒ').length;
    const trophy = hits === 5 ? 'ğŸ†' : hits >= 3 ? 'ğŸ¥‡' : hits >= 1 ? 'ğŸ¥ˆ' : 'ğŸ’ª';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Training session done!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._gymStars.join(' ')}</div>
        <div>${hits}/5 correct settings &nbsp;Â·&nbsp; Earned <strong>${this._gymEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._startGym()">ğŸ’ª New clients</button>
      </div>`;
  },

  // â”€â”€ Stadium: Goal Scoring Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Goal mouth: x 60â€“260, y 25â€“85. Keeper width Â±28px
  _glShots: 0, _glGoals: 0, _glEarned: 0, _glStars: [],
  _glKeeperX: 160, _glKeeperDir: 1, _glKeeperSpeed: 75,
  _glBall: null,   // {sx,sy,tx,ty,t,dur}
  _glEffect: null, // {text,x,y,t}
  _glShooting: false, _glRaf: null, _glLastT: 0,

  _startGoals() {
    if (this._glRaf) { cancelAnimationFrame(this._glRaf); this._glRaf = null; }
    this._glShots      = 0;
    this._glGoals      = 0;
    this._glEarned     = 0;
    this._glStars      = [];
    this._glKeeperX    = 160;
    this._glKeeperDir  = 1;
    this._glBall       = null;
    this._glEffect     = null;
    this._glShooting   = false;
    this._glLastT      = performance.now();
    const tick = (ts) => {
      if (!document.getElementById('wg-gl-canvas')) { this._glRaf = null; return; }
      const dt = Math.min((ts - this._glLastT) / 1000, 0.05);
      this._glLastT = ts;
      this._glDraw(dt);
      if (this._glRaf !== null) this._glRaf = requestAnimationFrame(tick);
    };
    this._glRaf = requestAnimationFrame(tick);
  },

  _glDraw(dt) {
    // Move keeper
    if (!this._glShooting) {
      this._glKeeperX += this._glKeeperDir * this._glKeeperSpeed * dt;
      if (this._glKeeperX > 240) { this._glKeeperX = 240; this._glKeeperDir = -1; }
      if (this._glKeeperX < 80)  { this._glKeeperX = 80;  this._glKeeperDir =  1; }
    }

    // Animate ball
    if (this._glBall) {
      this._glBall.t += dt;
      const p = Math.min(1, this._glBall.t / this._glBall.dur);
      this._glBall.cx = this._glBall.sx + (this._glBall.tx - this._glBall.sx) * p;
      this._glBall.cy = this._glBall.sy + (this._glBall.ty - this._glBall.sy) * p;
      if (p >= 1) {
        // Decide outcome
        const keeperReach = 30;
        const goal = Math.abs(this._glBall.tx - this._glKeeperX) > keeperReach
                  || this._glBall.ty > 90; // below goal mouth = wide
        if (goal && this._glBall.ty < 90) {
          this._glGoals++;
          this._glEarned += 5;
          this._glStars.push('âš½');
          this._glEffect = {text:'âš½ GOAL!', x: this._glBall.tx, y: 55, t: 1.2};
        } else {
          this._glStars.push('ğŸ§¤');
          this._glEffect = {text: this._glBall.ty >= 90 ? 'ğŸ˜… Wide!' : 'ğŸ§¤ Saved!', x: 160, y: 55, t: 1.2};
        }
        this._glBall = null;
        this._glShots++;
        this._glShooting = false;
        if (this._glShots >= 5) setTimeout(() => this._glFinish(), 1300);
      }
    }

    // Fade effect
    if (this._glEffect) this._glEffect.t -= dt;

    const canvas = document.getElementById('wg-gl-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = 320, H = 200;

    // Pitch
    ctx.fillStyle = '#16a34a';
    ctx.fillRect(0, 0, W, H);
    // Pitch markings
    ctx.strokeStyle = 'rgba(255,255,255,0.25)'; ctx.lineWidth = 2; ctx.setLineDash([]);
    ctx.strokeRect(40, 100, W - 80, H - 110);  // penalty box
    ctx.beginPath(); ctx.arc(160, H, 40, Math.PI, 0); ctx.stroke(); // penalty arc

    // Goal frame
    ctx.fillStyle = '#e2e8f0';
    ctx.fillRect(58, 20, 4, 70);   // left post
    ctx.fillRect(258, 20, 4, 70);  // right post
    ctx.fillRect(58, 20, 204, 5);  // crossbar
    // Goal net
    ctx.strokeStyle = 'rgba(200,200,200,0.4)'; ctx.lineWidth = 1;
    for (let gx = 62; gx < 260; gx += 18) {
      ctx.beginPath(); ctx.moveTo(gx, 25); ctx.lineTo(gx, 90); ctx.stroke();
    }
    for (let gy = 25; gy < 90; gy += 16) {
      ctx.beginPath(); ctx.moveTo(62, gy); ctx.lineTo(258, gy); ctx.stroke();
    }

    // Keeper
    ctx.font = '26px serif'; ctx.textAlign = 'center';
    ctx.fillText('ğŸ§¤', this._glKeeperX, 74);

    // Shoot hint when not shooting
    if (!this._glShooting && this._glShots < 5) {
      ctx.font = 'bold 11px sans-serif'; ctx.fillStyle = 'rgba(255,255,255,0.7)';
      ctx.fillText('Tap the goal to shoot!', 160, H - 10);
    }

    // Ball (resting or in flight)
    if (this._glBall) {
      ctx.font = '18px serif'; ctx.textAlign = 'center';
      ctx.fillText('âš½', this._glBall.cx, this._glBall.cy);
    } else if (!this._glShooting && this._glShots < 5) {
      ctx.font = '18px serif'; ctx.textAlign = 'center';
      ctx.fillText('âš½', 160, H - 28);
    }

    // Effect text
    if (this._glEffect && this._glEffect.t > 0) {
      const alpha = Math.min(1, this._glEffect.t);
      ctx.globalAlpha = alpha;
      ctx.font = 'bold 16px sans-serif'; ctx.fillStyle = '#fbbf24'; ctx.textAlign = 'center';
      ctx.fillText(this._glEffect.text, this._glEffect.x, this._glEffect.y);
      ctx.globalAlpha = 1;
    }

    // HUD
    document.getElementById('wg-gl-shots').textContent  = this._glShots;
    document.getElementById('wg-gl-goals').textContent  = this._glGoals;
    document.getElementById('wg-gl-earned').textContent = this._glEarned;
    document.getElementById('wg-gl-stars').textContent  = this._glStars.join(' ');
  },

  glShoot(e) {
    if (this._glShooting || this._glShots >= 5) return;
    const canvas = document.getElementById('wg-gl-canvas');
    if (!canvas) return;
    const rect = canvas.getBoundingClientRect();
    const tx = (e.clientX - rect.left) * (320 / rect.width);
    const ty = (e.clientY - rect.top)  * (200 / rect.height);
    this._glShooting = true;
    this._glBall = {sx: 160, sy: 172, tx, ty, cx: 160, cy: 172, t: 0, dur: 0.45};
  },

  _glFinish() {
    if (this._glRaf) { cancelAnimationFrame(this._glRaf); this._glRaf = null; }
    const wd    = WD[this.worldType];
    this.currency += this._glEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area   = document.getElementById('wg-gl-area');
    const trophy = this._glGoals === 5 ? 'ğŸ†' : this._glGoals >= 3 ? 'ğŸ¥‡' : this._glGoals >= 1 ? 'âš½' : 'ğŸ’ª';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Match over!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._glStars.join(' ')}</div>
        <div>${this._glGoals}/5 goals &nbsp;Â·&nbsp; Earned <strong>${this._glEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._startGoals()">âš½ Play again</button>
      </div>`;
  },

  // â”€â”€ Pool: Whistle Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _WH_RULES: [
    {icon:'ğŸƒ', label:'Running!'},
    {icon:'ğŸ•', label:'Eating!'},
    {icon:'ğŸ“±', label:'Phone!'},
    {icon:'ğŸ’£', label:'Bombing!'},
    {icon:'ğŸ‘Ÿ', label:'Shoes on!'},
  ],
  _whPeople: [], _whEarned: 0, _whCaught: 0, _whStars: [],
  _whRaf: null, _whLastT: 0, _whEffects: [],

  _startWhistle() {
    if (this._whRaf) { cancelAnimationFrame(this._whRaf); this._whRaf = null; }
    this._whEarned  = 0;
    this._whCaught  = 0;
    this._whStars   = [];
    this._whEffects = [];
    // Spawn 8 people: 4-5 rule-breakers, rest good swimmers
    const ruleBreakers = Math.floor(3 + Math.random() * 3); // 3â€“5
    this._whPeople = [];
    const positions = [];
    for (let i = 0; i < 8; i++) {
      // Find non-overlapping position in pool area (x:30â€“280, y:50â€“165)
      let px, py, attempts = 0;
      do {
        px = 35 + Math.random() * 250;
        py = 55 + Math.random() * 110;
        attempts++;
      } while (attempts < 20 && positions.some(p => Math.hypot(p.x - px, p.y - py) < 38));
      positions.push({x: px, y: py});
      const breaking = i < ruleBreakers;
      this._whPeople.push({
        x: px, y: py,
        breaking,
        rule: breaking ? this._WH_RULES[Math.floor(Math.random() * this._WH_RULES.length)] : null,
        tapped: false,
        bob: Math.random() * Math.PI * 2, // random start phase
      });
    }
    this._whLastT = performance.now();
    const tick = (ts) => {
      if (!document.getElementById('wg-wh-canvas')) { this._whRaf = null; return; }
      const dt = Math.min((ts - this._whLastT) / 1000, 0.05);
      this._whLastT = ts;
      this._whDraw(dt);
      if (this._whRaf !== null) this._whRaf = requestAnimationFrame(tick);
    };
    this._whRaf = requestAnimationFrame(tick);
  },

  _whDraw(dt) {
    const canvas = document.getElementById('wg-wh-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = 320, H = 200;

    // Pool tiles background
    ctx.fillStyle = '#0ea5e9';
    ctx.fillRect(0, 0, W, H);
    // Lane lines
    ctx.strokeStyle = 'rgba(255,255,255,0.3)'; ctx.lineWidth = 2; ctx.setLineDash([12, 8]);
    for (let l = 1; l < 4; l++) {
      ctx.beginPath(); ctx.moveTo(0, l * 50); ctx.lineTo(W, l * 50); ctx.stroke();
    }
    ctx.setLineDash([]);
    // Pool edge
    ctx.fillStyle = '#bae6fd';
    ctx.fillRect(0, 0, W, 16);
    ctx.fillRect(0, H - 16, W, 16);
    // Tile grid on edges
    ctx.strokeStyle = 'rgba(100,200,255,0.4)'; ctx.lineWidth = 1;
    for (let t = 0; t < W; t += 20) {
      ctx.strokeRect(t, 0, 20, 16);
      ctx.strokeRect(t, H - 16, 20, 16);
    }
    // Lifeguard stand (top right)
    ctx.fillStyle = '#f97316';
    ctx.fillRect(W - 30, 18, 24, 30);
    ctx.font = '16px serif'; ctx.textAlign = 'center';
    ctx.fillText('ğŸ§‘â€âœˆï¸', W - 18, 34);

    // Draw people
    for (const p of this._whPeople) {
      if (p.tapped) continue;
      p.bob += dt * 2.2;
      const bobY = Math.sin(p.bob) * 2;

      ctx.globalAlpha = 1;
      // Swimmer circle
      ctx.fillStyle = p.breaking ? 'rgba(239,68,68,0.25)' : 'rgba(255,255,255,0.15)';
      ctx.beginPath(); ctx.arc(p.x, p.y + bobY, 18, 0, Math.PI * 2); ctx.fill();
      // Person emoji
      ctx.font = '20px serif'; ctx.textAlign = 'center';
      ctx.fillText('ğŸŠ', p.x, p.y + bobY + 7);
      // Rule-break icon above
      if (p.breaking) {
        ctx.font = '15px serif';
        ctx.fillText(p.rule.icon, p.x, p.y + bobY - 14);
        // Red border ring
        ctx.strokeStyle = '#ef4444'; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.arc(p.x, p.y + bobY, 18, 0, Math.PI * 2); ctx.stroke();
      }
    }

    // Tap effects
    this._whEffects = this._whEffects.filter(ef => ef.t > 0);
    for (const ef of this._whEffects) {
      ef.t -= dt;
      ctx.globalAlpha = Math.min(1, ef.t * 3);
      ctx.font = '20px serif'; ctx.textAlign = 'center';
      ctx.fillText(ef.ok ? 'ğŸ“£âœ…' : 'âŒ', ef.x, ef.y - (1 - ef.t) * 18);
    }
    ctx.globalAlpha = 1;

    // HUD
    const cEl = document.getElementById('wg-wh-caught');
    const eEl = document.getElementById('wg-wh-earned');
    const sEl = document.getElementById('wg-wh-stars');
    if (cEl) cEl.textContent = this._whCaught;
    if (eEl) eEl.textContent = this._whEarned;
    if (sEl) sEl.textContent = this._whStars.join(' ');
  },

  whTap(e) {
    const canvas = document.getElementById('wg-wh-canvas');
    if (!canvas) return;
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (320 / rect.width);
    const my = (e.clientY - rect.top)  * (200 / rect.height);

    let hit = false;
    for (const p of this._whPeople) {
      if (p.tapped) continue;
      if (Math.hypot(mx - p.x, my - p.y) < 22) {
        p.tapped = true;
        hit = true;
        if (p.breaking) {
          this._whEarned += 4;
          this._whCaught++;
          this._whStars.push('ğŸ“£');
          this._whEffects.push({x: p.x, y: p.y, t: 0.9, ok: true});
        } else {
          // Tapped a good swimmer
          this._whStars.push('âŒ');
          this._whEffects.push({x: p.x, y: p.y, t: 0.9, ok: false});
        }
        break;
      }
    }

    // Check if all rule-breakers caught â†’ finish
    const remaining = this._whPeople.filter(p => p.breaking && !p.tapped).length;
    if (remaining === 0) setTimeout(() => this._whFinish(), 700);
  },

  _whFinish() {
    if (this._whRaf) { cancelAnimationFrame(this._whRaf); this._whRaf = null; }
    const wd  = WD[this.worldType];
    this.currency += this._whEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area   = document.getElementById('wg-wh-area');
    const total  = this._whPeople.filter(p => p.breaking).length;
    const trophy = this._whCaught === total ? 'ğŸ†' : this._whCaught >= total - 1 ? 'ğŸ¥‡' : this._whCaught >= 1 ? 'ğŸ¥ˆ' : 'ğŸ’ª';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Pool patrol done!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._whStars.join(' ')}</div>
        <div>${this._whCaught}/${total} rule-breakers caught &nbsp;Â·&nbsp; Earned <strong>${this._whEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._startWhistle()">ğŸ“£ New patrol</button>
      </div>`;
  },

  // â”€â”€ Sculpture Park: Sculpting Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _SC_RESULTS: ['ğŸ˜','ğŸ¦','ğŸ¬','ğŸ¦…','ğŸ—¿','ğŸº','ğŸ’','ğŸ§Š'],
  _scCuts: 0, _scEarned: 0, _scStars: [], _scTarget: null,
  _scEffect: null, _scRaf: null, _scLastT: 0, _scPulse: 0,
  _scChips: [], // small chip particles

  _startSculpt() {
    if (this._scRaf) { cancelAnimationFrame(this._scRaf); this._scRaf = null; }
    this._scCuts    = 0;
    this._scEarned  = 0;
    this._scStars   = [];
    this._scEffect  = null;
    this._scChips   = [];
    this._scPulse   = 0;
    this._scPickTarget();
    this._scLastT = performance.now();
    const tick = (ts) => {
      if (!document.getElementById('wg-sc-canvas')) { this._scRaf = null; return; }
      const dt = Math.min((ts - this._scLastT) / 1000, 0.05);
      this._scLastT = ts;
      this._scDraw(dt);
      if (this._scRaf !== null) this._scRaf = requestAnimationFrame(tick);
    };
    this._scRaf = requestAnimationFrame(tick);
  },

  _scPickTarget() {
    // Target zone somewhere on the stone block (block: x 60â€“260, y 40â€“140)
    this._scTarget = {
      x: 80 + Math.random() * 160,
      y: 55 + Math.random() * 70,
      r: 22,
    };
  },

  _scDraw(dt) {
    this._scPulse += dt * 3;
    const canvas = document.getElementById('wg-sc-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = 320, H = 180;

    // Sky/park background
    ctx.fillStyle = '#a8d5e2';
    ctx.fillRect(0, 0, W, H);
    ctx.fillStyle = '#6bb87a';
    ctx.fillRect(0, 140, W, 40);

    // Stone block â€” gets chipped corners with each cut
    const chips = Math.min(this._scCuts, 6);
    ctx.fillStyle = '#9ca3af';
    ctx.beginPath();
    ctx.moveTo(60, 40);
    ctx.lineTo(260, 40);
    ctx.lineTo(260, 140);
    ctx.lineTo(60, 140);
    ctx.closePath();
    ctx.fill();
    // Shading
    ctx.fillStyle = 'rgba(0,0,0,0.12)';
    ctx.fillRect(220, 40, 40, 100);
    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.fillRect(60, 40, 40, 100);

    // Chip marks from previous cuts
    for (const c of this._scChips) {
      ctx.fillStyle = 'rgba(0,0,0,0.25)';
      ctx.beginPath();
      ctx.arc(c.x, c.y, c.r * 0.6, 0, Math.PI * 2);
      ctx.fill();
    }

    // Pulsing target zone (only shown when no effect active)
    if (this._scTarget && !this._scEffect) {
      const pulse = 0.7 + Math.sin(this._scPulse) * 0.3;
      const t = this._scTarget;
      // Outer glow
      ctx.strokeStyle = `rgba(251,191,36,${pulse * 0.5})`;
      ctx.lineWidth = 6;
      ctx.beginPath(); ctx.arc(t.x, t.y, t.r + 6, 0, Math.PI * 2); ctx.stroke();
      // Inner ring
      ctx.strokeStyle = `rgba(251,191,36,${pulse})`;
      ctx.lineWidth = 3;
      ctx.beginPath(); ctx.arc(t.x, t.y, t.r, 0, Math.PI * 2); ctx.stroke();
      // Centre crosshair
      ctx.strokeStyle = `rgba(251,191,36,${pulse})`;
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(t.x - 8, t.y); ctx.lineTo(t.x + 8, t.y); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(t.x, t.y - 8); ctx.lineTo(t.x, t.y + 8); ctx.stroke();
    }

    // Click effect (spark burst)
    if (this._scEffect) {
      this._scEffect.t -= dt;
      if (this._scEffect.t <= 0) { this._scEffect = null; }
      else {
        const alpha = this._scEffect.t / 0.5;
        const col   = this._scEffect.ok ? '#fbbf24' : '#ef4444';
        ctx.strokeStyle = col; ctx.lineWidth = 2; ctx.globalAlpha = alpha;
        for (let a = 0; a < 8; a++) {
          const angle = (a / 8) * Math.PI * 2;
          const len   = (1 - this._scEffect.t / 0.5) * 20;
          const ex    = this._scEffect.x + Math.cos(angle) * len;
          const ey    = this._scEffect.y + Math.sin(angle) * len;
          ctx.beginPath();
          ctx.moveTo(this._scEffect.x, this._scEffect.y);
          ctx.lineTo(ex, ey);
          ctx.stroke();
        }
        ctx.globalAlpha = 1;
        ctx.font = '18px serif'; ctx.textAlign = 'center';
        ctx.fillText(this._scEffect.ok ? 'âœ…' : 'âŒ', this._scEffect.x, this._scEffect.y - 20);
      }
    }

    // Chisel tool emoji at bottom right
    ctx.font = '22px serif'; ctx.textAlign = 'right';
    ctx.fillText('ğŸ”ª', W - 10, H - 10);

    // Update HUD
    const cutsEl   = document.getElementById('wg-sc-cuts');
    const earnedEl = document.getElementById('wg-sc-earned');
    const starsEl  = document.getElementById('wg-sc-stars');
    if (cutsEl)   cutsEl.textContent   = this._scCuts;
    if (earnedEl) earnedEl.textContent = this._scEarned;
    if (starsEl)  starsEl.textContent  = this._scStars.join(' ');
  },

  scChisel(e) {
    if (!this._scTarget || this._scEffect) return;
    const canvas = document.getElementById('wg-sc-canvas');
    if (!canvas) return;
    const rect = canvas.getBoundingClientRect();
    const mx = (e.clientX - rect.left) * (320 / rect.width);
    const my = (e.clientY - rect.top)  * (180 / rect.height);
    const t  = this._scTarget;
    const dist = Math.hypot(mx - t.x, my - t.y);
    const ok = dist <= t.r;

    this._scEffect = {x: mx, y: my, t: 0.5, ok};
    this._scChips.push({x: t.x, y: t.y, r: t.r});

    if (ok) {
      const earn = dist < t.r * 0.4 ? 5 : 3;
      this._scEarned += earn;
      this._scStars.push(dist < t.r * 0.4 ? 'â­' : 'ğŸŒŸ');
    } else {
      this._scStars.push('âŒ');
    }

    this._scCuts++;
    this._scTarget = null;

    if (this._scCuts >= 6) {
      setTimeout(() => this._scFinish(), 700);
    } else {
      setTimeout(() => this._scPickTarget(), 600);
    }
  },

  _scFinish() {
    if (this._scRaf) { cancelAnimationFrame(this._scRaf); this._scRaf = null; }
    const wd     = WD[this.worldType];
    this.currency += this._scEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area   = document.getElementById('wg-sc-area');
    const hits   = this._scStars.filter(s => s !== 'âŒ').length;
    const result = this._SC_RESULTS[Math.floor(Math.random() * this._SC_RESULTS.length)];
    const trophy = hits >= 5 ? 'ğŸ†' : hits >= 3 ? 'ğŸ¥‡' : hits >= 1 ? 'ğŸ¥ˆ' : 'ğŸ’ª';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:3rem">${result}</div>
        <div style="font-size:0.8rem;color:#94a3b8;margin-top:4px">Your sculpture!</div>
        <div style="font-size:1.5rem;margin:10px 0">${trophy}</div>
        <div style="font-size:1rem;font-weight:800;margin-bottom:6px">Sculpting complete!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._scStars.join(' ')}</div>
        <div>${hits}/6 hits &nbsp;Â·&nbsp; Earned <strong>${this._scEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._startSculpt()">ğŸ—¿ Sculpt again</button>
      </div>`;
  },

  // â”€â”€ Museum: Artwork Placement Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _MS_ARTWORKS: [
    {e:'ğŸŒŠ', clue:'A vast ocean painted at sunset',           slot:'nature'},
    {e:'ğŸ‘¸', clue:'A portrait of a queen in royal robes',     slot:'portrait'},
    {e:'ğŸ”·', clue:'Bold blue geometric shapes on white',      slot:'modern'},
    {e:'ğŸŒ€', clue:'Swirling colours with no clear shape',     slot:'abstract'},
    {e:'ğŸŒ¸', clue:'Delicate cherry blossoms in spring',       slot:'nature'},
    {e:'ğŸ§‘', clue:'A sketch of a young person\'s face',       slot:'portrait'},
    {e:'â¬›', clue:'A plain black square on a white canvas',   slot:'modern'},
    {e:'ğŸ­', clue:'Drama masks in wild clashing colours',     slot:'abstract'},
    {e:'ğŸ¦', clue:'A majestic lion painted in the wild',      slot:'nature'},
    {e:'ğŸŸ¡', clue:'A giant yellow circle â€” nothing else',     slot:'abstract'},
    {e:'ğŸ‘´', clue:'An old man staring out of a window',       slot:'portrait'},
    {e:'ğŸ”º', clue:'Red triangles layered on a blue grid',     slot:'modern'},
  ],
  _msRound: 0, _msEarned: 0, _msStars: [], _msPool: [], _msAnswered: false,

  _startMuseum() {
    this._msRound    = 0;
    this._msEarned   = 0;
    this._msStars    = [];
    this._msAnswered = false;
    this._msPool     = [...this._MS_ARTWORKS].sort(() => Math.random() - 0.5);
    this._msShow();
  },

  _msShow() {
    this._msAnswered = false;
    const aw = this._msPool[this._msRound];
    const artEl   = document.getElementById('wg-ms-art');
    const clueEl  = document.getElementById('wg-ms-clue');
    const roundEl = document.getElementById('wg-ms-round');
    const repEl   = document.getElementById('wg-ms-reply');
    if (artEl)   artEl.textContent  = aw.e;
    if (clueEl)  clueEl.textContent = aw.clue;
    if (roundEl) roundEl.textContent = this._msRound + 1;
    if (repEl)   repEl.textContent  = '';
    // Reset slot buttons
    document.querySelectorAll('#wg-ms-slots button').forEach(b => {
      b.style.background = ''; b.style.color = ''; b.style.pointerEvents = 'auto';
    });
  },

  msPlace(slot) {
    if (this._msAnswered) return;
    this._msAnswered = true;
    const aw   = this._msPool[this._msRound];
    const ok   = slot === aw.slot;
    const repEl = document.getElementById('wg-ms-reply');
    const slotLabels = {abstract:'ğŸŒ€ Abstract',nature:'ğŸŒ¿ Nature',portrait:'ğŸ‘¤ Portrait',modern:'ğŸ”· Modern'};

    // Highlight chosen button and show correct answer
    document.querySelectorAll('#wg-ms-slots button').forEach(b => {
      b.style.pointerEvents = 'none';
      const bSlot = b.getAttribute('onclick').match(/'(\w+)'/)[1];
      if (bSlot === slot)      { b.style.background = ok ? '#22c55e' : '#ef4444'; b.style.color = '#fff'; }
      if (!ok && bSlot === aw.slot) { b.style.background = '#22c55e'; b.style.color = '#fff'; }
    });

    if (ok) {
      this._msEarned += 4;
      this._msStars.push('â­');
      if (repEl) { repEl.textContent = `âœ… Perfect! Hung in ${slotLabels[slot]}`; repEl.style.color = '#22c55e'; }
    } else {
      this._msStars.push('âŒ');
      if (repEl) { repEl.textContent = `âŒ That belongs in ${slotLabels[aw.slot]}`; repEl.style.color = '#f87171'; }
    }

    const earnedEl = document.getElementById('wg-ms-earned');
    const starsEl  = document.getElementById('wg-ms-stars');
    if (earnedEl) earnedEl.textContent = this._msEarned;
    if (starsEl)  starsEl.textContent  = this._msStars.join(' ');

    this._msRound++;
    if (this._msRound >= 6) setTimeout(() => this._msFinish(), 1100);
    else setTimeout(() => this._msShow(), 1300);
  },

  _msFinish() {
    const wd   = WD[this.worldType];
    this.currency += this._msEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area  = document.getElementById('wg-ms-area');
    const hits  = this._msStars.filter(s => s === 'â­').length;
    const trophy = hits === 6 ? 'ğŸ†' : hits >= 4 ? 'ğŸ¥‡' : hits >= 2 ? 'ğŸ¥ˆ' : 'ğŸ’ª';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Exhibition complete!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._msStars.join(' ')}</div>
        <div>${hits}/6 correctly placed &nbsp;Â·&nbsp; Earned <strong>${this._msEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._startMuseum()">ğŸ–¼ Hang more art</button>
      </div>`;
  },

  // â”€â”€ Food Festival: Interview Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _IV_GUESTS: [
    { e:'ğŸ§‘', clue:'"I love really spicy food! ğŸŒ¶"',
      qs:[{q:'What\'s the spiciest dish you\'ve tried?', ok:true,  reply:'Oh wow, it was a ghost pepper curry! ğŸ”¥ Amazing!'},
          {q:'Do you prefer sweet or savoury?',          ok:false, reply:'Uhâ€¦ that\'s a bit off-topicâ€¦'},
          {q:'Have you always lived here?',               ok:false, reply:'I\'m not sure what that has to do with foodâ€¦'}]},
    { e:'ğŸ‘©â€ğŸ³', clue:'"I just won a baking competition! ğŸ†"',
      qs:[{q:'What did you bake to win?',                ok:true,  reply:'A salted caramel tart â€” people went wild for it! ğŸ¥§'},
          {q:'Is the festival too crowded?',             ok:false, reply:'I\'d rather talk about my bakesâ€¦'},
          {q:'Do you like eating out?',                  ok:false, reply:'Not really the question I expectedâ€¦'}]},
    { e:'ğŸ§‘â€ğŸŒ¾', clue:'"I only eat plant-based food ğŸŒ±"',
      qs:[{q:'What\'s your favourite vegan dish here?',  ok:true,  reply:'The jackfruit tacos are incredible! ğŸŒ®'},
          {q:'Do you like hamburgers?',                  ok:false, reply:'I\'m plant-basedâ€¦ so no! ğŸ˜…'},
          {q:'How long have you been here?',             ok:false, reply:'That\'s not really food relatedâ€¦'}]},
    { e:'ğŸ§³', clue:'"I travelled from Japan for this festival! âœˆ"',
      qs:[{q:'What Japanese food are you sharing today?',ok:true,  reply:'Homemade ramen â€” 12 hours of broth! ğŸœ'},
          {q:'Is the weather nice here?',                ok:false, reply:'I suppose, but I\'m here for the food!'},
          {q:'Do you prefer sweet desserts?',            ok:false, reply:'That\'s a bit vagueâ€¦'}]},
    { e:'ğŸ‘´', clue:'"I\'ve been coming here for 20 years ğŸ‰"',
      qs:[{q:'How has the festival changed over the years?', ok:true, reply:'So many more international foods now! ğŸŒ'},
          {q:'What\'s your favourite colour?',           ok:false, reply:'â€¦what? This is a food festival!'},
          {q:'Do you live nearby?',                      ok:false, reply:'Sort of, but that\'s not the interesting part!'}]},
    { e:'ğŸ‘©', clue:'"I run an ice cream stall ğŸ¦"',
      qs:[{q:'What\'s your most popular flavour today?', ok:true,  reply:'Lavender honey â€” sold out in an hour! ğŸŒ¸'},
          {q:'Do you prefer hot or cold weather?',       ok:false, reply:'Bit of a random question!'},
          {q:'Have you met the organiser?',              ok:false, reply:'Yes butâ€¦ that\'s not very interesting!'}]},
    { e:'ğŸ§’', clue:'"This is my first food festival! ğŸ‘€"',
      qs:[{q:'What\'s surprised you most so far?',       ok:true,  reply:'How many flavours of cheese there are! ğŸ§€'},
          {q:'Are you a professional chef?',             ok:false, reply:'I\'m a kid! Way too young for that!'},
          {q:'Do you prefer Asian or European food?',    ok:false, reply:'I don\'t really know yetâ€¦'}]},
    { e:'ğŸ§‘â€ğŸ’¼', clue:'"I\'m a food journalist ğŸ“"',
      qs:[{q:'What\'s the best thing you\'ve tasted today?', ok:true, reply:'A truffle arancini â€” absolutely stunning! ğŸš'},
          {q:'Do you write about other topics too?',     ok:false, reply:'Only food â€” stay on topic! ğŸ˜„'},
          {q:'Is journalism a good career?',             ok:false, reply:'Maybe ask me about food instead?'}]},
  ],
  _ivRound: 0, _ivEarned: 0, _ivStars: [], _ivAnswered: false,

  _startInterview() {
    this._ivRound    = 0;
    this._ivEarned   = 0;
    this._ivStars    = [];
    this._ivAnswered = false;
    this._ivNext();
  },

  _ivNext() {
    this._ivAnswered = false;
    const pool   = [...this._IV_GUESTS].sort(() => Math.random() - 0.5);
    const guest  = pool[this._ivRound % pool.length];
    const qs     = [...guest.qs].sort(() => Math.random() - 0.5);
    const gEl    = document.getElementById('wg-iv-guest');
    const cEl    = document.getElementById('wg-iv-clue');
    const btnsEl = document.getElementById('wg-iv-btns');
    const rndEl  = document.getElementById('wg-iv-round');
    const repEl  = document.getElementById('wg-iv-reply');
    if (gEl)    gEl.textContent    = guest.e;
    if (cEl)    cEl.textContent    = guest.clue;
    if (rndEl)  rndEl.textContent  = this._ivRound + 1;
    if (repEl)  repEl.textContent  = '';
    if (btnsEl) btnsEl.innerHTML   = qs.map((q, i) =>
      `<button class="btn btn-secondary" style="text-align:left;font-size:0.88rem;padding:10px 12px"
        onclick="WG.ivAsk(${i},${q.ok},\`${q.reply.replace(/`/g,"'")}\`)">
        ğŸ¤ ${q.q}
      </button>`
    ).join('');
  },

  ivAsk(idx, ok, reply) {
    if (this._ivAnswered) return;
    this._ivAnswered = true;
    const btns = document.querySelectorAll('#wg-iv-btns button');
    const repEl = document.getElementById('wg-iv-reply');
    btns.forEach((b, i) => {
      b.style.pointerEvents = 'none';
      if (i === idx) { b.style.background = ok ? '#22c55e' : '#ef4444'; b.style.color = '#fff'; }
    });
    if (repEl) { repEl.textContent = reply; repEl.style.color = ok ? '#22c55e' : '#f87171'; }
    if (ok) { this._ivEarned += 4; this._ivStars.push('â­'); }
    else    { this._ivStars.push('âŒ'); }
    const earnedEl = document.getElementById('wg-iv-earned');
    const starsEl  = document.getElementById('wg-iv-stars');
    if (earnedEl) earnedEl.textContent = this._ivEarned;
    if (starsEl)  starsEl.textContent  = this._ivStars.join(' ');
    this._ivRound++;
    if (this._ivRound >= 5) setTimeout(() => this._ivFinish(), 1200);
    else setTimeout(() => this._ivNext(), 1400);
  },

  _ivFinish() {
    const wd    = WD[this.worldType];
    this.currency += this._ivEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area  = document.getElementById('wg-iv-area');
    const hits  = this._ivStars.filter(s => s === 'â­').length;
    const trophy = hits === 5 ? 'ğŸ†' : hits >= 3 ? 'ğŸ¥‡' : hits >= 1 ? 'ğŸ¥ˆ' : 'ğŸ’ª';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Interviews done!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._ivStars.join(' ')}</div>
        <div>${hits}/5 great questions &nbsp;Â·&nbsp; Earned <strong>${this._ivEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._startInterview()">ğŸ¤ Interview more guests</button>
      </div>`;
  },

  // â”€â”€ Restaurant: Cooking Game â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _RECIPES: [
    {dish:'ğŸ”', name:'Burger',       needed:['ğŸ¥ Bun','ğŸ¥© Patty','ğŸ¥¬ Lettuce','ğŸ§€ Cheese']},
    {dish:'ğŸ•', name:'Pizza',        needed:['ğŸ«“ Dough','ğŸ… Sauce','ğŸ§€ Cheese','ğŸ„ Mushroom']},
    {dish:'ğŸŒ®', name:'Taco',         needed:['ğŸŒ® Shell','ğŸ¥© Meat','ğŸ¥¬ Lettuce','ğŸ… Tomato']},
    {dish:'ğŸ', name:'Pasta',        needed:['ğŸ Noodles','ğŸ… Sauce','ğŸ§„ Garlic','ğŸ§€ Parmesan']},
    {dish:'ğŸœ', name:'Noodle Soup',  needed:['ğŸ«• Broth','ğŸ¥• Carrot','ğŸ§… Onion','ğŸŒ¿ Herb']},
    {dish:'ğŸ¥—', name:'Salad',        needed:['ğŸ¥¬ Lettuce','ğŸ… Tomato','ğŸ¥• Carrot','ğŸ«’ Olive']},
    {dish:'ğŸ±', name:'Bento Box',    needed:['ğŸš Rice','ğŸ¥¢ Noodles','ğŸ¥¦ Broccoli','ğŸ³ Egg']},
    {dish:'ğŸ¥˜', name:'Stew',         needed:['ğŸ«• Broth','ğŸ¥” Potato','ğŸ¥• Carrot','ğŸ¥© Beef']},
  ],
  _COOK_INGREDIENTS: [
    'ğŸ¥ Bun','ğŸ¥© Patty','ğŸ¥¬ Lettuce','ğŸ§€ Cheese','ğŸ«“ Dough','ğŸ… Sauce','ğŸ„ Mushroom',
    'ğŸŒ® Shell','ğŸ¥© Meat','ğŸ Noodles','ğŸ§„ Garlic','ğŸ«• Broth','ğŸ¥• Carrot','ğŸ§… Onion',
    'ğŸŒ¿ Herb','ğŸ«’ Olive','ğŸš Rice','ğŸ¥¢ Noodles','ğŸ¥¦ Broccoli','ğŸ³ Egg','ğŸ¥” Potato','ğŸ¥© Beef',
  ],
  _cookRound: 0, _cookEarned: 0, _cookStars: [], _cookRecipe: null, _cookAdded: [],

  _startCook() {
    this._cookRound  = 0;
    this._cookEarned = 0;
    this._cookStars  = [];
    this._cookNext();
  },

  _cookNext() {
    const recipe = this._RECIPES[Math.floor(Math.random() * this._RECIPES.length)];
    this._cookRecipe = recipe;
    this._cookAdded  = [];

    // Build ingredient pool: recipe ingredients + 4 random wrong ones
    const wrong = [...new Set(this._COOK_INGREDIENTS.filter(i => !recipe.needed.includes(i)))]
      .sort(() => Math.random() - 0.5).slice(0, 4);
    const pool  = [...recipe.needed, ...wrong].sort(() => Math.random() - 0.5);

    const dishEl   = document.getElementById('wg-cook-dish');
    const nameEl   = document.getElementById('wg-cook-name');
    const neededEl = document.getElementById('wg-cook-needed');
    const btnsEl   = document.getElementById('wg-cook-btns');
    const roundEl  = document.getElementById('wg-cook-round');
    if (dishEl)   dishEl.textContent   = recipe.dish;
    if (nameEl)   nameEl.textContent   = recipe.name;
    if (roundEl)  roundEl.textContent  = this._cookRound + 1;
    if (neededEl) neededEl.innerHTML   = recipe.needed.map(i =>
      `<span id="cook-need-${CSS.escape(i)}" style="background:#1e293b;border-radius:6px;padding:3px 7px">${i}</span>`
    ).join('');
    if (btnsEl) btnsEl.innerHTML = pool.map(i =>
      `<button id="cook-btn-${CSS.escape(i)}" class="btn btn-secondary"
        style="font-size:0.85rem;padding:7px 10px"
        onclick="WG.cookTap('${i.replace(/'/g,"\\'")}')">
        ${i}
      </button>`
    ).join('');
  },

  cookTap(ingredient) {
    if (!this._cookRecipe) return;
    if (this._cookAdded.includes(ingredient)) return;
    const btn = document.getElementById(`cook-btn-${CSS.escape(ingredient)}`);
    if (this._cookRecipe.needed.includes(ingredient)) {
      // Correct
      this._cookAdded.push(ingredient);
      if (btn) { btn.style.background='#22c55e'; btn.style.color='#fff'; btn.style.pointerEvents='none'; }
      const needSpan = document.getElementById(`cook-need-${CSS.escape(ingredient)}`);
      if (needSpan) { needSpan.style.background='#22c55e'; needSpan.style.color='#fff'; needSpan.textContent='âœ“ '+ingredient; }
      // Check if all ingredients added
      if (this._cookAdded.length === this._cookRecipe.needed.length) {
        const earn = 5;
        this._cookEarned += earn;
        this._cookStars.push('â­');
        const earnedEl = document.getElementById('wg-cook-earned');
        const starsEl  = document.getElementById('wg-cook-stars');
        const dishEl   = document.getElementById('wg-cook-dish');
        if (earnedEl) earnedEl.textContent = this._cookEarned;
        if (starsEl)  starsEl.textContent  = this._cookStars.join(' ');
        if (dishEl)   dishEl.textContent   = 'ğŸ½âœ…';
        this._cookRound++;
        if (this._cookRound >= 5) setTimeout(() => this._cookFinish(), 700);
        else setTimeout(() => this._cookNext(), 800);
      }
    } else {
      // Wrong ingredient
      if (btn) {
        btn.style.background='#ef4444'; btn.style.color='#fff';
        setTimeout(() => { if (btn) { btn.style.background=''; btn.style.color=''; } }, 500);
      }
      this._cookStars.push('âŒ');
      const starsEl = document.getElementById('wg-cook-stars');
      if (starsEl) starsEl.textContent = this._cookStars.join(' ');
      this._cookRound++;
      if (this._cookRound >= 5) setTimeout(() => this._cookFinish(), 700);
      else setTimeout(() => this._cookNext(), 800);
    }
  },

  _cookFinish() {
    const wd = WD[this.worldType];
    this.currency += this._cookEarned;
    this.save();
    const curEl = document.getElementById('wg-cur');
    if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
    const area  = document.getElementById('wg-cook-area');
    const hits  = this._cookStars.filter(s => s === 'â­').length;
    const trophy = hits === 5 ? 'ğŸ†' : hits >= 3 ? 'ğŸ¥‡' : hits >= 1 ? 'ğŸ¥ˆ' : 'ğŸ’ª';
    if (area) area.innerHTML = `
      <div style="text-align:center;padding:20px 0">
        <div style="font-size:2.5rem">${trophy}</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Service done!</div>
        <div style="margin-bottom:8px;font-size:1.2rem">${this._cookStars.join(' ')}</div>
        <div>${hits}/5 dishes served &nbsp;Â·&nbsp; Earned <strong>${this._cookEarned} ${wd.cur}</strong></div>
        <button class="btn btn-primary" style="margin-top:14px;width:100%" onclick="WG._restartCook()">ğŸ”„ New orders</button>
      </div>`;
  },

  _restartCook() {
    const wd  = WD[this.worldType];
    const area = document.getElementById('wg-cook-area');
    if (area) area.innerHTML = `
      <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:8px">
        A customer wants this dish â€” tap all the right ingredients! ğŸ‘¨â€ğŸ³
      </div>
      <div style="background:#0f172a;border-radius:12px;padding:14px;margin-bottom:10px;text-align:center">
        <div id="wg-cook-dish" style="font-size:2rem">ğŸ½</div>
        <div id="wg-cook-name" style="font-weight:800;margin:4px 0">Loadingâ€¦</div>
        <div id="wg-cook-needed" style="font-size:0.85rem;color:#94a3b8;display:flex;gap:6px;justify-content:center;flex-wrap:wrap;margin-top:6px"></div>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:7px;justify-content:center" id="wg-cook-btns"></div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:0.85rem;color:#64748b">
        <span>Order: <strong id="wg-cook-round">1</strong> / 5</span>
        <span>Earned: <strong id="wg-cook-earned">0</strong> ${wd.cur}</span>
      </div>
      <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-cook-stars"></div>`;
    this._startCook();
  },

  _restartCare() {
    const wd = WD[this.worldType];
    const area = document.getElementById('wg-care-area');
    if (area) area.innerHTML = `
      <div style="font-size:0.82rem;color:#94a3b8;text-align:center;margin-bottom:10px">
        Give the animals what they need to earn ${wd.cur}!
      </div>
      <div style="text-align:center;padding:18px;background:#0f172a;border-radius:12px;margin-bottom:12px;min-height:90px">
        <div id="wg-care-animal" style="font-size:3rem">ğŸ¾</div>
        <div id="wg-care-need" style="font-size:1rem;margin-top:6px;color:#e2e8f0">Loadingâ€¦</div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px" id="wg-care-btns">
        <button class="btn btn-secondary" style="font-size:1rem" onclick="WG.careAction('feed')">ğŸ– Feed</button>
        <button class="btn btn-secondary" style="font-size:1rem" onclick="WG.careAction('water')">ğŸ’§ Water</button>
        <button class="btn btn-secondary" style="font-size:1rem" onclick="WG.careAction('wash')">ğŸ› Wash</button>
        <button class="btn btn-secondary" style="font-size:1rem" onclick="WG.careAction('pet')">ğŸ’• Pet</button>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:0.85rem;color:#64748b">
        <span>Round: <strong id="wg-care-round">1</strong> / 6</span>
        <span>Earned: <strong id="wg-care-earned">0</strong> ${wd.cur}</span>
      </div>
      <div style="display:flex;gap:4px;justify-content:center;margin-top:6px;font-size:1.1rem" id="wg-care-stars"></div>`;
    this._startCare();
  },

  // â”€â”€ Safari Zone â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _SF_ANIMALS: [
    {e:'ğŸ¦',n:'Lion'},    {e:'ğŸ˜',n:'Elephant'}, {e:'ğŸ¦’',n:'Giraffe'},
    {e:'ğŸ¦“',n:'Zebra'},   {e:'ğŸ†',n:'Cheetah'},  {e:'ğŸ¦',n:'Rhino'},
    {e:'ğŸŠ',n:'Croc'},    {e:'ğŸ¦',n:'Gorilla'},  {e:'ğŸ¦›',n:'Hippo'},
    {e:'ğŸ†',n:'Leopard'}, {e:'ğŸ¦…',n:'Eagle'},    {e:'ğŸ',n:'Snake'},
  ],
  _sfAnimals: [], _sfSpotted: 0, _sfEarned: 0, _sfRaf: null, _sfLastT: 0,

  _startSafari() {
    if (this._sfRaf) { cancelAnimationFrame(this._sfRaf); this._sfRaf = null; }
    this._sfSpotted = 0;
    this._sfEarned  = 0;
    // Pick 6 random animals, place them at random positions
    const pool = [...this._SF_ANIMALS].sort(() => Math.random() - 0.5).slice(0, 6);
    this._sfAnimals = pool.map(a => ({
      ...a,
      x: 20 + Math.random() * 260,
      y: 20 + Math.random() * 130,
      dx: (Math.random() - 0.5) * 18,  // drift speed px/sec
      dy: (Math.random() - 0.5) * 10,
      spotted: false,
      flash: 0,   // flash timer after tapping
    }));
    this._sfLastT = performance.now();
    const tick = (ts) => {
      if (!document.getElementById('wg-sf-canvas')) { this._sfRaf = null; return; }
      const dt = Math.min((ts - this._sfLastT) / 1000, 0.05);
      this._sfLastT = ts;
      this._sfDraw(dt);
      this._sfRaf = requestAnimationFrame(tick);
    };
    this._sfRaf = requestAnimationFrame(tick);
  },

  _sfDraw(dt) {
    const canvas = document.getElementById('wg-sf-canvas');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const W = 320, H = 180;

    // Savanna background
    ctx.fillStyle = '#d4a843';
    ctx.fillRect(0, 0, W, H);
    // Grass patches
    const patches = [[30,160],[80,150],[140,170],[200,155],[270,165],[310,145]];
    ctx.fillStyle = '#7ec850';
    for (const [px, py] of patches) {
      ctx.beginPath(); ctx.ellipse(px, py, 22, 10, 0, 0, Math.PI*2); ctx.fill();
    }
    // Sky strip at top
    ctx.fillStyle = '#87ceeb';
    ctx.fillRect(0, 0, W, 30);
    // Sun
    ctx.fillStyle = '#fbbf24';
    ctx.beginPath(); ctx.arc(W - 24, 16, 11, 0, Math.PI*2); ctx.fill();
    // Ground line
    ctx.fillStyle = '#c49a2a';
    ctx.fillRect(0, 150, W, 30);

    // Move and draw animals
    for (const a of this._sfAnimals) {
      if (!a.spotted) {
        a.x += a.dx * dt;
        a.y += a.dy * dt;
        if (a.x < 10 || a.x > W - 20) a.dx *= -1;
        if (a.y < 35 || a.y > H - 30) a.dy *= -1;
      }
      if (a.flash > 0) a.flash -= dt;

      // Glow ring when tapped
      if (a.flash > 0) {
        ctx.strokeStyle = '#fbbf24'; ctx.lineWidth = 3;
        ctx.beginPath(); ctx.arc(a.x, a.y, 18, 0, Math.PI*2); ctx.stroke();
      }

      ctx.globalAlpha = a.spotted ? 0.35 : 1;
      ctx.font = '22px serif'; ctx.textAlign = 'center';
      ctx.fillText(a.e, a.x, a.y + 8);
      // Name label
      ctx.font = 'bold 9px sans-serif'; ctx.fillStyle = '#1e293b';
      ctx.fillText(a.n, a.x, a.y + 21);
      ctx.globalAlpha = 1;
      ctx.fillStyle = '#000'; // reset
    }

    // Update HUD
    const countEl  = document.getElementById('wg-sf-count');
    const earnedEl = document.getElementById('wg-sf-earned');
    if (countEl)  countEl.textContent  = this._sfSpotted;
    if (earnedEl) earnedEl.textContent = this._sfEarned;
  },

  safariTap(e) {
    const canvas = document.getElementById('wg-sf-canvas');
    if (!canvas) return;
    const rect = canvas.getBoundingClientRect();
    const scaleX = 320 / rect.width;
    const scaleY = 180 / rect.height;
    const mx = (e.clientX - rect.left) * scaleX;
    const my = (e.clientY - rect.top)  * scaleY;

    for (const a of this._sfAnimals) {
      if (a.spotted) continue;
      const dist = Math.hypot(mx - a.x, my - a.y);
      if (dist < 22) {
        a.spotted = true;
        a.flash   = 0.6;
        this._sfSpotted++;
        const earn = 3;
        this._sfEarned  += earn;
        this.currency   += earn;
        this.save();
        const curEl = document.getElementById('wg-cur');
        if (curEl) curEl.textContent = `${this.currency} ${WD[this.worldType].cur}`;
        // Flash +earn label
        const m = document.createElement('div');
        m.style.cssText = 'position:fixed;top:42%;left:50%;transform:translate(-50%,-50%);background:#22c55e;color:#fff;padding:8px 20px;border-radius:10px;font-weight:800;font-size:1rem;z-index:1000;pointer-events:none';
        m.textContent = `+${earn} ğŸ¾ ${a.n} spotted!`;
        document.body.appendChild(m);
        setTimeout(() => m.remove(), 1200);
        break;
      }
    }
  },

  // â”€â”€ Photo Studio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _startPhotoMeter() {
    this._photoPos = 3;
    this._photoDir = 1;
    this._photoSnaps = 3;
    this._photoEarned = 0;
    this._photoSpeed = 38;
    this._photoLastT = performance.now();
    const tick = (ts) => {
      const dt = Math.min((ts - this._photoLastT) / 1000, 0.05);
      this._photoLastT = ts;
      this._photoPos += this._photoDir * this._photoSpeed * dt;
      if (this._photoPos >= 97) { this._photoPos = 97; this._photoDir = -1; }
      if (this._photoPos <= 3)  { this._photoPos = 3;  this._photoDir =  1; }
      const cursor = document.getElementById('wg-ph-cursor');
      if (!cursor) { this._photoRaf = null; return; }
      cursor.style.left = this._photoPos + '%';
      this._photoRaf = requestAnimationFrame(tick);
    };
    this._photoRaf = requestAnimationFrame(tick);
  },

  snapPhoto() {
    if (this._photoSnaps <= 0) return;
    const dist = Math.abs(this._photoPos - 50);
    const coins = dist < 8 ? 12 : dist < 20 ? 8 : dist < 34 ? 4 : 1;
    const msg   = dist < 8 ? 'â­ Perfect shot!' : dist < 20 ? 'ğŸ‘ Good shot!' : dist < 34 ? 'ğŸ“¸ Got it!' : 'ğŸ˜… Just missed!';
    const col   = dist < 8 ? '#22c55e' : dist < 20 ? '#f59e0b' : '#94a3b8';
    this._photoSnaps--;
    this._photoEarned += coins;
    const wd = WD[this.worldType];
    const snapsEl   = document.getElementById('wg-ph-snaps');
    const btn       = document.getElementById('wg-ph-btn');
    const fbEl      = document.getElementById('wg-ph-fb');
    const earnedEl  = document.getElementById('wg-ph-earned');
    if (snapsEl)  snapsEl.textContent = this._photoSnaps;
    if (fbEl)   { fbEl.textContent = msg; fbEl.style.color = col; }
    if (earnedEl) earnedEl.textContent = this._photoEarned;
    if (this._photoSnaps <= 0) {
      if (this._photoRaf) { cancelAnimationFrame(this._photoRaf); this._photoRaf = null; }
      if (btn) { btn.textContent = 'âœ“ Shoot complete!'; btn.disabled = true; }
      this.currency += this._photoEarned;
      this.save();
      const curEl = document.getElementById('wg-cur');
      if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
      if (fbEl)  fbEl.textContent = `Shoot done! Earned ${this._photoEarned} ${wd.cur} ğŸ‰`;
    }
  },

  // â”€â”€ Banquet â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _BQ_CATS: {
    'Fruits':   ['ğŸ','ğŸŠ','ğŸ‹','ğŸ‡','ğŸ“','ğŸ’','ğŸ‘','ğŸ«'],
    'Veg':      ['ğŸ¥•','ğŸ¥¦','ğŸŒ½','ğŸ¥¬','ğŸ§…','ğŸ«‘','ğŸ„','ğŸ§„'],
    'Proteins': ['ğŸ—','ğŸ¥©','ğŸ³','ğŸŸ','ğŸ¥š','ğŸ§€','ğŸ¥œ','ğŸ«˜'],
    'Desserts': ['ğŸ‚','ğŸ°','ğŸ¦','ğŸ©','ğŸ§','ğŸ­','ğŸª','ğŸ®'],
    'Drinks':   ['ğŸ¥¤','ğŸ§ƒ','â˜•','ğŸµ','ğŸ§‹','ğŸ¥›','ğŸ«–','ğŸ¶'],
  },
  _bqRound: 0, _bqEarned: 0, _bqTarget: '', _bqItems: [],

  _startBanquet() {
    this._bqRound = 0;
    this._bqEarned = 0;
    this._nextBanquetRound();
  },

  _nextBanquetRound() {
    this._bqRound++;
    const wd = WD[this.worldType];
    if (this._bqRound > 3) {
      this.currency += this._bqEarned;
      this.save();
      const curEl = document.getElementById('wg-cur');
      if (curEl) curEl.textContent = `${this.currency} ${wd.cur}`;
      const area = document.getElementById('wg-bq-area');
      if (area) area.innerHTML = `<div style="text-align:center;padding:20px">
        <div style="font-size:2.5rem">ğŸ½ï¸</div>
        <div style="font-size:1.1rem;font-weight:800;margin:8px 0">Feast complete!</div>
        <div>You earned <strong>${this._bqEarned} ${wd.cur}</strong>!</div></div>`;
      return;
    }
    const cats = Object.keys(this._BQ_CATS);
    this._bqTarget = cats[Math.floor(Math.random() * cats.length)];
    const targetItems = [...this._BQ_CATS[this._bqTarget]].sort(() => Math.random()-0.5).slice(0,3)
      .map(e => ({e, cat: this._bqTarget, eaten: false}));
    const otherItems = cats.filter(c => c !== this._bqTarget)
      .flatMap(c => this._BQ_CATS[c].map(e => ({e, cat: c, eaten: false})))
      .sort(() => Math.random()-0.5).slice(0,6);
    this._bqItems = [...targetItems, ...otherItems].sort(() => Math.random()-0.5);
    this._renderBanquetGrid();
  },

  _renderBanquetGrid() {
    const area = document.getElementById('wg-bq-area');
    if (!area) return;
    const wd  = WD[this.worldType];
    const rem = this._bqItems.filter(i => i.cat === this._bqTarget && !i.eaten).length;
    area.innerHTML = `
      <div style="text-align:center;margin-bottom:10px">
        <div style="font-size:0.75rem;color:#64748b;text-transform:uppercase;font-weight:700">
          Round ${this._bqRound}/3 Â· Earned: ${this._bqEarned} ${wd.cur}
        </div>
        <div style="font-size:1rem;font-weight:800;margin:5px 0">
          Tap all the <span style="color:#4ade80">${this._bqTarget}</span>! ğŸ½
        </div>
        <div style="font-size:0.78rem;color:#64748b">${rem} left to eat</div>
      </div>
      <div class="wg-bq-grid">
        ${this._bqItems.map((item,i) => item.eaten
          ? `<div class="wg-bq-item eaten"></div>`
          : `<button class="wg-bq-item" id="wg-bq-${i}" onclick="WG.eatFood(${i})">${item.e}</button>`
        ).join('')}
      </div>
      <div class="wg-bq-msg" id="wg-bq-msg"></div>`;
  },

  eatFood(idx) {
    const item = this._bqItems[idx];
    if (!item || item.eaten) return;
    if (item.cat === this._bqTarget) {
      item.eaten = true;
      this._bqEarned += 3;
      const rem = this._bqItems.filter(i => i.cat === this._bqTarget && !i.eaten).length;
      this._renderBanquetGrid();
      if (rem === 0) setTimeout(() => this._nextBanquetRound(), 650);
    } else {
      const btn = document.getElementById(`wg-bq-${idx}`);
      if (btn) { btn.classList.add('wrong'); setTimeout(() => btn?.classList.remove('wrong'), 380); }
      const msg = document.getElementById('wg-bq-msg');
      if (msg) { msg.textContent = `âŒ That's ${item.cat}! Look for ${this._bqTarget}!`; msg.style.color = '#ef4444'; }
    }
  },

  // â”€â”€ Persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // â”€â”€ Den Organiser â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _denUnplaced() {
    // Items in inventory not yet placed in den
    const placed = this.denLayout.filter(Boolean);
    const inv = [...this.inventory];
    for (const p of placed) {
      const idx = inv.indexOf(p);
      if (idx !== -1) inv.splice(idx, 1);
    }
    return [...new Set(inv)];
  },

  denSelectItem(item) {
    this._denSelectedItem = item;
    // Highlight selected button
    document.querySelectorAll('[id^="den-inv-"]').forEach(b => b.style.outline = '');
    const btn = document.getElementById(`den-inv-${CSS.escape(item)}`);
    if (btn) btn.style.outline = '3px solid #22c55e';
    const label = document.getElementById('den-inv-label');
    if (label) label.textContent = `"${item}" selected â€” tap a spot to place it:`;
  },

  denTapSpot(i) {
    const current = this.denLayout[i];
    if (current) {
      // Clear the spot â€” item goes back to unplaced
      this.denLayout[i] = null;
      this._denSelectedItem = null;
      this.save();
      this._refreshDen();
      return;
    }
    if (!this._denSelectedItem) return;
    // Make sure item is actually in inventory
    if (!this.inventory.includes(this._denSelectedItem)) return;
    // Make sure item isn't already placed elsewhere
    if (this.denLayout.includes(this._denSelectedItem)) return;
    this.denLayout[i] = this._denSelectedItem;
    this._denSelectedItem = null;
    this.save();
    this._refreshDen();
  },

  _refreshDen() {
    // Re-render just the home panel without closing it
    if (this.nearB) this.enterBuilding(this.nearB);
  },

  save() {
    localStorage.setItem('tt_world', JSON.stringify({
      worldType:this.worldType, subjectType:this.subjectType,
      worldDesc:this.worldDesc, specialty:this.specialty,
      avatarName:this.avatarName, av:{...this.av},
      px:this.px, py:this.py, currency:this.currency, inventory:this.inventory,
      denLayout:this.denLayout,
    }));
  },
  load() {
    try {
      const s=JSON.parse(localStorage.getItem('tt_world')||'null');
      if (!s||!s.worldType) return false;
      Object.assign(this, {worldType:s.worldType,subjectType:s.subjectType||'All Subjects',
        worldDesc:s.worldDesc||'',specialty:s.specialty,avatarName:s.avatarName||'Me',
        px:s.px||280,py:s.py||325,currency:s.currency??50,inventory:s.inventory||[],
        denLayout:s.denLayout||Array(9).fill(null)});
      this.av={...this.av,...s.av};
      return true;
    } catch { return false; }
  },
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// SYMBOL MAKER MINI-GAME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isSymbolUnlocked() {
  const lh = levelHist(2);
  if (lh.length < 3) return false;
  return lh.slice(-3).every(h => h.score === 100);
}

function renderSMUnlock() {
  if (isSymbolUnlocked()) {
    return `<div style="margin-top:10px">
      <button class="sm2-unlock" onclick="startSymbolMaker()">
        ğŸ”£ Symbol Maker â€” Play!
      </button>
    </div>`;
  }
  const lh = levelHist(2);
  let streak = 0;
  for (let i = lh.length - 1; i >= 0; i--) {
    if (lh[i].score === 100) streak++; else break;
  }
  return `<div style="margin-top:8px;font-size:0.78rem;color:#475569">
    ğŸ”£ Get 100% three times in a row to unlock Symbol Maker
    ${streak > 0 ? `(${streak}/3 âœ“)` : ''}
  </div>`;
}

function startSymbolMaker() { showView('symbol'); SM.init(); }
function exitSymbolMaker()  { showView('home'); }

const SM = {
  // Drawing
  _drawing: false,
  _tool:    'pen',
  _color:   '#f1f5f9',
  _lw:      4,
  _undoStack: [],

  // Data
  symbols: [],

  // Practice
  pSym:   null,
  pQs:    [],
  pIdx:   0,
  pScore: 0,

  // â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  init() {
    this.symbols = this._loadSyms();
    this.renderCreate();
  },

  handleEnter() {
    const btn = document.querySelector('#sm-content .btn-primary:not([disabled])');
    if (btn) btn.click();
  },

  // â”€â”€ storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _loadSyms() {
    try { return JSON.parse(localStorage.getItem('tt_symbols') || '[]'); }
    catch { return []; }
  },
  _saveSyms() { localStorage.setItem('tt_symbols', JSON.stringify(this.symbols)); },

  // â”€â”€ canvas â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _initCanvas() {
    const c   = document.getElementById('sm-canvas');
    const ctx = c.getContext('2d');
    this._cv  = c;
    this._ctx = ctx;
    this._undoStack = [];
    this._bgFill();

    // Shared position helper
    const pos = (e) => {
      const r  = c.getBoundingClientRect();
      const sx = c.width  / r.width;
      const sy = c.height / r.height;
      const src = e.touches ? e.touches[0] : e;
      return { x: (src.clientX - r.left) * sx, y: (src.clientY - r.top) * sy };
    };

    const down = (e) => {
      e.preventDefault();
      this._pushUndo();
      this._drawing = true;
      const p = pos(e);
      ctx.beginPath();
      ctx.moveTo(p.x, p.y);
    };
    const move = (e) => {
      e.preventDefault();
      if (!this._drawing) return;
      const p = pos(e);
      ctx.strokeStyle = this._tool === 'eraser' ? '#0f172a' : this._color;
      ctx.lineWidth   = this._tool === 'eraser' ? this._lw * 3 : this._lw;
      ctx.lineCap = ctx.lineJoin = 'round';
      ctx.globalCompositeOperation = 'source-over';
      ctx.lineTo(p.x, p.y);
      ctx.stroke();
      this._schedulePreview();
    };
    const up = () => { this._drawing = false; };

    c.addEventListener('mousedown',  down);
    c.addEventListener('mousemove',  move);
    c.addEventListener('mouseup',    up);
    c.addEventListener('mouseleave', up);
    c.addEventListener('touchstart', down, {passive:false});
    c.addEventListener('touchmove',  move, {passive:false});
    c.addEventListener('touchend',   up);
  },

  _bgFill() {
    if (!this._ctx) return;
    this._ctx.fillStyle = '#0f172a';
    this._ctx.fillRect(0, 0, 160, 160);
  },

  _pushUndo() {
    if (!this._cv) return;
    this._undoStack.push(this._cv.toDataURL());
    if (this._undoStack.length > 12) this._undoStack.shift();
  },

  _schedulePreview() {
    if (this._pvTimer) clearTimeout(this._pvTimer);
    this._pvTimer = setTimeout(() => this._doPreview(), 80);
  },

  _doPreview() {
    if (!this._cv) return;
    const name    = (document.getElementById('sm-name')?.value || '').trim() || '?';
    const formula = document.getElementById('sm-formula')?.value || '';
    const ans     = this.evalFormula(formula, 10, 2);
    const prev    = document.getElementById('sm-preview');
    if (!prev) return;
    const src = this._cv.toDataURL();
    prev.innerHTML = ans !== null
      ? `<span>10</span>
         <img src="${src}" style="height:30px;vertical-align:middle;border-radius:4px">
         <span>2 = <strong style="color:#4ade80">${ans}</strong></span>`
      : `<span style="color:#475569">${formula ? 'âš  Rule not valid yetâ€¦' : 'Preview appears as you typeâ€¦'}</span>`;
  },

  // â”€â”€ tools â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setColor(c) {
    this._color = c;
    this._tool  = 'pen';
    document.querySelectorAll('.sm-color-btn').forEach(b =>
      b.classList.toggle('active', b.dataset.color === c));
    document.getElementById('sm-erase-btn')?.classList.remove('active');
  },

  setSize(w) {
    this._lw = w;
    document.querySelectorAll('.sm-size-btn').forEach((b, i) =>
      b.classList.toggle('active', [2, 4, 8][i] === w));
  },

  toggleEraser() {
    this._tool = this._tool === 'eraser' ? 'pen' : 'eraser';
    document.getElementById('sm-erase-btn')?.classList.toggle('active', this._tool === 'eraser');
  },

  undoLast() {
    if (!this._undoStack.length) return;
    const url = this._undoStack.pop();
    const img = new Image();
    img.onload = () => {
      this._ctx.clearRect(0, 0, 160, 160);
      this._ctx.drawImage(img, 0, 0);
      this._schedulePreview();
    };
    img.src = url;
  },

  clearDraw() {
    this._pushUndo();
    this._bgFill();
    this._schedulePreview();
  },

  // â”€â”€ rule builder helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setRule(formula) {
    const input = document.getElementById('sm-formula');
    if (input) { input.value = formula; this._schedulePreview(); }
    // highlight chosen chip
    document.querySelectorAll('.sm-chip').forEach(c => {
      c.classList.toggle('active', c.title === formula);
    });
  },

  _buildFormula(apply = false) {
    const op1   = document.getElementById('smb-op1')?.value || '*';
    const extra = document.getElementById('smb-extra')?.value || '';
    const numEl = document.getElementById('smb-num');
    // show/hide number input
    if (numEl) numEl.style.display = extra.includes('n') ? 'inline-block' : 'none';
    const num   = numEl?.value || '1';

    let formula = `a ${op1} b`;
    if (extra) {
      const part = extra.replace('n', num);
      formula = `(${formula}) ${part}`;
    }
    if (apply) this.setRule(formula);
  },

  // â”€â”€ formula eval â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  evalFormula(formula, a, b) {
    if (!formula?.trim()) return null;
    try {
      let expr = formula.replace(/\^/g, '**');
      if (!/^[\d\s+\-*/().ab]+$/i.test(expr)) return null;
      const r = new Function('a','b', `"use strict"; return +(${expr});`)(+a, +b);
      if (!isFinite(r) || isNaN(r)) return null;
      return +r.toFixed(4);
    } catch { return null; }
  },

  // â”€â”€ save symbol â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  saveSymbol() {
    const name = document.getElementById('sm-name')?.value.trim();
    const formula = document.getElementById('sm-formula')?.value.trim();
    const desc  = document.getElementById('sm-desc')?.value.trim() || '';

    if (!name)    { alert('Please give your symbol a name!'); return; }
    if (!formula) { alert('Please write a rule using a and b!'); return; }

    const test = this.evalFormula(formula, 3, 4);
    if (test === null) {
      alert('The rule doesn\'t seem to work.\nUse a for left number, b for right.\nExample: a * b + a');
      return;
    }
    const sampleQs = this._genQs({formula}, 5);
    if (sampleQs.length < 3) {
      alert('The rule needs to work with numbers 2â€“10 and give whole-number answers.\nTry a simpler formula!');
      return;
    }

    const sym = {
      id: Date.now(),
      name, formula, desc,
      drawing: this._cv.toDataURL(),
    };
    this.symbols.push(sym);
    this._saveSyms();
    this.renderLibrary(`âœ“ "${name}" saved!`);
  },

  // â”€â”€ practice questions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _genQs(sym, count = 8) {
    const qs = [];
    const used = new Set();
    let att = 0;
    while (qs.length < count && att < 400) {
      att++;
      const a = Math.floor(Math.random() * 9) + 2;
      const b = Math.floor(Math.random() * 9) + 2;
      const k = `${a},${b}`;
      if (used.has(k)) continue;
      const ans = this.evalFormula(sym.formula, a, b);
      if (ans === null || !Number.isInteger(ans) || ans < 0 || ans > 999) continue;
      used.add(k);
      qs.push({a, b, ans});
    }
    return qs;
  },

  // â”€â”€ delete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deleteSymbol(id) {
    if (!confirm('Delete this symbol?')) return;
    this.symbols = this.symbols.filter(s => s.id !== id);
    this._saveSyms();
    this.renderLibrary();
  },

  // â•â• RENDER: CREATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  renderCreate() {
    const COLORS = ['#f1f5f9','#f97316','#22c55e','#3b82f6','#a855f7','#ef4444','#fbbf24'];
    document.getElementById('sm-content').innerHTML = `
      <div>
        <div class="sm-create-top">

          <!-- Left: canvas + tools -->
          <div class="sm-left">
            <div class="sm-field-label">Draw Your Symbol</div>
            <canvas id="sm-canvas" width="160" height="160"></canvas>
            <div class="sm-tools">
              <div class="sm-colors">
                ${COLORS.map((c,i) =>
                  `<button class="sm-color-btn${i===0?' active':''}" style="background:${c}"
                     data-color="${c}" onclick="SM.setColor('${c}')" title="${c}"></button>`
                ).join('')}
              </div>
            </div>
            <div class="sm-tools">
              <button class="sm-size-btn" onclick="SM.setSize(2)" title="Thin">â€”</button>
              <button class="sm-size-btn active" onclick="SM.setSize(4)" title="Medium">â”</button>
              <button class="sm-size-btn" onclick="SM.setSize(8)" title="Thick">â–¬</button>
              <button class="sm-tool-btn" id="sm-erase-btn" onclick="SM.toggleEraser()">âŒ« Erase</button>
              <button class="sm-tool-btn" onclick="SM.undoLast()">â†©</button>
              <button class="sm-tool-btn" onclick="SM.clearDraw()">Clear</button>
            </div>
          </div>

          <!-- Right: fields -->
          <div class="sm-right">
            <div class="sm-field">
              <label class="sm-field-label">Symbol Name</label>
              <input type="text" id="sm-name" class="sm-input" placeholder="e.g. Ziggy, Star, Bolt"
                maxlength="20" oninput="SM._schedulePreview()">
            </div>
            <div class="sm-field">
              <label class="sm-field-label">The Rule</label>
              <div class="sm-rule-section">
                <!-- Quick picks -->
                <div>
                  <div class="sm-quick-label">Quick picks</div>
                  <div class="sm-quick-chips">
                    ${[
                      ['a + b',        'Add'],
                      ['a - b',        'Subtract'],
                      ['a * b',        'Multiply'],
                      ['a * b + a',    'Multiply + left'],
                      ['a * b + b',    'Multiply + right'],
                      ['a * a + b',    'Left squared + right'],
                      ['(a + b) * 2',  'Double sum'],
                      ['a * b - 1',    'Multiply âˆ’ 1'],
                    ].map(([f,label]) =>
                      `<button class="sm-chip" title="${f}" onclick="SM.setRule('${f}')">${label}</button>`
                    ).join('')}
                  </div>
                </div>
                <!-- Dropdown builder -->
                <div>
                  <div class="sm-quick-label">Build your own</div>
                  <div class="sm-builder-row">
                    <span class="sm-builder-token">a</span>
                    <select class="sm-builder-select" id="smb-op1" onchange="SM._buildFormula()">
                      <option>+</option><option>-</option><option>*</option>
                    </select>
                    <span class="sm-builder-token">b</span>
                    <select class="sm-builder-select" id="smb-extra" onchange="SM._buildFormula()">
                      <option value="">â€” then â€”</option>
                      <option value="+ n">+ number</option>
                      <option value="- n">âˆ’ number</option>
                      <option value="* n">Ã— number</option>
                      <option value="+ a">+ left</option>
                      <option value="- a">âˆ’ left</option>
                      <option value="+ b">+ right</option>
                      <option value="- b">âˆ’ right</option>
                    </select>
                    <input type="number" class="sm-builder-num" id="smb-num"
                      value="1" min="1" max="99" oninput="SM._buildFormula()"
                      style="display:none">
                    <button class="sm-build-btn" onclick="SM._buildFormula(true)">â†’ Use this</button>
                  </div>
                </div>
                <!-- Manual input -->
                <div class="sm-divider">â€” or type your own â€”</div>
                <input type="text" id="sm-formula" class="sm-input sm-mono"
                  placeholder="e.g.  a * b + a" oninput="SM._schedulePreview()">
                <div class="sm-examples">
                  Use <code>a</code> (left number) and <code>b</code> (right number). Operators: <code>+ - * / ^</code>
                </div>
              </div>
            </div>
            <div class="sm-field">
              <label class="sm-field-label">
                Describe it
                <span style="color:#475569;font-weight:400;text-transform:none;letter-spacing:0">
                  â€” explain in plain words
                </span>
              </label>
              <textarea id="sm-desc" class="sm-input sm-textarea"
                placeholder="e.g. Multiply the numbers together, then add the left number"></textarea>
            </div>
            <div>
              <div class="sm-field-label" style="margin-bottom:6px">Live Preview</div>
              <div class="sm-preview-box" id="sm-preview">
                <span style="color:#475569">Type a rule to see the previewâ€¦</span>
              </div>
            </div>
          </div>

        </div>
        <div class="sm-actions">
          <button class="btn btn-primary btn-lg" onclick="SM.saveSymbol()">ğŸ’¾ Save Symbol</button>
          <button class="btn btn-secondary" onclick="SM.renderLibrary()">ğŸ“š My Symbols (${this.symbols.length})</button>
        </div>
      </div>`;
    this._initCanvas();
  },

  // â•â• RENDER: LIBRARY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  renderLibrary(flash = '') {
    const syms = this.symbols;
    const grid = syms.length
      ? `<div class="sm-lib-grid">${syms.map(s => `
          <div class="sm-lib-card">
            <img src="${s.drawing}" class="sm-lib-img" alt="${s.name}">
            <div class="sm-lib-name">${s.name}</div>
            <div class="sm-lib-formula"><code>${s.formula}</code></div>
            ${s.desc ? `<div class="sm-lib-desc">${s.desc}</div>` : ''}
            <div class="sm-lib-actions">
              <button class="btn btn-primary btn-sm" onclick="SM.startPractice(${s.id})">â–¶ Practice</button>
              <button class="btn btn-sm" style="background:#431407;color:#fca5a5"
                onclick="SM.deleteSymbol(${s.id})">âœ•</button>
            </div>
          </div>`).join('')}
        </div>`
      : `<div class="empty-state"><div class="es-icon">ğŸ”£</div>
           <div>No symbols yet â€” create one!</div></div>`;

    document.getElementById('sm-content').innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px">
        <h2 style="font-size:1.15rem;font-weight:800">ğŸ“š My Symbols</h2>
        <button class="btn btn-primary" onclick="SM.renderCreate()">âœ Create New</button>
      </div>
      ${flash ? `<div style="color:#4ade80;font-size:0.9rem;font-weight:700;margin-bottom:12px">${flash}</div>` : ''}
      ${grid}`;
  },

  // â•â• PRACTICE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  startPractice(id) {
    const sym = this.symbols.find(s => s.id === id);
    if (!sym) return;
    this.pSym   = sym;
    this.pQs    = this._genQs(sym, 8);
    this.pIdx   = 0;
    this.pScore = 0;
    this._renderPracticeQ();
  },

  _renderPracticeQ() {
    if (this.pIdx >= this.pQs.length) { this._renderPracticeEnd(); return; }
    const sym   = this.pSym;
    const q     = this.pQs[this.pIdx];
    const total = this.pQs.length;

    document.getElementById('sm-content').innerHTML = `
      <div style="max-width:560px;margin:0 auto;padding-top:8px">
        <div class="sm-practice-header">
          <span>Question ${this.pIdx + 1} / ${total}</span>
          <span style="color:#94a3b8">${sym.name}</span>
          <span>âœ“ ${this.pScore} / ${this.pIdx}</span>
        </div>
        <div class="sm-practice-q">
          <span class="sm-q-num">${q.a}</span>
          <img src="${sym.drawing}" class="sm-q-sym" alt="${sym.name}">
          <span class="sm-q-num">${q.b}</span>
          <span class="sm-q-num" style="color:#64748b">=</span>
          <span class="sm-q-num" style="color:#64748b">?</span>
        </div>
        <div class="sm-practice-rule">
          Rule: <code>${sym.formula}</code>
          ${sym.desc ? `&nbsp;Â·&nbsp; ${sym.desc}` : ''}
        </div>
        <div class="ans-area" style="margin-top:24px">
          <input id="sm-ans" type="number" class="ans-input" placeholder="?"
            autocomplete="off" inputmode="numeric" style="max-width:200px">
          <div id="sm-fb" class="fb-text"></div>
          <button class="btn btn-primary btn-lg" onclick="SM._checkAns()">Check</button>
          <button class="btn btn-secondary btn-sm" onclick="SM.renderLibrary()">âœ• Stop</button>
        </div>
      </div>`;
    setTimeout(() => document.getElementById('sm-ans')?.focus(), 50);
  },

  _checkAns() {
    const inp = document.getElementById('sm-ans');
    const val = parseInt(inp?.value);
    if (!inp || isNaN(val)) { inp?.focus(); return; }
    inp.disabled = true;
    document.querySelector('#sm-content .btn-primary').disabled = true;

    const q  = this.pQs[this.pIdx];
    const ok = val === q.ans;
    if (ok) this.pScore++;

    const fb = document.getElementById('sm-fb');
    fb.className   = 'fb-text ' + (ok ? 'ok' : 'bad');
    fb.textContent = ok
      ? `âœ“ Correct! ${q.a} ${this.pSym.name} ${q.b} = ${q.ans}`
      : `âœ— The answer is ${q.ans}   (${this.pSym.formula.replace('a', q.a).replace('b', q.b)} = ${q.ans})`;

    setTimeout(() => { this.pIdx++; this._renderPracticeQ(); }, 1400);
  },

  _renderPracticeEnd() {
    const total = this.pQs.length;
    const pct   = Math.round(this.pScore / total * 100);
    const emoji = pct >= 90 ? 'ğŸŒŸ' : pct >= 70 ? 'ğŸ˜Š' : 'ğŸ’ª';
    const msg   = pct >= 90 ? 'You really know this symbol!'
                : pct >= 70 ? 'Great work!' : 'Keep practising!';
    document.getElementById('sm-content').innerHTML = `
      <div style="text-align:center;padding:40px 20px">
        <div style="font-size:3rem;margin-bottom:8px">${emoji}</div>
        <div style="font-size:4rem;font-weight:900;color:${pct>=90?'#22c55e':pct>=70?'#60a5fa':'#f97316'}">${pct}%</div>
        <div style="font-size:1.1rem;color:#94a3b8;margin:8px 0">${msg}</div>
        <div style="font-size:0.9rem;color:#475569;margin-bottom:28px">
          ${this.pScore} correct out of ${total}
        </div>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
          <button class="btn btn-primary btn-lg" onclick="SM.startPractice(${this.pSym.id})">â–¶ Play Again</button>
          <button class="btn btn-secondary btn-lg" onclick="SM.renderLibrary()">ğŸ“š My Symbols</button>
          <button class="btn btn-secondary" onclick="exitSymbolMaker()">ğŸ  Home</button>
        </div>
      </div>`;
  },
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// BASKETBALL MINI-GAME
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function isBasketballUnlocked() {
  const lh = levelHist(1);
  if (lh.length < 3) return false;
  return lh.slice(-3).every(h => h.score === 100);
}

function renderBkUnlock() {
  if (isBasketballUnlocked()) {
    return `<div style="margin-top:10px">
      <button class="bk-unlock" onclick="startBasketball()">
        ğŸ€ Basketball Bonus â€” Play!
      </button>
    </div>`;
  }
  const lh = levelHist(1);
  const streak = (() => {
    let s = 0;
    for (let i = lh.length - 1; i >= 0; i--) {
      if (lh[i].score === 100) s++; else break;
    }
    return s;
  })();
  return `<div style="margin-top:8px;font-size:0.78rem;color:#475569">
    ğŸ€ Get 100% three times in a row to unlock Basketball Bonus
    ${streak > 0 ? `(${streak}/3 âœ“)` : ''}
  </div>`;
}

function startBasketball() {
  showView('basketball');
  BK.init();
}

function exitBasketball() {
  BK.stop();
  showView('home');
}

// Court layout constants (logical 700Ã—400 space)
const BK = {
  // Geometry
  W: 700, H: 400,
  FLOOR_Y:   330,
  PLAYER_X:  100,
  HOOP_X:    574,
  HOOP_Y:    188,
  RIM_R:     28,
  BOARD_X:   618,
  BOARD_TOP: 128,
  // computed hand position (updated each draw)
  handX: 132, handY: 252,

  // Physics
  GRAVITY:   480,  // px/sÂ² â€” lower = more floaty, more of the power bar is usable
  MAX_SPEED: 820,  // px/s at 100% power (see launch() for actual mapping)

  // Game state
  state:      'AIMING',
  angle:      48,   // degrees from horizontal
  power:      0,
  powerDir:   1,
  powerSpeed: 72,   // % per second

  throwNum:   0,
  totalThrows:5,
  scored:     0,

  // Ball
  ballX: 0, ballY: 0,
  velX:  0, velY:  0,
  ballR: 12,
  spin:  0,
  didScore: false,

  // Timing
  raf:         null,
  lastTime:    0,
  resultTimer: 0,

  // Appearance
  gender: 'boy',

  init() {
    this.canvas = document.getElementById('bk-canvas');
    this.ctx    = this.canvas.getContext('2d');
    this.gender = localStorage.getItem('tt_bk_gender') || 'boy';
    this.totalThrows = cfg.bkThrows;
    this.throwNum = 0;
    this.scored   = 0;
    this.updateGenderBtn();
    this.resize();
    this.newThrow();
    if (this.raf) cancelAnimationFrame(this.raf);
    this.lastTime = 0;
    this.raf = requestAnimationFrame(t => this.loop(t));
  },

  stop() {
    if (this.raf) { cancelAnimationFrame(this.raf); this.raf = null; }
  },

  resize() {
    const maxW = Math.min(700, window.innerWidth - 32);
    this.canvas.style.width  = maxW + 'px';
    this.canvas.style.height = Math.round(400 * maxW / 700) + 'px';
  },

  toggleGender() {
    this.gender = this.gender === 'boy' ? 'girl' : 'boy';
    localStorage.setItem('tt_bk_gender', this.gender);
    this.updateGenderBtn();
  },

  updateGenderBtn() {
    const b = document.getElementById('bk-gender-btn');
    if (b) b.textContent = this.gender === 'boy' ? 'ğŸ‘¦ Boy' : 'ğŸ‘§ Girl';
  },

  newThrow() {
    this.throwNum++;
    this.state    = 'AIMING';
    this.power    = 0;
    this.powerDir = 1;
    this.didScore = false;
    this.ballX    = this.handX;
    this.ballY    = this.handY;
    document.getElementById('bk-counter').textContent =
      `Throw ${this.throwNum} / ${this.totalThrows}`;
    document.getElementById('bk-score').textContent =
      `ğŸ€ ${this.scored} scored`;
    document.getElementById('bk-power-wrap').classList.add('hidden');
    this.setMsg(`<span class="bk-key">â†‘</span><span class="bk-key">â†“</span> to aim,
      then <span class="bk-key">Enter</span> to set power`);
  },

  setMsg(html) {
    document.getElementById('bk-msg').innerHTML = html;
  },

  handleKey(key) {
    if (this.state === 'AIMING') {
      if (key === 'ArrowUp')   this.angle = Math.min(78, this.angle + 3);
      if (key === 'ArrowDown') this.angle = Math.max(12, this.angle - 3);
      if (key === 'Enter') {
        this.state    = 'POWER';
        this.power    = 0;
        this.powerDir = 1;
        document.getElementById('bk-power-wrap').classList.remove('hidden');
        this.setMsg(`Watch the power bar â€” press <span class="bk-key">Enter</span> to throw!`);
      }
    } else if (this.state === 'POWER') {
      if (key === 'Enter') this.launch();
    }
  },

  launch() {
    this.state = 'FLYING';
    document.getElementById('bk-power-wrap').classList.add('hidden');
    this.setMsg('');
    const rad  = this.angle * Math.PI / 180;
    // Base speed of 260 ensures even 0% does something visible;
    // the range of 520 spreads the sweet spot across ~35-80% of the bar.
    const spd  = 260 + (this.power / 100) * 520;
    this.ballX = this.handX;
    this.ballY = this.handY;
    this.velX  = spd * Math.cos(rad);
    this.velY  = -spd * Math.sin(rad);
    this.spin  = 0;
    this.didScore = false;
  },

  checkScore() {
    // Ball must be descending and pass through the hoop opening
    const clearance = this.RIM_R - this.ballR - 2;
    return this.velY > 0
      && Math.abs(this.ballX - this.HOOP_X) < clearance
      && Math.abs(this.ballY - this.HOOP_Y) < 18;
  },

  loop(ts) {
    this.raf = requestAnimationFrame(t => this.loop(t));
    const dt = Math.min((ts - (this.lastTime || ts)) / 1000, 0.05);
    this.lastTime = ts;

    // Update power oscillation
    if (this.state === 'POWER') {
      this.power += this.powerDir * this.powerSpeed * dt;
      if (this.power >= 100) { this.power = 100; this.powerDir = -1; }
      if (this.power <= 0)   { this.power = 0;   this.powerDir =  1; }
      document.getElementById('bk-power-fill').style.width = this.power + '%';
    }

    // Update ball physics
    if (this.state === 'FLYING') {
      this.velY  += this.GRAVITY * dt;
      this.ballX += this.velX * dt;
      this.ballY += this.velY * dt;
      this.spin  += 12 * dt;

      if (!this.didScore && this.checkScore()) {
        this.didScore = true;
        this.scored++;
        document.getElementById('bk-score').textContent = `ğŸ€ ${this.scored} scored`;
        this.setMsg('ğŸ‰ SCORE! Amazing shot!');
      }

      // Hit floor or fly off
      const offscreen = this.ballX > this.W + 60 || this.ballX < -60
                     || this.ballY > this.H + 60;
      if (this.ballY >= this.FLOOR_Y - this.ballR || offscreen) {
        if (!offscreen) this.ballY = this.FLOOR_Y - this.ballR;
        this.state = 'RESULT';
        this.resultTimer = this.didScore ? 1.8 : 1.4;
        if (!this.didScore) this.setMsg('ğŸ˜… Miss! Try againâ€¦');
        document.getElementById('bk-counter').textContent =
          `Throw ${this.throwNum} / ${this.totalThrows}`;
      }
    }

    // Result pause
    if (this.state === 'RESULT') {
      this.resultTimer -= dt;
      if (this.resultTimer <= 0) {
        if (this.throwNum >= this.totalThrows) {
          this.state = 'DONE';
          this.showFinal();
        } else {
          this.newThrow();
        }
      }
    }

    this.draw();
  },

  draw() {
    const ctx = this.ctx;
    const s   = this.canvas.clientWidth / this.W;
    ctx.save();
    ctx.setTransform(s, 0, 0, s, 0, 0);

    // Background
    const bg = ctx.createLinearGradient(0, 0, 0, this.FLOOR_Y);
    bg.addColorStop(0, '#0a0a1a');
    bg.addColorStop(1, '#111827');
    ctx.fillStyle = bg;
    ctx.fillRect(0, 0, this.W, this.H);

    // Floor
    const fl = ctx.createLinearGradient(0, this.FLOOR_Y, 0, this.H);
    fl.addColorStop(0, '#b45309');
    fl.addColorStop(1, '#92400e');
    ctx.fillStyle = fl;
    ctx.fillRect(0, this.FLOOR_Y, this.W, this.H - this.FLOOR_Y);

    // Floor shine line
    ctx.strokeStyle = '#d97706';
    ctx.lineWidth = 2;
    ctx.setLineDash([]);
    ctx.beginPath();
    ctx.moveTo(0, this.FLOOR_Y + 1);
    ctx.lineTo(this.W, this.FLOOR_Y + 1);
    ctx.stroke();

    // Floor board lines
    ctx.strokeStyle = 'rgba(0,0,0,0.15)';
    ctx.lineWidth = 1;
    for (let y = this.FLOOR_Y + 30; y < this.H; y += 22) {
      ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(this.W, y); ctx.stroke();
    }

    // Court key outline
    ctx.strokeStyle = 'rgba(255,255,255,0.12)';
    ctx.lineWidth = 2;
    ctx.strokeRect(0, this.FLOOR_Y - 1, this.HOOP_X - 60, 60);

    // Hoop + backboard
    this.drawHoop(ctx);

    // Aim line while aiming
    if (this.state === 'AIMING' || this.state === 'POWER') {
      this.drawAimLine(ctx);
    }

    // Player (also sets this.handX/Y)
    this.drawPlayer(ctx);

    // Ball
    const showBall = this.state === 'FLYING'
      || this.state === 'RESULT'
      || this.state === 'DONE';
    if (showBall) {
      this.drawBall(ctx, this.ballX, this.ballY);
    } else {
      this.drawBall(ctx, this.handX + 4, this.handY - 2);
    }

    ctx.restore();
  },

  drawHoop(ctx) {
    const hx = this.HOOP_X, hy = this.HOOP_Y;
    const bx = this.BOARD_X, bt = this.BOARD_TOP;
    const r  = this.RIM_R;

    // Pole
    const pg = ctx.createLinearGradient(bx + 26, 0, bx + 34, 0);
    pg.addColorStop(0, '#666'); pg.addColorStop(1, '#444');
    ctx.fillStyle = pg;
    ctx.fillRect(bx + 26, hy + 14, 8, this.FLOOR_Y - hy - 14);

    // Backboard shadow
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.fillRect(bx + 4, bt + 4, 58, 80);

    // Backboard
    ctx.fillStyle = '#dde';
    ctx.fillRect(bx, bt, 58, 80);
    ctx.strokeStyle = '#aab'; ctx.lineWidth = 2;
    ctx.strokeRect(bx, bt, 58, 80);

    // Inner square
    ctx.strokeStyle = '#f97316'; ctx.lineWidth = 3;
    ctx.strokeRect(bx + 14, bt + 20, 30, 24);

    // Arm connecting board to rim
    ctx.fillStyle = '#888';
    ctx.fillRect(hx, hy - 3, bx - hx, 6);

    // Rim shadow
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.beginPath();
    ctx.ellipse(hx + 2, hy + 3, r, r * 0.28, 0, 0, Math.PI * 2);
    ctx.fill();

    // Rim back edge
    ctx.strokeStyle = '#c05000'; ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.ellipse(hx, hy, r, r * 0.28, 0, Math.PI, Math.PI * 2);
    ctx.stroke();

    // Net
    const netH = 52;
    ctx.strokeStyle = 'rgba(240,240,240,0.65)';
    for (let i = 0; i <= 7; i++) {
      const t  = i / 7;
      const x1 = hx - r + 2 * r * t;
      const x2 = hx - r * 0.35 + r * 0.7 * t;
      ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(x1, hy); ctx.lineTo(x2, hy + netH); ctx.stroke();
    }
    for (let i = 1; i <= 4; i++) {
      const t  = i / 5;
      const x1 = hx - r * (1 - t * 0.65);
      const x2 = hx + r * (1 - t * 0.65);
      const y  = hy + netH * t;
      ctx.beginPath(); ctx.moveTo(x1, y); ctx.lineTo(x2, y); ctx.stroke();
    }

    // Rim front edge (drawn last so it's on top of net)
    ctx.strokeStyle = '#f97316'; ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.ellipse(hx, hy, r, r * 0.28, 0, 0, Math.PI);
    ctx.stroke();
  },

  drawAimLine(ctx) {
    const rad = this.angle * Math.PI / 180;
    const len = 90;
    const ex  = this.handX + Math.cos(rad) * len;
    const ey  = this.handY - Math.sin(rad) * len;

    ctx.setLineDash([7, 7]);
    ctx.strokeStyle = 'rgba(255,255,255,0.45)';
    ctx.lineWidth   = 2;
    ctx.beginPath();
    ctx.moveTo(this.handX, this.handY);
    ctx.lineTo(ex, ey);
    ctx.stroke();
    ctx.setLineDash([]);

    // Arrow tip
    ctx.save();
    ctx.translate(ex, ey);
    ctx.rotate(-rad);
    ctx.fillStyle = 'rgba(255,255,255,0.45)';
    ctx.beginPath();
    ctx.moveTo(9, 0); ctx.lineTo(-5, 5); ctx.lineTo(-5, -5);
    ctx.closePath(); ctx.fill();
    ctx.restore();
  },

  drawPlayer(ctx) {
    const px  = this.PLAYER_X;
    const py  = this.FLOOR_Y;
    const boy = this.gender === 'boy';

    const skin   = '#f5c5a3';
    const shirt  = boy ? '#3b82f6' : '#ec4899';
    const pants  = boy ? '#1e3a5f' : '#6d28d9';
    const hair   = boy ? '#2d1b00' : '#92400e';
    const shoe   = '#111';

    // Shoes
    ctx.fillStyle = shoe;
    [[px - 8, py], [px + 8, py]].forEach(([x, y]) => {
      ctx.beginPath(); ctx.ellipse(x, y, 11, 5, 0, 0, Math.PI * 2); ctx.fill();
    });

    // Legs
    ctx.strokeStyle = pants; ctx.lineWidth = 10; ctx.lineCap = 'round';
    [[px - 8, py - 4], [px + 8, py - 4]].forEach(([x, y]) => {
      ctx.beginPath(); ctx.moveTo(px, py - 36); ctx.lineTo(x, y); ctx.stroke();
    });

    // Body
    ctx.fillStyle = shirt;
    ctx.beginPath(); ctx.roundRect(px - 15, py - 76, 30, 40, 5); ctx.fill();

    // Left arm (hanging down)
    ctx.strokeStyle = shirt; ctx.lineWidth = 9;
    ctx.beginPath();
    ctx.moveTo(px - 13, py - 68);
    ctx.quadraticCurveTo(px - 24, py - 52, px - 22, py - 42);
    ctx.stroke();
    ctx.fillStyle = skin;
    ctx.beginPath(); ctx.arc(px - 22, py - 40, 6, 0, Math.PI * 2); ctx.fill();

    // Right arm â€” angle-dependent, holds ball
    const rad    = this.angle * Math.PI / 180;
    const armLen = 28;
    const ax     = px + 13 + Math.cos(rad) * armLen;
    const ay     = (py - 68) - Math.sin(rad) * armLen;
    ctx.strokeStyle = shirt; ctx.lineWidth = 9;
    ctx.beginPath(); ctx.moveTo(px + 13, py - 68); ctx.lineTo(ax, ay); ctx.stroke();
    ctx.fillStyle = skin;
    ctx.beginPath(); ctx.arc(ax, ay, 6, 0, Math.PI * 2); ctx.fill();

    // Store hand position for ball
    this.handX = ax;
    this.handY = ay;

    // Head
    ctx.fillStyle = skin;
    ctx.beginPath(); ctx.arc(px, py - 92, 19, 0, Math.PI * 2); ctx.fill();

    // Hair
    ctx.fillStyle = hair;
    if (boy) {
      ctx.beginPath();
      ctx.arc(px, py - 92, 19, Math.PI * 1.12, Math.PI * 1.88, false);
      ctx.lineTo(px, py - 92); ctx.closePath(); ctx.fill();
    } else {
      // Long top hair
      ctx.beginPath();
      ctx.arc(px, py - 92, 19, Math.PI * 1.02, Math.PI * 1.98, false);
      ctx.lineTo(px, py - 92); ctx.closePath(); ctx.fill();
      // Ponytail
      ctx.strokeStyle = hair; ctx.lineWidth = 7; ctx.lineCap = 'round';
      ctx.beginPath();
      ctx.moveTo(px + 17, py - 86);
      ctx.quadraticCurveTo(px + 34, py - 72, px + 24, py - 56);
      ctx.stroke();
    }

    // Eyes
    ctx.fillStyle = '#222';
    [[-7, -93], [7, -93]].forEach(([dx, dy]) => {
      ctx.beginPath(); ctx.arc(px + dx, py + dy, 2.5, 0, Math.PI * 2); ctx.fill();
    });

    // Smile
    ctx.strokeStyle = '#333'; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(px, py - 87, 6, 0.1, Math.PI - 0.1); ctx.stroke();
  },

  drawBall(ctx, x, y) {
    const r = this.ballR;
    // Shadow on floor
    if (y < this.FLOOR_Y) {
      const dist = (this.FLOOR_Y - y) / this.FLOOR_Y;
      ctx.fillStyle = `rgba(0,0,0,${0.25 * (1 - dist * 0.7)})`;
      ctx.beginPath();
      ctx.ellipse(x, this.FLOOR_Y - 1, r * (1 - dist * 0.5), 4, 0, 0, Math.PI * 2);
      ctx.fill();
    }

    // Ball
    const g = ctx.createRadialGradient(x - r * 0.35, y - r * 0.35, 1, x, y, r);
    g.addColorStop(0, '#ff9a20'); g.addColorStop(1, '#b84500');
    ctx.fillStyle = g;
    ctx.beginPath(); ctx.arc(x, y, r, 0, Math.PI * 2); ctx.fill();

    // Seams
    ctx.save(); ctx.translate(x, y); ctx.rotate(this.spin);
    ctx.strokeStyle = 'rgba(0,0,0,0.5)'; ctx.lineWidth = 1.5;
    // Horizontal seam
    ctx.beginPath(); ctx.arc(0, 0, r, 0, Math.PI); ctx.stroke();
    ctx.beginPath(); ctx.arc(0, 0, r, Math.PI, Math.PI * 2); ctx.stroke();
    // Curved vertical seams
    ctx.beginPath();
    ctx.moveTo(0, -r);
    ctx.bezierCurveTo(r * 0.6, -r * 0.5, r * 0.6, r * 0.5, 0, r);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(0, -r);
    ctx.bezierCurveTo(-r * 0.6, -r * 0.5, -r * 0.6, r * 0.5, 0, r);
    ctx.stroke();
    ctx.restore();
  },

  showFinal() {
    const pct = Math.round(this.scored / this.totalThrows * 100);
    const msg = pct >= 80 ? 'ğŸ† Incredible!' : pct >= 60 ? 'ğŸ”¥ Great shooting!'
              : pct >= 40 ? 'ğŸ‘ Not bad!' : 'ğŸ’ª Keep practising!';
    document.getElementById('bk-msg').innerHTML = `
      <div style="text-align:center">
        <div style="font-size:1.2rem;font-weight:800;color:#f59e0b;margin-bottom:8px">
          ${msg} ${this.scored}/${this.totalThrows} scored (${pct}%)
        </div>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="BK.init()">â–¶ Play Again</button>
          <button class="btn btn-secondary" onclick="exitBasketball()">ğŸ  Home</button>
        </div>
      </div>`;
  },
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
showView('home');
</script>
</body>
</html>
